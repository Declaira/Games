<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß≠ Quiz G√©ographie</title>
<link rel="icon" href="../logo.png" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet">
<style>
/* --- RESET GLOBAL --- */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
    font-family: 'Quicksand', sans-serif;
    background: linear-gradient(to bottom right, #fff3cd, #ffe5b4, #ffd1d1);
    height: 100vh;
    overflow: hidden;
}

/* --- CONTENEUR PRINCIPAL --- */
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
}

/* --- SECTION QUIZ (HAUT) --- */
.quiz-section {
    margin-top: 50px;
    width: 100%;
    flex: 0 0 auto;
    padding: 5px 10px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

#instruction {
    font-weight: bold;
    font-size: 18px;
    color: #2c3e50;
    margin: 5px 0;
}

/* --- INPUTS ET BOUTONS (LARGEUR UNIFI√âE) --- */
.quiz-section input, 
.quiz-section button {
    width: 90%;
    max-width: 320px;
    padding: 10px;
    margin: 4px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
}

.quiz-section input { 
    text-align: center; 
    background: white; 
    border: 2px solid #ffca28;
    outline: none;
}
.quiz-section input:focus { border-color: #ff6f00; }

button {
    background-color: #ff6f00;
    color: white;
    border: none !important;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
}

button:hover { background-color: #e65c00; transform: scale(1.02); }
button:active { transform: scale(0.98); }

/* --- MENU DES FILTRES (TYPE-SELECTOR) --- */
#type-selector {
    position: absolute; 
    top: 100%;
    left: 50%;
    transform: translateX(-50%); 
    margin-top: 5px;
    z-index: 2000;
    width: 95%;
    max-width: 300px;
    padding: 10px;
    background: white; 
    border-radius: 10px; 
    border: 1px solid rgba(0,0,0,0.1); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    display: none;
    flex-direction: column;
}

.filter-list {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 2px 8px;
    margin: 8px 0;
    text-align: left;
}

.filter-list label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
    color: #2c3e50;
    cursor: pointer;
    padding: 2px 4px;
    white-space: nowrap;
}

#type-selector input[type="checkbox"] {
    width: 16px !important;
    height: 16px !important;
    margin: 0 !important;
    padding: 0 !important;
    flex-shrink: 0;
}

#type-selector button {
    padding: 8px;
    font-size: 13px;
    margin: 4px 0;
    width: 100%;
}

#bulk-toggle {
    background-color: #95a5a6 !important;
}

#toggle-filters {
  font-size: 12px !important;
  padding: 6px 12px !important;
  width: auto !important; /* Pas toute la largeur */
  border-radius: 8px;
  font-weight: 600;
  margin: 4px 0;
}
/* --- SECTION CARTE (BAS) --- */
.zoom-wrapper {
    flex: 1;
    width: 100%;
    position: relative;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    cursor: grab;
}

#map {
    width: 100%;
    height: auto;
    display: block;
    transform-origin: top center;
    transition: transform 0.1s ease-out;
}

/* --- √âTATS HITBOX --- */
.hitbox { transition: all 0.3s ease; pointer-events: none; stroke: rgba(120, 120, 120, 0.4); fill: rgba(150, 150, 150, 0.1); }
.type-fleuve { stroke-width: 4; fill: none !important; }
.type-montagne { stroke-width: 8; stroke-dasharray: 8,4; fill: none !important; }
.type-volcan { stroke-width: 2; }
.type-ocean, .type-mer { stroke-width: 1; }
.type-desert { stroke-width: 2; stroke-dasharray: 2,4; }

.highlight-current { stroke: orange !important; fill: rgba(255, 140, 0, 0.3) !important; stroke-width: 4; filter: drop-shadow(0 0 8px orange); }
.state-correct { stroke: green !important; fill: rgba(39, 174, 96, 0.3) !important; }
.state-wrong { stroke: red !important; fill: rgba(192, 57, 43, 0.3) !important; }

/* --- MEDIA QUERY : DESKTOP --- */
@media (min-width: 768px) {
    .container { flex-direction: row; }
    
    .quiz-section {
        width: 320px;
        height: 100vh;
        justify-content: flex-start;
        padding-top: 40px;
        position: relative;
        overflow: visible; /* Important pour que le menu ne soit pas coup√© */
    }

    #type-selector {
        /* On remet les valeurs du mobile pour qu'il soit sous le bouton */
        top: 100%; 
        left: 50%;
        transform: translateX(-50%);
        margin-top: 5px;
        padding: 15px;
        /* On s'assure qu'il reste par dessus la carte */
        position: absolute; 
        z-index: 3000;
    }
    #toggle-filters {
    background-color: #ff6f00 !important; /* Devient orange comme le mod√®le */
    color: white;
    padding: 10px 20px !important;
    border-radius: 25px !important; /* Tr√®s arrondi sur desktop */
    font-size: 14px !important;
    font-weight: bold;
    transition: transform 0.2s;
  }

  #toggle-filters:hover {
    background-color: #e65c00 !important; 
    transform: scale(1.05);
  }

  .zoom-wrapper {
    height: 100vh;
    align-items: flex-start;
    padding: 10px;
  }
}
    </style>
</head>
<body>
    <script src="../header.js"></script>
    <script>
        injectHeader({
            title: "Carte g√©ographique",
            homeLink: "../accueil.html",
            showHome: true
        });
    </script>

    <div class="container">
        <div class="quiz-section">
    <h2 id="instruction">Quelle est cette formation ?</h2>
    
    <input type="text" id="answer" placeholder="Attente..." autocomplete="off">
    
    <button onclick="checkAnswer()">Valider</button>
    <p id="result"></p>
    
    <p style="margin: 10px 0;">Score : <span id="score" style="font-weight: bold; color: #2c3e50;">0</span> / <span id="total-display">0</span></p>
    
    <div style="position: relative; width: 100%; display: flex; justify-content: center;">
        <button id="toggle-filters" onclick="toggleFilterMenu()">Afficher les filtres</button>
        
        <div id="type-selector">
            <button id="bulk-toggle" onclick="toggleAllCheckboxes()">Tout d√©cocher</button>
            <div class="filter-list">
                <label><input class="type-filter" type="checkbox" value="fleuve" checked> üåä Fleuves</label>
                <label><input class="type-filter" type="checkbox" value="cha√Æne de montagnes" checked> üèîÔ∏è Montagnes</label>
                <label><input class="type-filter" type="checkbox" value="volcan" checked> üåã Volcans</label>
                <label><input class="type-filter" type="checkbox" value="oc√©an" checked> üåê Oc√©ans</label>
                <label><input class="type-filter" type="checkbox" value="mer" checked> üåä Mers</label>
                <label><input class="type-filter" type="checkbox" value="d√©sert" checked> üèúÔ∏è D√©serts</label>
            </div>
            <button onclick="applyFilters()" style="background-color: #2c3e50;">Appliquer</button>
        </div>
    </div>
</div>

  <div class="zoom-wrapper" id="zoomContainer">
    <svg id="map" viewBox="0 0 2000 850">
      <image href="carte.svg" x="0" y="0" width="2000" height="850" />
      
      <path id="geo-nil" class="hitbox type-fleuve" d="M1107,540 L1105,528 L1100,512 L1102,505 L1110,496 L1109,474 L1114,468 L1112,456 L1103,461 L1100,454 L1100,448 L1111,436 L1109,422 L1100,414 L1101,394" />
      <path id="geo-amazone" class="hitbox type-fleuve" d="M582,599 L573,577 L578,571 L587,574 L600,566 L616,571 L631,563 L646,570 L683,560 L705,556" />
      <path id="geo-mississippi" class="hitbox type-fleuve" d="M502,304 L499,314 L515,334 L516,354 L522,362 L513,381 L512,397 L521,405" />
      <path id="geo-yangtse" class="hitbox type-fleuve" d="M1417,373 L1448,382 L1436,373 L1439,369 L1453,369 L1467,347 L1475,342 L1488,345 L1485,375 L1508,374 L1526,359" />
      <path id="geo-danube" class="hitbox type-fleuve" d="M994,298 L1010,292 L1043,300 L1043,314 L1062,323 L1084,322 L1087,315 L1094,316" />
      <path id="geo-congo" class="hitbox type-fleuve" d="M1079,606 L1075,594 L1083,588 L1081,572 L1075,548 L1061,539 L1043,543 L1031,559 L1027,570 L1013,579" />
      <path id="geo-volga" class="hitbox type-fleuve" d="M1190,309 L1182,284 L1191,249 L1161,238 L1137,232 L1119,246 L1108,240" />
      <path id="geo-mekong" class="hitbox type-fleuve" d="M1404,382 L1421,393 L1429,415 L1436,430 L1441,445 L1449,462 L1466,501" />
      <path id="geo-gange" class="hitbox type-fleuve" d="M1338,396 L1328,403 L1343,422 L1357,424 L1374,425 L1379,441" />
      <path id="geo-saint-laurent" class="hitbox type-fleuve" d="M582,322 L598,313 L612,305" />

      <path id="geo-himalaya" class="hitbox type-montagne" d="M1318,360 L1335,394 L1373,418 L1414,409" />
      <path id="geo-andes" class="hitbox type-montagne" d="M571,574 L591,617 L620,633 L619,685 L611,738 L601,787 L595,819 L603,842 L622,850" />
      <path id="geo-rocheuses" class="hitbox type-montagne" d="M252,173 L321,202 L371,268 L418,329 L439,397" />
      <path id="geo-alpes" class="hitbox type-montagne" d="M983,314 L993,306 L1027,303" />
      <path id="geo-pyr√©n√©es" class="hitbox type-montagne" d="M942,326 L967,332" />
      <path id="geo-oural" class="hitbox type-montagne" d="M1264,152 L1254,190 L1269,262" />
      <path id="geo-atlas" class="hitbox type-montagne" d="M901,411 L945,387 L994,376" />
      <path id="geo-scandes" class="hitbox type-montagne" d="M987,220 L1053,144" />

      <circle id="geo-fuji" class="hitbox type-volcan" cx="1626" cy="360" r="10" />
      <circle id="geo-etna" class="hitbox type-volcan" cx="1025" cy="358" r="10" />
      <circle id="geo-krakatoa" class="hitbox type-volcan" cx="1637" cy="568" r="10" />
      <circle id="geo-kilimandjaro" class="hitbox type-volcan" cx="1133" cy="565" r="10" />
      <circle id="geo-popocatepetl" class="hitbox type-volcan" cx="467" cy="450" r="10" />

      <ellipse id="geo-pacifique" class="hitbox type-ocean" cx="332" cy="549" rx="121" ry="308" transform="rotate(-28 332 549)" />
      <ellipse id="geo-atlantique" class="hitbox type-ocean" cx="808" cy="516" rx="81" ry="247" transform="rotate(-38 808 516)" />
      <ellipse id="geo-indien" class="hitbox type-ocean" cx="1319" cy="645" rx="142" ry="135" />
      <ellipse id="geo-arctique" class="hitbox type-ocean" cx="1037" cy="52" rx="460" ry="51" />
      <ellipse id="geo-antarctique" class="hitbox type-ocean" cx="1099" cy="809" rx="402" ry="30" />
      <ellipse id="geo-m√©diterran√©e" class="hitbox type-mer" cx="1038" cy="363" rx="84" ry="36" transform="rotate(13 1038 363)" />
      <ellipse id="geo-caraibes" class="hitbox type-mer" cx="589" cy="478" rx="68" ry="33" transform="rotate(12 589 478)" />
      <ellipse id="geo-rouge" class="hitbox type-mer" cx="1136" cy="445" rx="47" ry="9" transform="rotate(59 1136 445)" />
      <ellipse id="geo-noire" class="hitbox type-mer" cx="1119" cy="326" rx="38" ry="25" />
      <ellipse id="geo-caspienne" class="hitbox type-mer" cx="1200" cy="336" rx="36" ry="22" transform="rotate(82 1200 336)" />

      <ellipse id="geo-sahara" class="hitbox type-desert" cx="1003" cy="437" rx="129" ry="49" />
      <ellipse id="geo-gobi" class="hitbox type-desert" cx="1445" cy="349" rx="46" ry="23" />
      <ellipse id="geo-australien" class="hitbox type-desert" cx="1589" cy="667" rx="46" ry="35" />
      <ellipse id="geo-atacama" class="hitbox type-desert" cx="617" cy="663" rx="11" ry="28" />
    </svg>

  <div id="end-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; color: white; font-family: 'Quicksand', sans-serif;">
    <div style="background: white; color: #2c3e50; padding: 30px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%;">
        <h2 style="color: #e67e22;">Partie Termin√©e !</h2>
        <p style="font-size: 1.2em;">Ton score : <span id="final-score" style="font-weight: bold; color: #ff6f00;">0</span>%</p>
        <p>Moyenne globale : <span id="global-average" style="font-weight: bold;">--</span>%</p>
        <button onclick="startNewGame()" style="margin-top: 20px; width: 100%;">Rejouer</button>
    </div>
</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// 1. CONFIGURATION & INITIALISATION (Plac√©es en haut)
const firebaseConfig = {
    apiKey: "AIzaSyB29fMpTwBgsqkjijkNoQJ2kGChSeQDX_w",
    authDomain: "quiz-ea203.firebaseapp.com",
    databaseURL: "https://quiz-ea203-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "quiz-ea203",
    storageBucket: "quiz-ea203.firebasestorage.app",
    messagingSenderId: "605137421110",
    appId: "1:605137421110:web:289e0876fe06108deaa997"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// 2. VARIABLES GLOBALES (D√©clar√©es t√¥t pour √©viter les ReferenceErrors)
const targets = [
  { id: "geo-nil", name: "Nil", type: "fleuve" }, { id: "geo-amazone", name: "Amazone", type: "fleuve" },
  { id: "geo-mississippi", name: "Mississippi", type: "fleuve" }, { id: "geo-yangtse", name: "Yangts√©", type: "fleuve" },
  { id: "geo-danube", name: "Danube", type: "fleuve" }, { id: "geo-congo", name: "Congo", type: "fleuve" },
  { id: "geo-volga", name: "Volga", type: "fleuve" }, { id: "geo-mekong", name: "M√©kong", type: "fleuve" },
  { id: "geo-gange", name: "Gange", type: "fleuve" }, { id: "geo-saint-laurent", name: "Saint-Laurent", type: "fleuve" },
  { id: "geo-himalaya", name: "Himalaya", type: "cha√Æne de montagnes" }, { id: "geo-andes", name: "Andes", type: "cha√Æne de montagnes" },
  { id: "geo-rocheuses", name: "Rocheuses", type: "cha√Æne de montagnes" }, { id: "geo-alpes", name: "Alpes", type: "cha√Æne de montagnes" },
  { id: "geo-oural", name: "Oural", type: "cha√Æne de montagnes" }, { id: "geo-atlas", name: "Atlas", type: "cha√Æne de montagnes" },
  { id: "geo-scandes", name: "Scandes", type: "cha√Æne de montagnes" }, { id: "geo-pyr√©n√©es", name: "Pyr√©n√©es", type: "cha√Æne de montagnes" },
  { id: "geo-fuji", name: "Fuji", type: "volcan" }, { id: "geo-etna", name: "Etna", type: "volcan" },
  { id: "geo-krakatoa", name: "Krakatoa", type: "volcan" }, { id: "geo-kilimandjaro", name: "Kilimandjaro", type: "volcan" },
  { id: "geo-popocatepetl", name: "Popocat√©petl", type: "volcan" }, { id: "geo-pacifique", name: "Pacifique", type: "oc√©an" },
  { id: "geo-atlantique", name: "Atlantique", type: "oc√©an" }, { id: "geo-indien", name: "Indien", type: "oc√©an" },
  { id: "geo-arctique", name: "Arctique", type: "oc√©an" }, { id: "geo-antarctique", name: "Antarctique", type: "oc√©an" },
  { id: "geo-m√©diterran√©e", name: "M√©diterran√©e", type: "mer" },{ id: "geo-noire", name: "Mer Noire", type: "mer" },
  { id: "geo-caraibes", name: "Mer des Cara√Øbes", type: "mer" }, { id: "geo-rouge", name: "Mer Rouge", type: "mer" },
  { id: "geo-caspienne", name: "Mer Caspienne", type: "mer" }, 
  { id: "geo-sahara", name: "Sahara", type: "d√©sert" }, { id: "geo-atacama", name: "Atacama", type: "d√©sert" },
  { id: "geo-gobi", name: "Gobi", type: "d√©sert" }, { id: "geo-australien", name: "Grand D√©sert Australien", type: "d√©sert" }
];

let currentUserUid = null;
let score = 0, current = null, remainingTargets = [], activeTargets = [...targets];

// 3. FONCTIONS DE PERSISTANCE (FILTRES & SESSION)
async function saveFilters(selectedTypes) {
    if (currentUserUid) {
        // FIREBASE
        await set(ref(db, `users/${currentUserUid}/games/nature/settings/filters`), selectedTypes);
    } else {
        // LOCAL
        localStorage.setItem('nature_filters_guest', JSON.stringify(selectedTypes));
    }
}

async function restoreFilters() {
    if (!currentUserUid) return;
    const snapshot = await get(ref(db, `users/${currentUserUid}/games/nature/settings/filters`));
    if (snapshot.exists()) {
        const selected = snapshot.val();
        document.querySelectorAll('.type-filter').forEach(cb => cb.checked = selected.includes(cb.value));
        activeTargets = targets.filter(t => selected.includes(t.type));
    }
}

async function restoreSession() {
    if (!currentUserUid) return;
    await restoreFilters(); // On charge les filtres d'abord
    
    // Application visuelle des filtres sur le SVG
    const selectedTypes = Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);
    targets.forEach(t => {
        const el = document.getElementById(t.id);
        if (el) el.style.display = selectedTypes.includes(t.type) ? "block" : "none";
    });

    const snapshot = await get(ref(db, `users/${currentUserUid}/games/nature/session`));
    remainingTargets = [...activeTargets];
    score = 0;

    if (snapshot.exists()) {
        const data = snapshot.val();
        Object.keys(data).forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                const isCorrect = data[id] === 'correct';
                el.classList.add(isCorrect ? 'state-correct' : 'state-wrong');
                if (isCorrect) score++;
            }
            remainingTargets = remainingTargets.filter(t => t.id !== id);
        });
    }
    updateScoreDisplay();
}

function restoreLocalGuestSession() {
    // Restaurer les filtres
    const savedFilters = JSON.parse(localStorage.getItem('nature_filters_guest'));
    if (savedFilters) {
        document.querySelectorAll('.type-filter').forEach(cb => cb.checked = savedFilters.includes(cb.value));
        activeTargets = targets.filter(t => savedFilters.includes(t.type));
    }

    // Appliquer visuellement les filtres
    const selectedTypes = Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);
    targets.forEach(t => {
        const el = document.getElementById(t.id);
        if (el) el.style.display = selectedTypes.includes(t.type) ? "block" : "none";
    });

    // Restaurer les r√©ponses (points rouges/verts)
    const localSess = JSON.parse(localStorage.getItem('nature_session_guest') || '{}');
    remainingTargets = [...activeTargets];
    score = 0;

    Object.keys(localSess).forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            const isCorrect = localSess[id] === 'correct';
            el.classList.add(isCorrect ? 'state-correct' : 'state-wrong');
            if (isCorrect) score++;
        }
        remainingTargets = remainingTargets.filter(t => t.id !== id);
    });
    updateScoreDisplay();
}
// 4. LOGIQUE DU JEU
function updateScoreDisplay() {
    document.getElementById('score').textContent = score;
    document.getElementById('total-display').textContent = activeTargets.length;
}

function nextQuestion() {
    if (remainingTargets.length === 0) { handleGameOver(); return; }
    document.querySelectorAll('.hitbox').forEach(el => el.classList.remove('highlight-current'));
    document.getElementById('answer').value = '';
    document.getElementById('answer').disabled = false;
    document.getElementById('result').textContent = '';
    
    const index = Math.floor(Math.random() * remainingTargets.length);
    current = remainingTargets.splice(index, 1)[0];
    
    const el = document.getElementById(current.id);
    if (el) el.classList.add('highlight-current');
    document.getElementById('answer').placeholder = "Nom " + getDeterminate(current.type) + "...";
    document.getElementById('answer').focus();
}

async function checkAnswer() {
    const inputEl = document.getElementById('answer');
    if (inputEl.disabled || !current) return;
    inputEl.disabled = true;

    // Normalisation de la r√©ponse (minuscules et retrait des accents)
    const userVal = inputEl.value.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const correctVal = current.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const element = document.getElementById(current.id);
    
    if (element) element.classList.remove('highlight-current');

    const isCorrect = userVal === correctVal;
    const status = isCorrect ? 'correct' : 'wrong';

    // Mise √† jour visuelle imm√©diate
    if (isCorrect) {
        score++;
        if (element) element.classList.add('state-correct');
        document.getElementById('result').textContent = "‚úÖ " + current.name;
        document.getElementById('result').style.color = "#27ae60";
    } else {
        if (element) element.classList.add('state-wrong');
        document.getElementById('result').textContent = "‚ùå C'√©tait " + current.name;
        document.getElementById('result').style.color = "#c0392b";
    }

    updateScoreDisplay();

    // --- LOGIQUE DE SAUVEGARDE HYBRIDE S√âCURIS√âE ---
    // On utilise currentUserUid qui est null si l'utilisateur est anonyme
    if (currentUserUid) {
        // Mode Connect√© (Compte r√©el) : Sauvegarde sur Firebase
        try {
            await update(ref(db, `users/${currentUserUid}/games/nature/session`), { 
                [current.id]: status 
            });
        } catch (e) {
            console.error("Erreur sauvegarde Firebase:", e);
        }
    } else {
        // Mode Invit√© ou Anonyme : Sauvegarde uniquement dans le localStorage
        try {
            const localSess = JSON.parse(localStorage.getItem('nature_session_guest') || '{}');
            localSess[current.id] = status;
            localStorage.setItem('nature_session_guest', JSON.stringify(localSess));
        } catch (e) {
            console.error("Erreur sauvegarde LocalStorage:", e);
        }
    }

    // Passage √† la question suivante apr√®s un court d√©lai
    setTimeout(() => { 
        nextQuestion(); 
    }, 1500);
}

// 5. GESTION DES FILTRES
async function applyFilters() { // 1. On ajoute async ici
    const selectedTypes = Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);
    if (selectedTypes.length === 0) return alert("Choisis au moins un type !");
    
    activeTargets = targets.filter(t => selectedTypes.includes(t.type));
    
    // Cache ou montre les √©l√©ments sur le SVG selon le filtre
    targets.forEach(t => {
        const el = document.getElementById(t.id);
        if (el) el.style.display = selectedTypes.includes(t.type) ? "block" : "none";
    });

    // 2. Sauvegarde des filtres dans Firebase
    saveFilters(selectedTypes);

    // --- NOUVEAU : VIDE LA M√âMOIRE DES R√âPONSES ---
    if (currentUserUid) {
        try {
            // On supprime la session pr√©c√©dente pour que les points rouges/verts disparaissent
            await remove(ref(db, `users/${currentUserUid}/games/nature/session`));
        } catch (e) { console.error("Erreur reset session Firebase:", e); }
    }
    if (!auth.currentUser) {
        localStorage.removeItem('nature_session_guest');
    }
    // ----------------------------------------------

    document.getElementById('type-selector').style.display = "none";
    
    // 3. R√©initialise le jeu (score √† 0 et nettoyage visuel de la carte)
    resetQuiz();
}

function resetQuiz() {
    score = 0;
    remainingTargets = [...activeTargets];
    document.querySelectorAll('.hitbox').forEach(el => el.classList.remove('state-correct', 'state-wrong', 'highlight-current'));
    updateScoreDisplay();
    nextQuestion();
}

async function startNewGame() {
    // 1. Fermer la modal de fin
    document.getElementById('end-modal').style.display = 'none';

    // 2. Si l'utilisateur est connect√©, on vide sa progression dans Firebase
    if (currentUserUid) {
        await remove(ref(db, `users/${currentUserUid}/games/nature/session`));
    }

    // 3. On relance le quiz sans recharger la page (pour garder les filtres actuels)
    resetQuiz();
}

async function handleGameOver() {
    const total = activeTargets.length || 1;
    const finalPercent = Math.round((score / total) * 100);
    document.getElementById('final-score').textContent = finalPercent;

    // Enregistrement des stats uniquement si compte r√©el
    if (currentUserUid) {
        const statsRef = ref(db, `users/${currentUserUid}/games/nature/stats`);
        const snap = await get(statsRef);
        let games = 1, avg = finalPercent;
        if (snap.exists()) {
            const d = snap.val();
            games = (d.gamesPlayed || 0) + 1;
            avg = Math.round(((d.averageScore || 0) * (games - 1) + finalPercent) / games);
        }
        await update(statsRef, { 
            gamesPlayed: games, 
            averageScore: avg, 
            lastPlayed: new Date().toISOString() 
        });
        document.getElementById('global-average-container').style.display = 'block';
        document.getElementById('global-average').textContent = avg;
    } else {
        // Cacher la moyenne globale en mode invit√©
        document.getElementById('global-average-container').style.display = 'none';
    }
    document.getElementById('end-modal').style.display = 'flex';
}
// Utilitaires
function getDeterminate(type) {
    const vowels = ['a', 'e', 'i', 'o', 'u', 'y'];
    if (vowels.includes(type.charAt(0).toLowerCase())) return "de l'" + type;
    return ['mer', 'cha√Æne de montagnes', 'montagne'].includes(type.toLowerCase()) ? "de la " + type : "du " + type;
}


// 6. INITIALISATION & AUTH
onAuthStateChanged(auth, async (user) => {
    // PRIORIT√â : On v√©rifie si un profil a √©t√© choisi manuellement
    const savedUid = localStorage.getItem('active_uid');

    if (savedUid) {
        // Mode VRAI COMPTE (m√™me si session Firebase est anonyme)
        currentUserUid = savedUid;
        console.log("üìù Mode Profil Connect√© :", currentUserUid);
        await restoreSession(); 
    } else {
        // Mode INVITE (pas de active_uid dans le stockage)
        currentUserUid = null;
        console.log("üïπÔ∏è Mode Invit√© : Utilisation du stockage local");
        restoreLocalGuestSession();
    }
    
    if (remainingTargets.length > 0 && !current) nextQuestion();
});
// Exposer au Window
window.toggleFilterMenu = () => {
    const m = document.getElementById('type-selector');
    // On r√©cup√®re le style r√©ellement affich√© par le navigateur
    const currentDisplay = window.getComputedStyle(m).display;
    
    if (currentDisplay === "none") {
        m.style.display = "flex"; // Utilise flex car ton CSS d√©finit flex-direction: column
    } else {
        m.style.display = "none";
    }
};
window.toggleAllCheckboxes = () => {
    const cbs = document.querySelectorAll('.type-filter');
    const all = Array.from(cbs).every(cb => cb.checked);
    cbs.forEach(cb => cb.checked = !all);
    document.getElementById('bulk-toggle').textContent = !all ? "Tout d√©cocher" : "Tout cocher";
};
window.applyFilters = applyFilters;
window.checkAnswer = checkAnswer;
window.startNewGame = startNewGame;

// Zoom & Pan Logic (simplifi√© pour l'espace)
const container = document.getElementById("zoomContainer");
const svg = document.getElementById("map");
let scale = 1, panX = 0, panY = 0;
container.addEventListener("wheel", (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.15 : 0.15;
    scale = Math.min(Math.max(scale + delta, 0.5), 15);
    svg.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
}, { passive: false });

document.getElementById('answer').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });
</script>
</body>
</html>