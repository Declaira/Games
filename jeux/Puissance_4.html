<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ðŸŸ¡ Puissance 4  ðŸ”´</title>
    <link rel="icon" href="../logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&display=swap" rel="stylesheet">
    <style>
        /* --- STYLES CSS --- */
        body { 
            font-family: 'Quicksand', sans-serif; 
            background: linear-gradient(135deg,#fff3cd,#ffe5b4,#ffd1d1,#ffc4e1);
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #2c3e50;
        }
        header { width: 100%; flex-shrink: 0; }
        .container { text-align: center; max-width: 600px; width: 95%; margin-top: 20px; }
        h1 { margin-bottom: 10px; color: #d35400; text-shadow: 2px 2px 0px rgba(255,255,255,0.5); }
        
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; transition: height 0.3s; }
        .hidden { display: none !important; }
        
        input { padding: 10px; border-radius: 8px; border: 2px solid #ddd; font-family: inherit; font-weight: bold; width: 70%; margin-bottom: 10px; text-align: center; }
        
        /* Boutons */
        button { 
            padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; 
            font-weight: bold; font-size: 1rem; transition: transform 0.2s, box-shadow 0.2s; color: white; margin: 5px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-solo { background: #3498db; }
        .btn-multi { background: #9b59b6; }
        .btn-menu { background: #95a5a6; font-size: 0.9rem; padding: 10px 20px; }
        .btn-restart { background: #e67e22; font-size: 0.9rem; padding: 10px 20px; }
        
        /* Boutons difficultÃ© */
        .btn-diff-normal { background: #2ecc71; opacity: 0.6; }
        .btn-diff-hard { background: #e74c3c; opacity: 0.6; }
        .selected-diff { opacity: 1 !important; transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.3); border: 2px solid #2c3e50; }

        .btn-choice { width: 40%; font-size: 1.1rem; padding: 15px; }
        
        /* Plateau */
        #board { 
            display: grid; grid-template-columns: repeat(7, 50px); grid-template-rows: repeat(6, 50px); 
            gap: 8px; background: #34495e; padding: 12px; border-radius: 15px; border: 5px solid #2c3e50;
            margin: 0 auto; width: fit-content; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        /* Styles pour les titres de victoire/dÃ©faite */
        .win-title { color: #2ecc71 !important; text-shadow: 0 0 15px rgba(46, 204, 113, 0.4); }
        .lose-title { color: #e74c3c !important; text-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }

        /* Animation du record-status */
        #record-status {
            margin: 10px 0;
            font-weight: bold;
            padding: 8px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        /* OpacitÃ© du plateau en attente */
        .opacity-50 { opacity: 0.5; pointer-events: none; }
        @media (min-width: 500px) {
            #board { grid-template-columns: repeat(7, 60px); grid-template-rows: repeat(6, 60px); gap: 10px; padding: 15px; }
            .cell { width: 60px !important; height: 60px !important; }
        }

        .cell { 
            width: 50px; height: 50px; background: #ecf0f1; border-radius: 50%; 
            cursor: pointer; transition: background 0.3s; position: relative; overflow: hidden;
        }
        
        .color-red { background: #e74c3c !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .color-yellow { background: #f1c40f !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .anim-drop { animation: drop 0.4s cubic-bezier(0.5, 0, 0.75, 1.5); }
        
        @keyframes drop { from { transform: translateY(-400px); } to { transform: translateY(0); } }

        .status-text { font-size: 1.3rem; margin-bottom: 10px; font-weight: bold; }
        .turn-indicator { padding: 8px 20px; background: #eee; border-radius: 30px; display: inline-block; font-size: 1rem; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .game-controls { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 90%; width: 400px; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #2c3e50;
        }
        @keyframes popIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <script src="../header.js"></script>
    <script>
        if(typeof injectHeader === 'function') {
            injectHeader({ title: "ðŸŸ¡ Puissance 4 ðŸ”´", homeLink: "../accueil.html", showHome: true });
        }
    </script>

    <div class="container">
        <div id="screen-menu" class="box">
            <h1>Puissance 4</h1>
            <div id="lobby-controls">
                <p><b>Mode En Ligne</b></p>
                <input type="text" id="roomInput" placeholder="Code Salon (ex: ABCD)" maxlength="6" style="text-transform: uppercase;">
                <br>
                <button class="btn-multi" onclick="joinRoom()">Rejoindre / CrÃ©er</button>
                
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                
                <p><b>Mode Solo</b></p>
                <button class="btn-solo" onclick="prepareSolo()">Jouer contre l'IA</button>
            </div>
        </div>

        <div id="screen-solo-setup" class="box hidden">
            <h2>Configuration Solo</h2>
            <p>1. Niveau de l'IA</p>
            <div>
                <button id="btn-diff-easy" class="btn-diff-normal" onclick="selectDifficulty('easy')">ðŸ™‚ Facile</button>
                <button id="btn-diff-hard" class="btn-diff-hard" onclick="selectDifficulty('hard')">ðŸ˜ˆ Difficile</button>
            </div>

            <div id="color-selection-area" class="hidden" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <p>2. Votre couleur</p>
                <button class="btn-choice color-red" onclick="startAiGame('red')">Rouge</button>
                <button class="btn-choice color-yellow" onclick="startAiGame('yellow')">Jaune</button>
            </div>
            
            <button class="btn-menu" onclick="location.reload()" style="margin-top:20px;">Annuler</button>
        </div>

        <div id="screen-game" class="hidden">
            <div class="box" style="padding-bottom: 15px;">
                <div class="status-text" id="status-display">Salon : -</div>
                <div class="turn-indicator" id="turn-display">Attente...</div>
                
                <div id="setup-color-multi" class="hidden" style="margin-top:15px; border-top: 2px solid #eee; padding-top:15px;">
                    <p style="margin:0 0 10px 0; font-weight:bold;">Choisissez la couleur de dÃ©part :</p>
                    <button class="btn-choice color-red" onclick="window.chooseColorMulti('red')">Rouge</button>
                    <button class="btn-choice color-yellow" onclick="window.chooseColorMulti('yellow')">Jaune</button>
                </div>
            </div>

            <div id="board"></div>
            
            <div class="game-controls">
                <button id="btn-restart" class="btn-restart hidden" onclick="resetCurrentGrid()">ðŸ”„ Rejouer</button>
                <button class="btn-menu" onclick="leaveRoom()">ðŸšª Quitter la partie</button>
            </div>
        </div>
    </div>

    <div id="modal-multi-end" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="multi-end-title">TerminÃ© !</h2>
            <p id="multi-end-msg"></p>
            <p id="record-status" style="font-size: 0.9em; opacity: 0.8;"></p>
            
            <div id="loser-choice-area" class="hidden" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                <p style="font-weight: bold; margin-bottom: 10px;">Voulez-vous commencer la revanche ?</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="resetWithChoice(true)" class="btn-restart" >Oui, je commence</button>
                    <button onclick="resetWithChoice(false)" class="btn-restart" >Non, l'IA commence</button>
                </div>
            </div>

            <button id="btn-standard-reset" onclick="resetCurrentGrid()" class="btn-restart" style="margin-top: 15px;">Rejouer</button>
            <button onclick="leaveRoom()" class="btn-menu">Quitter</button>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, onValue, update, runTransaction, onDisconnect, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyB29fMpTwBgsqkjijkNoQJ2kGChSeQDX_w",
    authDomain: "quiz-ea203.firebaseapp.com",
    databaseURL: "https://quiz-ea203-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "quiz-ea203",
    storageBucket: "quiz-ea203.firebasestorage.app",
    messagingSenderId: "605137421110",
    appId: "1:605137421110:web:289e0876fe06108deaa997"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let currentRoom = null;
let myName = "";
let isAiGame = false;
let aiLevel = "easy";
let currentGameState = null;
let currentUserColor = 'red';
let lastWinner = null;
let lastMove = null;

// --- AUTH & INITIALISATION ---
onAuthStateChanged(auth, async (user) => {
    const savedUid = localStorage.getItem('active_uid');
    
    if (savedUid || user) {
        currentUser = { uid: savedUid || user.uid };
        const uid = currentUser.uid;

        try {
            const userRef = ref(db, `users/${uid}`);
            // CHANGEMENT ICI : On pointe vers games/p4/activeGame
            const gameRef = ref(db, `users/${uid}/games/p4/activeGame`);
            
            const [userSnap, gameSnap] = await Promise.all([
                get(userRef),
                get(gameRef)
            ]);

            if (userSnap.exists()) {
                myName = userSnap.val().username || userSnap.val().name || "Joueur";
            }

            if (gameSnap.exists()) {
                const session = gameSnap.val();
                setTimeout(() => {
                    if (confirm("Une partie de Puissance 4 en cours a Ã©tÃ© trouvÃ©e. Reprendre ?")) {
                        if (session.isAiGame) {
                            aiLevel = session.aiLevel || "easy";
                            window.startAiGame(session.playerColor || "red", session.board || null);
                        } else if (session.currentRoom) {
                            document.getElementById('roomInput').value = session.currentRoom;
                            window.joinRoom();
                        }
                    } else {
                        remove(gameRef); // Nettoie le nouvel emplacement
                    }
                }, 500);
            }
        } catch (e) { console.error("Erreur profil :", e); }
    } else {
        // MODE INVITÃ‰
        let guestId = localStorage.getItem('guest_uid') || "guest_" + Math.floor(Math.random() * 1000000);
        localStorage.setItem('guest_uid', guestId);
        currentUser = { uid: guestId };
        
        // CHANGEMENT ICI : On utilise activeGamep4
        const localSession = localStorage.getItem('activeGamep4');
        if (localSession) {
            const session = JSON.parse(localSession);
            setTimeout(() => {
                if (confirm("Reprendre votre partie d'invitÃ© ?")) {
                    aiLevel = session.aiLevel || "easy";
                    window.startAiGame(session.playerColor || "red", session.board || null);
                } else {
                    localStorage.removeItem('activeGamep4');
                }
            }, 500);
        }
    }
});

// --- GESTION DES STATS ---
async function recordResult(result, type) {
    // On ne sauvegarde les stats QUE si ce n'est pas un invitÃ©
    if (!currentUser || currentUser.uid.startsWith('guest')) return;
    
    try {
        const statsRef = ref(db, `users/${currentUser.uid}/games/p4/stats/${type}`);
        const snap = await get(statsRef);
        const data = snap.exists() ? snap.val() : { wins: 0, losses: 0, draws: 0 };

        if (result === 'win') data.wins++;
        else if (result === 'loss') data.losses++;
        else data.draws++;

        await set(statsRef, data);
        
        const recordStatus = document.getElementById('record-status');
        if (recordStatus) {
            if (result === 'win') recordStatus.innerText = "ðŸ“ˆ Victoire enregistrÃ©e !";
            else if (result === 'loss') recordStatus.innerText = "ðŸ“‰ DÃ©faite enregistrÃ©e.";
            else recordStatus.innerText = "ðŸ¤ Match nul enregistrÃ©.";
        }
    } catch (e) { console.error("Erreur stats:", e); }
}

// --- NAVIGATION INTERFACE ---
function showGame(visible) {
    const menu = document.getElementById('screen-menu');
    const soloSetup = document.getElementById('screen-solo-setup');
    const game = document.getElementById('screen-game');

    if (visible) {
        if(menu) menu.classList.add('hidden');
        if(soloSetup) soloSetup.classList.add('hidden');
        if(game) game.classList.remove('hidden');
    } else {
        if(menu) menu.classList.remove('hidden');
        if(game) game.classList.add('hidden');
    }
}

window.prepareSolo = () => {
    document.getElementById('screen-menu').classList.add('hidden');
    document.getElementById('screen-solo-setup').classList.remove('hidden');
};

window.selectDifficulty = (level) => {
    aiLevel = level;
    document.getElementById('btn-diff-easy').classList.remove('selected-diff');
    document.getElementById('btn-diff-hard').classList.remove('selected-diff');
    document.getElementById(`btn-diff-${level}`).classList.add('selected-diff');
    document.getElementById('color-selection-area').classList.remove('hidden');
};

// --- LOGIQUE MULTIJOUEUR ---
window.joinRoom = async () => {
    // ðŸ›¡ï¸ SÃ‰CURITÃ‰ : VÃ©rifier si l'utilisateur est initialisÃ© (connectÃ© ou invitÃ©)
    if (!currentUser || !currentUser.uid) {
        alert("Initialisation de votre profil en cours... RÃ©essayez dans un instant.");
        return;
    }

    const roomInputEl = document.getElementById('roomInput');
    const roomInput = roomInputEl ? roomInputEl.value.trim().toUpperCase() : "";
    
    if (!roomInput) return alert("Code requis");
    
    currentRoom = roomInput;
    isAiGame = false;

    // Sauvegarde de session uniquement pour les profils rÃ©els (Firebase)
    if (!currentUser.uid.startsWith('guest')) { 
        try {
            update(ref(db, `users/${currentUser.uid}/games/p4/activeGame`), {
                currentRoom: currentRoom,
                isAiGame: false,
                timestamp: Date.now()
            });
        } catch (e) {
            console.warn("Erreur sauvegarde session profil:", e);
        }
    }

    const roomRef = ref(db, `rooms/p4_${currentRoom}`);

    try {
        await runTransaction(roomRef, (room) => {
            // Si la room n'existe pas, on la crÃ©e (Joueur 1)
            if (!room) {
                return {
                    board: Array(6).fill(0).map(() => Array(7).fill(0)),
                    turn: 1,
                    p1: { uid: currentUser.uid, name: myName },
                    p2: null,
                    status: 'waiting',
                    recorded: false,
                    lastMove: null
                };
            } 
            
            // Si on est dÃ©jÃ  dans la partie (reconnexion/refresh)
            if (room.p1.uid === currentUser.uid || (room.p2 && room.p2.uid === currentUser.uid)) {
                return room; 
            }

            // Si la place Joueur 2 est libre, on la prend
            if (!room.p2) {
                room.p2 = { uid: currentUser.uid, name: myName };
                room.status = 'playing';
                return room;
            }

            // Si la room est pleine et qu'on n'est pas dedans
            alert("Ce salon est dÃ©jÃ  plein.");
            return; 
        });

        // Gestion de la dÃ©connexion
        onDisconnect(roomRef).update({ status: 'aborted' });
        
        // Ã‰coute des changements de la room
        onValue(roomRef, (snap) => {
            const data = snap.val();
            if (data) updateUI(data);
        });

        showGame(true);

    } catch (error) {
        console.error("Erreur lors de la jonction au salon:", error);
        alert("Impossible de rejoindre le salon.");
    }
};

window.leaveRoom = async () => {
    // --- NETTOYAGE FIREBASE ---
    if (currentUser?.uid && !currentUser.uid.startsWith('guest')) {
        // Nettoyage profil
        await remove(ref(db, `users/${currentUser.uid}/games/p4/activeGame`));
    } else {
        // Nettoyage invitÃ©
        localStorage.removeItem('activeGamep4');
    }

    if (currentRoom && !isAiGame) {
        const roomRef = ref(db, `rooms/p4_${currentRoom}`);
        const snap = await get(roomRef);
        if (snap.exists() && (snap.val().p1?.uid === currentUser.uid || snap.val().p2?.uid === currentUser.uid)) {
            await remove(roomRef);
        }
    }
    location.reload(); 
};

// --- LOGIQUE SOLO IA ---
function evaluateBoard(board, p) {
    let score = 0;
    const opp = p === 1 ? 2 : 1;

    // Favoriser la colonne centrale (stratÃ©gie clÃ© au Puissance 4)
    for (let r = 0; r < 6; r++) {
        if (board[r][3] === p) score += 4;
        else if (board[r][3] === opp) score -= 3;
    }
    
    const scoreWindow = (window) => {
        let pCount = window.filter(x => x === p).length;
        let oCount = window.filter(x => x === opp).length;
        let empty = window.filter(x => x === 0).length;

        if (pCount === 4) return 10000;
        if (pCount === 3 && empty === 1) return 100;
        if (pCount === 2 && empty === 2) return 10;
        
        if (oCount === 3 && empty === 1) return -900; // Bloquer l'adversaire est prioritaire
        if (oCount === 2 && empty === 2) return -50;
        return 0;
    };

    // Scan Horizontal
    for (let r = 0; r < 6; r++) {
        for (let c = 0; c < 4; c++) score += scoreWindow([board[r][c], board[r][c+1], board[r][c+2], board[r][c+3]]);
    }
    // Scan Vertical
    for (let c = 0; c < 7; c++) {
        for (let r = 0; r < 3; r++) score += scoreWindow([board[r][c], board[r+1][c], board[r+2][c], board[r+3][c]]);
    }
    // Diagonales
    for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 4; c++) {
            score += scoreWindow([board[r][c], board[r+1][c+1], board[r+2][c+2], board[r+3][c+3]]);
            score += scoreWindow([board[r+3][c], board[r+2][c+1], board[r+1][c+2], board[r][c+3]]);
        }
    }
    return score;
}

function minimax(board, depth, alpha, beta, maximizing, aiNum) {
    const opp = aiNum === 1 ? 2 : 1;
    
    // VÃ©rification immÃ©diate de victoire/dÃ©faite pour stopper l'arbre
    const validCols = [];
    for (let c of [3, 2, 4, 1, 5, 0, 6]) { // Ordre optimisÃ© : centre en premier
        if (board[0][c] === 0) validCols.push(c);
    }

    // Conditions d'arrÃªt
    if (depth === 0 || validCols.length === 0) return { score: evaluateBoard(board, aiNum) };

    if (maximizing) {
        let value = -Infinity;
        let column = validCols[0];
        for (let c of validCols) {
            let r = getFirstEmptyRow(c, board);
            board[r][c] = aiNum;
            // Si ce coup gagne, on le prend immÃ©diatement
            if (checkWin(r, c, board)) {
                board[r][c] = 0;
                return { column: c, score: 100000 + depth };
            }
            let res = minimax(board, depth - 1, alpha, beta, false, aiNum);
            board[r][c] = 0;
            if (res.score > value) { value = res.score; column = c; }
            alpha = Math.max(alpha, value);
            if (alpha >= beta) break;
        }
        return { column, score: value };
    } else {
        let value = Infinity;
        for (let c of validCols) {
            let r = getFirstEmptyRow(c, board);
            board[r][c] = opp;
            if (checkWin(r, c, board)) {
                board[r][c] = 0;
                return { score: -100000 - depth };
            }
            let res = minimax(board, depth - 1, alpha, beta, true, aiNum);
            board[r][c] = 0;
            if (res.score < value) value = res.score;
            beta = Math.min(beta, value);
            if (alpha >= beta) break;
        }
        return { score: value };
    }
}

window.startAiGame = (playerColor, savedBoard = null) => {
    isAiGame = true;
    currentUserColor = playerColor;
    const aiColor = (playerColor === 'red' ? 'yellow' : 'red');
    currentRoom = "SOLO_IA";

    // Sauvegarde session IA (Profils uniquement)
    if (currentUser && !currentUser.uid.startsWith('guest')) {
        update(ref(db, `users/${currentUser.uid}/games/p4/activeGame`), {
            isAiGame: true,
            playerColor: playerColor,
            aiLevel: aiLevel,
            timestamp: Date.now(),
        });
    }
    showGame(true);

    let playerStarts = (lastWinner === null) ? Math.random() > 0.5 : (lastWinner === 'ia' ? false : true); 

    currentGameState = {
        board: savedBoard || Array(6).fill(0).map(() => Array(7).fill(0)),
        turn: 1, 
        p1: { 
            uid: playerStarts ? currentUser.uid : 'ia', 
            name: playerStarts ? myName : `IA (${aiLevel})`,
            color: playerStarts ? playerColor : aiColor 
        },
        p2: { 
            uid: !playerStarts ? currentUser.uid : 'ia', 
            name: !playerStarts ? myName : `IA (${aiLevel})`,
            color: !playerStarts ? playerColor : aiColor
        },
        status: 'playing',
        recorded: false
    };
    
    if (savedBoard) {
        const counts = savedBoard.flat().reduce((acc, val) => (val !== 0 ? acc + 1 : acc), 0);
        currentGameState.turn = (counts % 2 === 0) ? 1 : 2;
    }

    updateUI(currentGameState);
    const activePlayer = currentGameState.turn === 1 ? currentGameState.p1 : currentGameState.p2;
    if (activePlayer.uid === 'ia') setTimeout(() => makeAiMove(), 600);
};

async function playAiTurn(col) {
    if (!isAiGame || currentGameState.status !== 'playing') return;

    const myNum = currentGameState.p1.uid === currentUser.uid ? 1 : 2;
    if (currentGameState.turn !== myNum) return;

    let row = getFirstEmptyRow(col, currentGameState.board);
    if (row === -1) return; // Colonne pleine

    // 1. Coup du joueur
    applyMove(row, col, myNum);

    // 2. Coup de l'IA (s'il n'a pas gagnÃ©)
    if (currentGameState.status === 'playing') {
        setTimeout(() => makeAiMove(), 600);
    }
}

function makeAiMove() {
    if (currentGameState.status !== 'playing') return;
    const aiNum = currentGameState.p1.uid === 'ia' ? 1 : 2;
    
    let aiCol;
    if (aiLevel === 'hard') {
        // Profondeur 7 : analyse trÃ¨s profonde
        aiCol = minimax(currentGameState.board, 7, -Infinity, Infinity, true, aiNum).column;
    } else {
        aiCol = calculateBestMove(currentGameState.board, aiNum, 'easy');
    }
    
    const aiRow = getFirstEmptyRow(aiCol, currentGameState.board);
    if (aiRow !== -1) applyMove(aiRow, aiCol, aiNum);
}

function applyMove(row, col, playerNum) {
    lastMove = { r: row, c: col };
    currentGameState.board[row][col] = playerNum;

    // --- PRÃ‰PARATION DES DONNÃ‰ES DE SAUVEGARDE ---
    const sessionData = {
        board: currentGameState.board,
        isAiGame: isAiGame,
        playerColor: currentUserColor,
        aiLevel: aiLevel,
        currentRoom: currentRoom,
        timestamp: Date.now()
    };

    // --- SAUVEGARDE DE LA PARTIE EN COURS ---
    if (currentUser && !currentUser.uid.startsWith('guest')) {
        // Sauvegarde PROFIL (Firebase)
        update(ref(db, `users/${currentUser.uid}/games/p4/activeGame`), sessionData);
    } else {
        // Sauvegarde INVITÃ‰ (LocalStorage)
        localStorage.setItem('activeGamep4', JSON.stringify(sessionData));
    }

    // --- LOGIQUE DE VICTOIRE ET FIN DE PARTIE ---
    if (checkWin(row, col, currentGameState.board)) {
        currentGameState.status = 'finished';
        
        // DÃ©termination du gagnant (UID du joueur ou 'ia')
        const isPlayerP1 = currentGameState.p1.uid === currentUser.uid;
        const myNum = isPlayerP1 ? 1 : 2;
        currentGameState.winnerUid = (playerNum === myNum) ? currentUser.uid : 'ia';
        lastWinner = currentGameState.winnerUid; 

        // NETTOYAGE : La partie est finie, on supprime la sauvegarde
        if (currentUser.uid.startsWith('guest')) {
            localStorage.removeItem('activeGamep4');
        } else {
            remove(ref(db, `users/${currentUser.uid}/games/p4/activeGame`));
        }

    } else if (currentGameState.board[0].every(c => c !== 0)) {
        // CAS DE MATCH NUL
        currentGameState.status = 'draw';
        
        // NETTOYAGE
        if (currentUser.uid.startsWith('guest')) {
            localStorage.removeItem('activeGamep4');
        } else {
            remove(ref(db, `users/${currentUser.uid}/games/p4/activeGame`));
        }

    } else {
        // LA PARTIE CONTINUE : Changement de tour
        currentGameState.turn = currentGameState.turn === 1 ? 2 : 1;
    }

    updateUI(currentGameState);
}

function calculateBestMove(board, aiNum, level) {
    const playerNum = aiNum === 1 ? 2 : 1;
    const validCols = [];
    for (let c = 0; c < 7; c++) { 
        if (board[0][c] === 0) validCols.push(c); 
    }

    // --- LOGIQUE COMMUNE (MÃªme pour le mode Easy) ---
    // 1. Est-ce que l'IA peut gagner sur ce coup ?
    for (let c of validCols) {
        let r = getFirstEmptyRow(c, board);
        board[r][c] = aiNum;
        if (checkWin(r, c, board)) {
            board[r][c] = 0; // On remet Ã  vide
            return c; // On prend la victoire immÃ©diatement
        }
        board[r][c] = 0;
    }

    // 2. Est-ce que l'IA doit bloquer un Puissance 4 adverse ?
    for (let c of validCols) {
        let r = getFirstEmptyRow(c, board);
        board[r][c] = playerNum;
        if (checkWin(r, c, board)) {
            board[r][c] = 0;
            return c; // On bloque l'adversaire
        }
        board[r][c] = 0;
    }

    if (level === 'hard') {
        // Gagner
        for (let c of validCols) {
            let r = getFirstEmptyRow(c, board);
            board[r][c] = aiNum;
            if (checkWin(r, c, board)) { board[r][c] = 0; return c; }
            board[r][c] = 0;
        }
        // Bloquer
        for (let c of validCols) {
            let r = getFirstEmptyRow(c, board);
            board[r][c] = playerNum;
            if (checkWin(r, c, board)) { board[r][c] = 0; return c; }
            board[r][c] = 0;
        }
    }
    // Random (Facile ou rien de spÃ©cial en Difficile)
    return validCols[Math.floor(Math.random() * validCols.length)];
}

function getFirstEmptyRow(col, board) {
    for (let r = 5; r >= 0; r--) {
        if (board[r][col] === 0) return r;
    }
    return -1;
}

// --- JOUER UN JETON ---
window.dropToken = async (col) => {
    if (isAiGame) {
        return playAiTurn(col);
    }

    const roomRef = ref(db, `rooms/p4_${currentRoom}`);
    await runTransaction(roomRef, (game) => {
        if (!game || game.status !== 'playing') return;
        
        const myNum = game.p1.uid === currentUser.uid ? 1 : 2;
        if (game.turn !== myNum) return;

        let row = getFirstEmptyRow(col, game.board);
        if (row !== -1) {
            game.board[row][col] = myNum;
            lastMove = { r: row, c: col };
            if (checkWin(row, col, game.board)) {
                game.status = 'finished';
                game.winnerUid = currentUser.uid;
            } else if (game.board[0].every(c => c !== 0)) {
                game.status = 'draw';
            } else {
                game.turn = game.turn === 1 ? 2 : 1;
            }
        }
        return game;
    });
};

// --- MISE Ã€ JOUR INTERFACE ---
function updateUI(game) {
    if (!game || !game.board) return;

    const boardEl = document.getElementById('board');
    if (!boardEl) return;
    boardEl.innerHTML = '';
    
    const colorP1 = isAiGame ? game.p1.color : 'red';
    const colorP2 = isAiGame ? game.p2.color : 'yellow';

    // --- CORRECTION ICI ---
    // En mode IA, on utilise la variable locale 'lastMove'
    // En mode Multi, on utilise 'game.lastMove' qui vient de Firebase
    const moveToShow = isAiGame ? lastMove : game.lastMove;

    game.board.forEach((row, r) => {
        row.forEach((cell, c) => {
            const div = document.createElement('div');
            div.className = 'cell';
            
            if (cell === 1) div.classList.add(`color-${colorP1}`);
            if (cell === 2) div.classList.add(`color-${colorP2}`);

            // On compare avec moveToShow qui est synchronisÃ©
            if (moveToShow && moveToShow.r === r && moveToShow.c === c) {
                div.classList.add('anim-drop');
            }
            
            div.onclick = () => window.dropToken(c);
            boardEl.appendChild(div);
        });
    });

    const statusEl = document.getElementById('status-display');
    const turnEl = document.getElementById('turn-display');
    const modal = document.getElementById('modal-multi-end');
    const endMsg = document.getElementById('multi-end-msg');
    const endTitle = document.getElementById('multi-end-title');

    // Mises Ã  jour textuelles
    if (game.status === 'waiting') {
        if(statusEl) statusEl.innerText = "â³ En attente d'un adversaire...";
        if(turnEl) turnEl.innerText = "Code: " + currentRoom;
        // On cache la grille ou on affiche un message
        document.getElementById('board').classList.add('opacity-50')
    } else if (game.status === 'playing') {
        if(modal) modal.classList.add('hidden');
        const isMyTurn = (game.turn === 1 && game.p1.uid === currentUser.uid) || 
                         (game.turn === 2 && game.p2?.uid === currentUser.uid);
        
        if(statusEl) statusEl.innerText = isAiGame ? `Mode Solo (${aiLevel === 'hard' ? 'Difficile' : 'Facile'})` : `Salon : ${currentRoom}`;
        if(turnEl) {
            turnEl.innerText = isMyTurn ? "Ã€ VOUS DE JOUER !" : "Attente de l'adversaire...";
            turnEl.style.background = isMyTurn ? "#dff9fb" : "#eee";
        }
    } else if (game.status === 'finished' || game.status === 'draw') {
        const won = game.winnerUid === currentUser.uid;
        const typeStats = isAiGame ? `ia_${aiLevel}` : 'online';
        if (currentUser?.uid && !currentUser.uid.startsWith('guest')) {
            remove(ref(db, `users/${currentUser.uid}/games/p4/activeGame`));
        }
        if(turnEl) turnEl.innerText = game.status === 'draw' ? "Match nul !" : (won ? "ðŸ† VICTOIRE !" : "ðŸ’€ DÃ‰FAITE...");

        if (modal) {
            endTitle.innerText = game.status === 'draw' ? "Match Nul !" : (won ? "Victoire !" : "DÃ©faite");
            endMsg.innerText = game.status === 'draw' ? "Aucun vainqueur." : (won ? "Vous avez gagnÃ© cette manche." : "L'adversaire a Ã©tÃ© plus fort.");
            modal.classList.remove('hidden');
        }

        // Enregistrement des Stats en fin de partie (vÃ©rifie qu'il ne s'exÃ©cute qu'une fois)
        if (!game.recorded) {
            recordResult(game.status === 'draw' ? 'draw' : (won ? 'win' : 'loss'), typeStats);
            game.recorded = true;
            if (!isAiGame) {
                update(ref(db, `rooms/p4_${currentRoom}`), { recorded: true });
            }
        }
    } else if (game.status === 'aborted') {
        if(modal) {
            endTitle.innerText = "Partie annulÃ©e";
            endMsg.innerText = "L'adversaire a quittÃ© la partie.";
            document.getElementById('record-status').innerText = "";
            modal.classList.remove('hidden');
        }
    }
}

// --- REJOUER UNE MANCHE ---
window.resetWithChoice = (userStarts) => {
    document.getElementById('modal-multi-end').classList.add('hidden');
    lastMove = null;
    const playerColor = currentUserColor; 
    const aiColor = (playerColor === 'red' ? 'yellow' : 'red');

    currentGameState = {
        board: Array(6).fill(0).map(() => Array(7).fill(0)),
        turn: 1,
        p1: { 
            uid: userStarts ? currentUser.uid : 'ia', 
            name: userStarts ? myName : 'IA',
            color: userStarts ? playerColor : aiColor 
        },
        p2: { 
            uid: !userStarts ? currentUser.uid : 'ia', 
            name: !userStarts ? myName : 'IA',
            color: !userStarts ? playerColor : aiColor
        },
        status: 'playing',
        recorded: false
    };

    updateUI(currentGameState);
    if (!userStarts) setTimeout(() => makeAiMove(), 800);
};
window.resetCurrentGrid = async () => {
    const modal = document.getElementById('modal-multi-end');
    const loserArea = document.getElementById('loser-choice-area');
    const standardBtn = document.getElementById('btn-standard-reset');
    lastMove = null;
    if (isAiGame) {
        // En mode Solo, si le jeu est fini et qu'il n'y a pas eu de nul
        // On s'assure que l'utilisateur a les boutons de choix sous les yeux
        if (currentGameState.status === 'finished') {
            const won = currentGameState.winnerUid === currentUser.uid;
            
            if (!won) {
                // Si l'utilisateur a perdu, on ne ferme pas la modal, 
                // on force l'affichage du choix "Qui commence ?"
                if (loserArea) loserArea.classList.remove('hidden');
                if (standardBtn) standardBtn.classList.add('hidden');
                return; // On attend que l'utilisateur clique sur un des deux nouveaux boutons
            }
        }
        
        // Si c'Ã©tait un match nul ou que l'utilisateur a gagnÃ©, 
        // on reset normalement (l'IA commencera par dÃ©faut via la logique startAiGame)
        modal.classList.add('hidden');
        document.getElementById('record-status').innerText = "";
        window.startAiGame(currentUserColor);

    } else {
        // --- LOGIQUE MULTIJOUEUR (FIREBASE) ---
        modal.classList.add('hidden');
        document.getElementById('record-status').innerText = "";
        
        const roomRef = ref(db, `rooms/p4_${currentRoom}`);
        await update(roomRef, {
            board: Array(6).fill(0).map(() => Array(7).fill(0)),
            turn: 1,
            status: 'playing',
            recorded: false,
            winnerUid: null,
            lastMove: null
        });
    }
};

// --- LOGIQUE DE VICTOIRE ---
function checkWin(r, c, board) {
    const p = board[r][c];
    if (p === 0) return false;
    const directions = [[0,1],[1,0],[1,1],[1,-1]];
    for (let [dr, dc] of directions) {
        let count = 1;
        for (let i=1; i<=3; i++) {
            let nr=r+i*dr, nc=c+i*dc;
            if(nr<0||nr>=6||nc<0||nc>=7||board[nr][nc]!==p) break;
            count++;
        }
        for (let i=1; i<=3; i++) {
            let nr=r-i*dr, nc=c-i*dc;
            if(nr<0||nr>=6||nc<0||nc>=7||board[nr][nc]!==p) break;
            count++;
        }
        if(count >= 4) return true;
    }
    return false;
}
</script>
</body>

</html>
