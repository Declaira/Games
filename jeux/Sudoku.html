<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>ðŸ”¢ Sudoku</title>
  <link rel="icon" href="../logo/logo.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(135deg,#fff3cd,#ffe5b4,#ffd1d1,#ffc4e1);
      color: #2c3e50;
      display: flex;
      flex-direction: column; /* Aligne le header puis le container l'un sous l'autre */
      align-items: center;    /* Centre horizontalement le contenu du body */
      min-height: 100vh;
      touch-action: manipulation;
    }

    /* Assurez-vous que l'Ã©lÃ©ment header injectÃ© prend bien 100% de largeur */
    header {
      width: 100%;
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      box-sizing: border-box;
      flex-grow: 1; /* Permet au container de prendre l'espace restant */
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      width: 100%;
      justify-content: center;
      flex-wrap: wrap;
    }

    select, button {
      padding: 8px 12px;
      border-radius: 10px;
      border: 0;
      font-weight: 600;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    button { background: #ff6f00; color: #fff; }
    button:hover {
      background: #ff8f00;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    #noteBtn { background: #607d8b; min-width: 110px; }
    #noteBtn:hover { background: #78909c; }
    #noteBtn.active { background: #2196f3; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }

    #timer {
      background: #ffffff55;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 700;
    }

    .sudoku {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      width: 92vw;
      max-width: 450px;
      height: 92vw;
      max-height: 450px;
      background: rgba(255, 255, 255, 0.3);
      border: 2px solid #ffb347;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .cell {
      border: 1px solid rgba(255, 111, 0, 0.15);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.4);
    }

    .cell.prefilled { background: rgba(0, 0, 0, 0.08); }
    .cell.selected { background: rgba(255, 235, 59, 0.5) !important; outline: 3px solid #ff6f00; z-index: 2; }
    .cell.highlight-same { background-color: rgba(255, 160, 0, 0.3) !important; }
    .cell.error input { background-color: rgba(233, 30, 99, 0.3); color: #d32f2f; }

    .cell:nth-child(3n) { border-right: 2px solid #ffb347; }
    .cell:nth-child(9n) { border-right: 1px solid rgba(255, 111, 0, 0.15); }
    .cell:nth-child(n+19):nth-child(-n+27), 
    .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid #ffb347; }

    .cell input {
      width: 100%; height: 100%; text-align: center; border: 0;
      background: transparent; font-size: 1.6rem; font-weight: 700;
      pointer-events: none; color: #333;
    }

    .pencil-notes {
      position: absolute; inset: 0; display: grid;
      grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
      pointer-events: none; padding: 2px;
    }
    .pencil-notes span { font-size: 0.55rem; color: #607d8b; display: flex; align-items: center; justify-content: center; }

    .num-pad {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 15px;
      width: 100%;
      max-width: 450px;
    }

    .num-pad button {
      height: 55px;
      font-size: 1.3rem;
      background: #ff9a00;
      box-shadow: 0 4px 0 #e68a00;
      border-radius: 12px;
    }

    .num-pad button:hover { background: #ffb74d; transform: translateY(-2px); box-shadow: 0 6px 0 #e68a00; }
    .num-pad button:active { transform: translateY(2px); box-shadow: 0 1px 0 #e68a00; }
    .num-pad button.erase { background: #d9534f; box-shadow: 0 4px 0 #c9302c; }

    @media (max-width: 350px) {
      .cell input { font-size: 1.3rem; }
      .num-pad button { height: 48px; }
    }
  </style>
</head>
<body>
  <script src="../header.js"></script>
    <script>
      injectHeader({
        title: "Sudoku",
        homeLink: "../accueil.html",
        showHome: true
      });
    </script>
  </script>
  <div class="container">
    <div class="controls">
      <select id="difficulty">
        <option value="35">Facile</option>
        <option value="45" selected>Moyen</option>
        <option value="55">Difficile</option>
      </select>
      <button id="newBtn">Nouveau</button>
      <button id="noteBtn">âœŽ Note: OFF</button>
      <div id="timer">00:00</div>
    </div>

    <div id="sudoku" class="sudoku"></div>

    <div class="num-pad">
      <button data-num="1">1</button>
      <button data-num="2">2</button>
      <button data-num="3">3</button>
      <button data-num="4">4</button>
      <button data-num="5">5</button>
      <button data-num="6">6</button>
      <button data-num="7">7</button>
      <button data-num="8">8</button>
      <button data-num="9">9</button>
      <button data-num="0" class="erase"><img src="gomme.png" alt="Gomme" style="width:24px;height:24px;"></button>
    </div>
  </div>

<script>
let solution = [], puzzle = [], state = [], notes = [];
let selectedCell = null;
let isNoteMode = false;
let timerInterval, seconds = 0;

const gridEl = document.getElementById('sudoku');
const noteBtn = document.getElementById('noteBtn');

function initGame() {
  generateSudoku();
  renderGrid();
  startTimer();
}

function generateSudoku() {
  solution = Array.from({length:9}, () => Array(9).fill(0));
  fillGrid(solution);
  const emptyCells = parseInt(document.getElementById('difficulty').value);
  puzzle = solution.map(row => [...row]);
  let count = 0;
  while (count < emptyCells) {
    let r = Math.floor(Math.random()*9), c = Math.floor(Math.random()*9);
    if (puzzle[r][c] !== 0) { puzzle[r][c] = 0; count++; }
  }
  state = puzzle.map(row => [...row]);
  notes = Array.from({length:9}, () => Array.from({length:9}, () => new Set()));
}

function fillGrid(grid) {
  for (let i = 0; i < 81; i++) {
    let r = Math.floor(i/9), c = i%9;
    if (grid[r][c] === 0) {
      let nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
      for (let n of nums) {
        if (isValid(grid, r, c, n)) {
          grid[r][c] = n;
          if (fillGrid(grid)) return true;
          grid[r][c] = 0;
        }
      }
      return false;
    }
  }
  return true;
}

function isValid(grid, r, c, n) {
  for (let i = 0; i < 9; i++) if (grid[r][i] === n || grid[i][c] === n) return false;
  let br = Math.floor(r/3)*3, bc = Math.floor(c/3)*3;
  for (let i=0; i<3; i++) for (let j=0; j<3; j++) if (grid[br+i][bc+j] === n) return false;
  return true;
}

function renderGrid() {
  gridEl.innerHTML = '';
  for (let r=0; r<9; r++) for (let c=0; c<9; c++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    if (puzzle[r][c] !== 0) cell.classList.add('prefilled');
    cell.dataset.r = r; cell.dataset.c = c;
    const input = document.createElement('input');
    input.value = state[r][c] || '';
    const notesDiv = document.createElement('div');
    notesDiv.className = 'pencil-notes';
    cell.append(notesDiv, input);
    gridEl.appendChild(cell);
    cell.onclick = () => select(cell);
    cell.oncontextmenu = (e) => {
      e.preventDefault();
      isNoteMode = !isNoteMode;
      updateNoteUI();
      select(cell);
    };
    updateCellNotes(r, c, cell);
  }
}

function select(cell) {
  if(!cell) return;
  document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected', 'highlight-same'));
  selectedCell = cell;
  cell.classList.add('selected');
  const val = state[cell.dataset.r][cell.dataset.c];
  if (val) {
    document.querySelectorAll('.cell').forEach(c => {
      if (state[c.dataset.r][c.dataset.c] == val) c.classList.add('highlight-same');
    });
  }
}

function updateCellNotes(r, c, cell) {
  const notesDiv = cell.querySelector('.pencil-notes');
  notesDiv.innerHTML = '';
  if (state[r][c] === 0) {
    for (let i=1; i<=9; i++) {
      const span = document.createElement('span');
      span.textContent = notes[r][c].has(i) ? i : '';
      notesDiv.appendChild(span);
    }
  }
}

function handleInput(n) {
  if (!selectedCell) return;
  const r = parseInt(selectedCell.dataset.r), c = parseInt(selectedCell.dataset.c);
  if (puzzle[r][c] !== 0) return;

  if (isNoteMode && n !== 0) {
    if (notes[r][c].has(n)) notes[r][c].delete(n);
    else notes[r][c].add(n);
    state[r][c] = 0;
  } else {
    state[r][c] = n;
    notes[r][c].clear();
    if (n !== 0 && n !== solution[r][c]) selectedCell.classList.add('error');
    else selectedCell.classList.remove('error');
  }
  renderGrid();
  const newCell = document.querySelector(`[data-r="${r}"][data-c="${c}"]`);
  if(newCell) select(newCell);
  checkWin();
}

/* --- GESTION CLAVIER --- */
document.addEventListener('keydown', (e) => {
  if (!selectedCell) return;
  const r = parseInt(selectedCell.dataset.r);
  const c = parseInt(selectedCell.dataset.c);

  // Chiffres 1-9
  if (e.key >= '1' && e.key <= '9') {
    handleInput(parseInt(e.key));
  } 
  // Effacer (0, Backspace, Delete)
  else if (e.key === 'Backspace' || e.key === 'Delete' || e.key === '0') {
    handleInput(0);
  }
  // Navigation FlÃ¨ches
  else if (e.key.startsWith('Arrow')) {
    let nr = r, nc = c;
    if (e.key === 'ArrowUp') nr = Math.max(0, r - 1);
    if (e.key === 'ArrowDown') nr = Math.min(8, r + 1);
    if (e.key === 'ArrowLeft') nc = Math.max(0, c - 1);
    if (e.key === 'ArrowRight') nc = Math.min(8, c + 1);
    const target = document.querySelector(`[data-r="${nr}"][data-c="${nc}"]`);
    select(target);
  }
});

function updateNoteUI() {
  noteBtn.classList.toggle('active', isNoteMode);
  noteBtn.textContent = isNoteMode ? "âœŽ Note: ON" : "âœŽ Note: OFF";
}

noteBtn.onclick = () => { isNoteMode = !isNoteMode; updateNoteUI(); };
document.querySelectorAll('.num-pad button[data-num]').forEach(btn => {
  btn.onclick = () => handleInput(parseInt(btn.dataset.num));
});

function startTimer() {
  clearInterval(timerInterval);
  seconds = 0;
  timerInterval = setInterval(() => {
    seconds++;
    const m = Math.floor(seconds/60).toString().padStart(2,'0'), s = (seconds%60).toString().padStart(2,'0');
    document.getElementById('timer').textContent = `${m}:${s}`;
  }, 1000);
}

function checkWin() {
  let errors = document.querySelectorAll('.cell.error').length;
  let full = state.flat().every(v => v !== 0);
  if (full && errors === 0) { clearInterval(timerInterval); alert("Bravo !"); }
}

document.getElementById('newBtn').onclick = initGame;
initGame();
</script>
</body>
</html>