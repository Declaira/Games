<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>‚öì Bataille Navale</title>
    <link rel="icon" href="../logo/logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background: #0a192f; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: white; overflow-x: hidden; }
        header { width: 100%; flex-shrink: 0; }
        .status-box { margin: 10px; padding: 10px; background: rgba(100, 255, 218, 0.1); border-radius: 8px; text-align: center; width: 90%; max-width: 600px; border: 1px solid #64ffda33; min-height: 40px; font-size: 1.1em; }
        .main-game { display: flex; justify-content: center; gap: 30px; flex-wrap: nowrap; padding: 20px; align-items: flex-start; }
        .grid-container { display: flex; flex-direction: column; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(10, 32px); grid-template-rows: repeat(10, 32px); gap: 2px; background: #112240; padding: 5px; border: 2px solid #64ffda; }
        .cell { width: 32px; height: 32px; background: #233554; display: flex; align-items: center; justify-content: center; position: relative; transition: 0.2s; cursor: crosshair; }
        .cell.over { background: #64ffda44; }
        .attack-wrapper { display: flex; gap: 15px; align-items: flex-start; }
        .enemy-fleet-panel { background: #112240; padding: 15px; border-radius: 8px; border: 1px solid #64ffda55; min-width: 200px; }
        .enemy-fleet-panel h4 { margin-top: 0; color: #64ffda; border-bottom: 1px solid #64ffda33; padding-bottom: 5px; font-size: 0.9em; }
        .ship-indicator { font-size: 0.85em; margin: 8px 0; display: flex; align-items: center; gap: 10px; transition: 0.3s; padding: 5px; border-radius: 4px; border: 1px solid transparent; }
        .ship-indicator.sunk { color: #ff4757; text-decoration: line-through; opacity: 0.4; background: rgba(255, 71, 87, 0.1); border-color: #ff475755; }
        .dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .ship-s5 { background: #ff4757 !important; } 
        .ship-s4 { background: #2ed573 !important; } 
        .ship-s3a { background: #1e90ff !important; } 
        .ship-s3b { background: #ffa502 !important; } 
        .ship-s2 { background: #e056fd !important; } 
        .hit { background: #f44336 !important; animation: shake 0.3s; }
        .hit::after { content: "üí•"; font-size: 14px; }
        .miss { background: #1d2d44; }
        .miss::after { content: "‚Ä¢"; color: #64ffda; font-size: 20px; }
        #myGrid .cell[class*="ship-"] {
            cursor: pointer;
        }

        #myGrid .cell[class*="ship-"]:hover {
            filter: brightness(1.2);
            border: 1px solid white;
        }
        #dock { 
            display: flex; 
            flex-direction: column; 
            align-items: center; /* Centre les bateaux horizontalement */
            gap: 15px; 
            padding: 15px; 
            background: #112240; 
            border-radius: 10px; 
            border: 1px solid #64ffda33; 
        }
        /* Message d'aide dans le dock vide */
        #dock:empty::before {
            content: "Tous les navires sont d√©ploy√©s !";
            font-size: 0.9em;
            color: #2ed573;
            padding: 20px;
            text-align: center;
        }

        #dock::before {
            content: "üí° Cliquez sur un navire pos√© pour le retirer";
            display: block;
            width: 100%;
            font-size: 0.8em;
            color: #a8b2d1;
            margin-bottom: 10px;
            font-style: italic;
            order: -1; /* Place le texte en haut du dock */
        }
        .draggable-ship { 
            display: flex; 
            cursor: grab; 
            width: max-content; /* Force le bateau √† ne prendre que la largeur de ses cellules */
            margin: 5px auto;   /* Centre le bateau horizontalement dans le dock */
            gap: 0; 
        }

        /* Style quand le bateau est vertical */
        .draggable-ship.vertical { 
            flex-direction: column; 
            width: 32px; /* Doit correspondre √† la largeur d'une cellule de ta grille */
            align-items: center; 
        }

        /* Pour s'assurer que les cases √† l'int√©rieur ne s'√©crasent pas */
        .draggable-ship div { 
            width: 32px; 
            height: 32px; 
            flex-shrink: 0; /* Emp√™che le bateau de se d√©former */
            border: 1px solid rgba(255,255,255,0.2);
            box-sizing: border-box;
        }
        .draggable-ship:hover {
            outline: 2px dashed #64ffda;
            outline-offset: 5px;
        }

        /* On ajoute un petit texte d'aide au survol du dock */
        #dock:hover::after {
            content: "üí° Astuce : Utilisez la molette pour pivoter";
            display: block;
            font-size: 0.7em;
            color: #64ffda;
            margin-top: 10px;
            text-align: center;
        }
        input[type="text"] { background: #112240; border: 1px solid #64ffda; color: white; padding: 10px; border-radius: 5px; outline: none; text-align: center; font-weight: bold; }
        
        #win-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 25, 47, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center;}
        .win-title { font-size: 4em; color: #64ffda; text-shadow: 0 0 20px #64ffda; margin-bottom: 10px; }
        .lose-title { font-size: 4em; color: #ff4757; text-shadow: 0 0 20px #ff4757; margin-bottom: 10px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #64ffda; color: #0a192f; margin: 10px 5px; transition: 0.3s; font-size: 1rem; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); box-shadow: 0 0 15px rgba(100, 255, 218, 0.4); }
        .btn-multi { background: #9b59b6; color: white; }
        .btn-solo { background: #3498db; color: white; }
        .hidden { display: none !important; }
        @keyframes shake { 0%{transform:rotate(1deg)} 50%{transform:rotate(-1deg)} 100%{transform:rotate(0)} }
    </style>
</head>
<body>
    <script src="../header.js"></script>
    <script>
        if(typeof injectHeader === 'function') {
            injectHeader({ title: "‚öì Bataille Navale", homeLink: "../accueil.html", showHome: true });
        }
    </script>

<div id="win-screen">
    <h1 id="win-msg">VICTOIRE !</h1>
    <p id="win-sub" style="font-size: 1.2em; color: #a8b2d1;">La flotte adverse repose au fond de l'oc√©an.</p>
    <div id="record-status" style="margin: 15px 0; font-weight: bold; color: #2ed573; font-size: 1.2em;"></div>
    <div>
        <button class="btn" onclick="resetGame()">REJOUER</button>
        <button class="btn" onclick="location.reload();" style="background: #e74c3c; color: white;">QUITTER</button>
    </div>
</div>

<div id="mode-selection" style="margin: 40px auto; text-align: center; background: #112240; padding: 30px; border-radius: 15px; border: 1px solid #64ffda; width: 90%; max-width: 400px;">
    <h2 style="color: #64ffda; margin-top: 0;">Quartier G√©n√©ral</h2>
    
    <div style="margin: 20px 0;">
        <p style="margin-bottom: 10px; color: #a8b2d1;"><b>Combat en Ligne</b></p>
        <input type="text" id="roomInput" placeholder="Code Salon (ex: NAV1)" maxlength="6" style="text-transform: uppercase; width: 80%;">
        <br>
        <button class="btn btn-multi" onclick="joinRoom()" style="width: 85%;">üåê Rejoindre / Cr√©er Salon</button>
    </div>
    
    <hr style="border: 0; border-top: 1px solid #233554; margin: 25px 0;">
    
    <div>
        <p style="margin-bottom: 10px; color: #a8b2d1;"><b>Entra√Ænement Solo</b></p>
        <button class="btn btn-solo" onclick="prepareSolo()" style="width: 85%;">üë§ Jouer contre l'IA</button>
    </div>
</div>

<div class="status-box hidden" id="game-info">Initialisation des syst√®mes...</div>

<div class="main-game hidden" id="game-area">
    <div id="setup-area" style="text-align:center; min-width: 220px;">
        <h3 style="color: #64ffda;">Configuration</h3>
        <button class="btn" style="background:#ff9a00; color:white; padding: 8px 15px;" onclick="toggleRotation()">üîÑ Pivoter</button>
        <button class="btn" style="background:#1e90ff; color:white; padding: 8px 15px;" onclick="randomizeMyShips()">üé≤ Al√©atoire</button>
        <div id="dock" style="margin-top:10px;">
            <div class="draggable-ship ship-s5" draggable="true" id="s5" data-size="5"><div></div><div></div><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s4" draggable="true" id="s4" data-size="4"><div></div><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s3a" draggable="true" id="s3a" data-size="3"><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s3b" draggable="true" id="s3b" data-size="3"><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s2" draggable="true" id="s2" data-size="2"><div></div><div></div></div>
        </div>
        <button id="readyBtn" class="btn hidden" onclick="confirmPlacement()" style="background:#2ed573; margin-top:15px; width:100%;">LANCER L'ASSAUT</button>
    </div>

    <div class="grid-container">
        <h3 id="my-label" style="color: #64ffda;">MA FLOTTE</h3>
        <div id="myGrid" class="grid"></div>
    </div>

    <div class="grid-container">
        <h3 id="opp-label" style="color: #ff4757;">RADAR D'ATTAQUE</h3>
        <div class="attack-wrapper">
            <div id="oppGrid" class="grid"></div>
            <div class="enemy-fleet-panel">
                <h4>CIBLES ADVERSES</h4>
                <div id="ind-s5" class="ship-indicator"><div class="dot ship-s5"></div> Porte-avions (5)</div>
                <div id="ind-s4" class="ship-indicator"><div class="dot ship-s4"></div> Croiseur (4)</div>
                <div id="ind-s3a" class="ship-indicator"><div class="dot ship-s3a"></div> Sous-marin (3)</div>
                <div id="ind-s3b" class="ship-indicator"><div class="dot ship-s3b"></div> Contre-torpilleur (3)</div>
                <div id="ind-s2" class="ship-indicator"><div class="dot ship-s2"></div> Torpilleur (2)</div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, runTransaction, onDisconnect, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // --- CONFIGURATION FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyB29fMpTwBgsqkjijkNoQJ2kGChSeQDX_w",
        authDomain: "quiz-ea203.firebaseapp.com",
        databaseURL: "https://quiz-ea203-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "quiz-ea203",
        storageBucket: "quiz-ea203.firebasestorage.app",
        messagingSenderId: "605137421110",
        appId: "1:605137421110:web:289e0876fe06108deaa997"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // --- VARIABLES GLOBALES ---
    let currentUser = null;
    let isRestoring = false;
    let myName = "MA FLOTTE";
    let isAiGame = false;
    let currentRoom = null;
    let myId = null; 
    let opponentId = null;
    
    let isVertical = false;
    let draggedShip = null;
    let myShipsCoords = [];
    
    let gameState = { 
        p1Ready: false, p2Ready: false, 
        p1Attacks: [], p2Attacks: [], 
        turn: 'p1', winner: null, recorded: false 
    };

    // --- AUTHENTIFICATION & RESTAURATION ---
    onAuthStateChanged(auth, async (user) => {
        const savedUid = localStorage.getItem('active_uid');
        const uidToFetch = savedUid || (user ? user.uid : null);

        if (uidToFetch) {
            currentUser = user || { uid: uidToFetch };
            try {
                const userRef = ref(database, 'users/' + uidToFetch);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    myName = data.username || "Joueur";

                    // --- LOGIQUE DE REPRISE DE PARTIE ---
                    if (data.activeGame && !isRestoring) {
                        if (confirm("‚öì Une partie en cours a √©t√© trouv√©e. Voulez-vous la reprendre ?")) {
                            resumeGame(data.activeGame);
                        } else {
                            // Si l'utilisateur refuse, on efface la sauvegarde
                            remove(ref(database, `users/${uidToFetch}/activeGame`));
                        }
                    }
                }
            } catch (e) {
                console.error("‚ùå Erreur database:", e);
            }
        }

        const myLabel = document.getElementById('my-label');
        if (myLabel) myLabel.textContent = myName.toUpperCase();
    });

    // --- FONCTION DE REPRISE ---
    window.resumeGame = (data) => {
    isRestoring = true;
    isAiGame = data.isAiGame;
    currentRoom = data.currentRoom;
    myId = data.myId;
    opponentId = data.opponentId;
    myShipsCoords = data.myShipsCoords;
    gameState = data.gameState;

    document.getElementById('mode-selection').classList.add('hidden');
    document.getElementById('game-info').classList.remove('hidden');
    document.getElementById('game-area').classList.remove('hidden');
    document.getElementById('setup-area').classList.add('hidden');

    initBoard();
    restoreVisuals();
    
    if (!isAiGame && currentRoom) {
        // Logique Multi
        const roomRef = ref(database, `rooms/bn_${currentRoom}`);
        onValue(roomRef, (snapshot) => {
            const roomData = snapshot.val();
            if (roomData) {
                gameState = roomData;
                updateUI();
            }
        });
    }
    
    updateUI();
    isRestoring = false;

    // --- CORRECTION : Relancer l'IA si c'est son tour ---
    if (isAiGame && gameState.turn === 'p2' && !gameState.winner) {
        console.log("ü§ñ L'IA reprend son tour...");
        setTimeout(iaPlay, 1000); 
    }
};

    // --- GESTION DES STATISTIQUES ---
    async function recordResult(result, type) {
        if (!currentUser?.uid || currentUser.uid.startsWith('guest') || gameState.recorded) return;
        
        gameState.recorded = true; 
        const statsRef = ref(database, `users/${currentUser.uid}/games/bn/stats/${type}`);
        const snap = await get(statsRef);
        const data = snap.exists() ? snap.val() : { wins: 0, losses: 0, draws: 0 };

        if (result === 'win') data.wins++;
        else if (result === 'loss') data.losses++;

        await set(statsRef, data);
        
        const recordStatus = document.getElementById('record-status');
        if (recordStatus) {
            recordStatus.innerText = (result === 'win') ? "üìà Victoire enregistr√©e !" : "üìâ D√©faite enregistr√©e...";
        }
    }

    // --- INTERFACE ---
    window.toggleRotation = () => {
        isVertical = !isVertical;
        document.querySelectorAll('.draggable-ship').forEach(s => s.classList.toggle('vertical', isVertical));
    };

    window.prepareSolo = () => {
        isAiGame = true;
        myId = 'p1'; opponentId = 'p2';
        currentRoom = null;
        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('game-info').classList.remove('hidden');
        document.getElementById('game-area').classList.remove('hidden');
        document.getElementById('my-label').textContent = myName.toUpperCase();
        document.getElementById('opp-label').textContent = "IA ENNEMIE";
        initBoard();
    };

    window.joinRoom = async () => {
        const roomInput = document.getElementById('roomInput').value.trim().toUpperCase();
        if (!roomInput) return alert("Veuillez entrer un code de salon.");
        
        isAiGame = false;
        currentRoom = roomInput;
        const roomRef = ref(database, `rooms/bn_${currentRoom}`);

        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('game-info').classList.remove('hidden');

        await runTransaction(roomRef, (room) => {
            if (!room) {
                return {
                    p1: { uid: currentUser.uid, name: myName },
                    p2: null,
                    p1Ready: false, p2Ready: false,
                    p1Attacks: [], p2Attacks: [],
                    p1Ships: [], p2Ships: [],
                    turn: 'p1', winner: null, recorded: false
                };
            } else if (!room.p2 && room.p1.uid !== currentUser.uid) {
                room.p2 = { uid: currentUser.uid, name: myName };
                return room;
            }
            return; 
        });

        const snap = await get(roomRef);
        const data = snap.val();
        if (data.p1.uid === currentUser.uid) { myId = 'p1'; opponentId = 'p2'; }
        else if (data.p2?.uid === currentUser.uid) { myId = 'p2'; opponentId = 'p1'; }
        else { alert("Salon plein !"); location.reload(); return; }

        onDisconnect(roomRef).update({ winner: 'aborted' });
        document.getElementById('game-area').classList.remove('hidden');
        initBoard();

        onValue(roomRef, (snapshot) => {
            const roomData = snapshot.val();
            if (roomData) {
                gameState = roomData;
                if(roomData[opponentId]) {
                    document.getElementById('opp-label').textContent = roomData[opponentId].name.toUpperCase();
                }
                updateUI();
                checkSunk();
            }
        });
    };

    function initBoard() {
        const mG = document.getElementById('myGrid');
        const oG = document.getElementById('oppGrid');
        mG.innerHTML = ''; oG.innerHTML = '';
        
        for(let i = 0; i < 100; i++) {
            const cM = document.createElement('div'); 
            cM.className = 'cell';
            cM.ondragover = e => { e.preventDefault(); cM.classList.add('over'); };
            cM.ondragleave = () => cM.classList.remove('over');
            cM.ondrop = () => dropShip(i);
            cM.onclick = () => {
                const shipAtCoord = myShipsCoords.find(s => s.coords.includes(i));
                if (shipAtCoord && !gameState.p1Ready && !gameState.winner) {
                    window.removeShip(shipAtCoord.id);
                }
            };
            mG.appendChild(cM);
            
            const cO = document.createElement('div'); 
            cO.className = 'cell';
            cO.onclick = () => fire(i);
            oG.appendChild(cO);
        }
        
        if(isAiGame && !isRestoring) {
            gameState.p2Ships = generateIA();
        }
    }

    window.randomizeMyShips = () => {
    // 1. On commence par r√©initialiser le placement actuel
    myShipsCoords = [];
    const mCells = document.getElementById('myGrid').children;
    for (let cell of mCells) {
        cell.className = 'cell'; // On nettoie visuellement la grille
    }

    // 2. On utilise la logique de l'IA pour g√©n√©rer un placement valide
    const newShips = generateIA();
    
    // 3. On applique ce placement √† notre flotte
    newShips.forEach(ship => {
        myShipsCoords.push(ship);
        ship.coords.forEach(c => {
            mCells[c].classList.add('ship-' + ship.id);
        });
        
        // 4. On cache les bateaux dans le dock
        const dockShip = document.getElementById(ship.id);
        if (dockShip) dockShip.classList.add('hidden');
    });

    // 5. On affiche le bouton "LANCER L'ASSAUT"
    document.getElementById('readyBtn').classList.remove('hidden');
};

    window.removeShip = (shipId) => {
        const shipIndex = myShipsCoords.findIndex(s => s.id === shipId);
        if (shipIndex === -1) return;
        const coords = myShipsCoords[shipIndex].coords;
        const cells = document.getElementById('myGrid').children;
        coords.forEach(idx => cells[idx].className = 'cell');
        myShipsCoords.splice(shipIndex, 1);
        const shipElement = document.getElementById(shipId);
        if (shipElement) {
            shipElement.classList.remove('hidden');
            document.getElementById('dock').appendChild(shipElement);
        }
        document.getElementById('readyBtn').classList.add('hidden');
    };

    document.querySelectorAll('.draggable-ship').forEach(ship => {
        ship.ondragstart = () => draggedShip = ship;
        ship.onwheel = (e) => {
            e.preventDefault();
            isVertical = !isVertical;
            document.querySelectorAll('.draggable-ship').forEach(s => s.classList.toggle('vertical', isVertical));
        };
    });

    function dropShip(startIdx) {
        if(!draggedShip) return;
        const size = parseInt(draggedShip.dataset.size), id = draggedShip.id;
        let coords = [];
        for(let i=0; i<size; i++) {
            let next = isVertical ? startIdx + (i*10) : startIdx + i;
            if(next > 99 || (!isVertical && Math.floor(next/10) !== Math.floor(startIdx/10))) return;
            coords.push(next);
        }
        if(myShipsCoords.some(s => s.coords.some(c => coords.includes(c)))) return;
        myShipsCoords.push({id, coords});
        draggedShip.classList.add('hidden');
        coords.forEach(c => document.getElementById('myGrid').children[c].classList.add('ship-'+id));
        if(myShipsCoords.length === 5) document.getElementById('readyBtn').classList.remove('hidden');
    }

    function generateIA() {
        const s = [5,4,3,3,2], ids = ['s5','s4','s3a','s3b','s2'], res = [];
        s.forEach((sz, i) => {
            let ok = false;
            while(!ok) {
                let st = Math.floor(Math.random()*100), v = Math.random()>0.5, c = [];
                for(let j=0; j<sz; j++) c.push(v ? st+(j*10) : st+j);
                if(c.every(n => n<100 && (v || Math.floor(n/10)===Math.floor(st/10))) && !res.some(sh=>sh.coords.some(x=>c.includes(x)))) {
                    res.push({id: ids[i], coords: c}); ok = true;
                }
            }
        });
        return res;
    }

    window.confirmPlacement = () => {
        document.getElementById('setup-area').classList.add('hidden');
        if(isAiGame) {
            gameState.p1Ready = true; 
            gameState.p1Ships = myShipsCoords; 
            gameState.p2Ready = true;
            updateUI();
        } else {
            const updates = {};
            updates[`${myId}Ready`] = true;
            updates[`${myId}Ships`] = myShipsCoords;
            update(ref(database, `rooms/bn_${currentRoom}`), updates);
        }
    };

    window.fire = async (idx) => {
        if (!gameState.p1Ready || !gameState.p2Ready || gameState.winner) return;
        const myAttacksList = gameState[myId + 'Attacks'] || [];
        if (gameState.turn !== myId || myAttacksList.includes(idx)) return;

        const isHit = gameState[opponentId + 'Ships'].some(s => s.coords.includes(idx));
        const newAttacks = [...myAttacksList, idx];

        if (isAiGame) {
            gameState.p1Attacks = newAttacks;
            if (!isHit) {
                gameState.turn = 'p2';
                setTimeout(iaPlay, 800);
            }
            checkSunk();
            updateUI();
        } else {
            const updates = {};
            updates[`${myId}Attacks`] = newAttacks;
            if (!isHit) updates[`turn`] = opponentId;
            await update(ref(database, `rooms/bn_${currentRoom}`), updates);
        }
    };

    function iaPlay() {
        if(gameState.winner) return;
        let shot;
        const aiAttacks = gameState.p2Attacks || [];
        do { shot = Math.floor(Math.random()*100); } while(aiAttacks.includes(shot));
        gameState.p2Attacks.push(shot);
        const isHit = gameState.p1Ships.some(s => s.coords.includes(shot));
        checkSunk(); 
        updateUI();
        if(isHit && !gameState.winner) setTimeout(iaPlay, 800);
        else if (!gameState.winner) { gameState.turn = 'p1'; updateUI(); }
    }

    function checkSunk() {
        if (gameState.winner) return;
        const check = (player, opponent) => {
            const oppShips = gameState[opponent+'Ships'];
            if(!oppShips) return;
            let sunkCount = 0;
            const pAttacks = gameState[player+'Attacks'] || [];
            oppShips.forEach(s => {
                if(s.coords.every(c => pAttacks.includes(c))) {
                    sunkCount++;
                    if(player === myId) {
                        const ind = document.getElementById('ind-'+s.id);
                        if(ind) ind.classList.add('sunk');
                    }
                }
            });
            if(sunkCount === 5) { gameState.winner = player; handleWin(player); }
        };
        check('p1', 'p2'); check('p2', 'p1');
    }

    function handleWin(winner) {
        showWinScreen(winner);
        if (!gameState.recorded) {
            const typeStats = isAiGame ? 'ia' : 'online';
            const result = winner === myId ? 'win' : 'loss';
            recordResult(result, typeStats);
            if (!isAiGame && winner === myId) {
                update(ref(database, `rooms/bn_${currentRoom}`), { winner: winner, recorded: true });
            }
        }
    }

    function showWinScreen(winner) {
        document.getElementById('win-screen').style.display = 'flex';
        const msg = document.getElementById('win-msg');
        
        // SUPPRESSION DE LA SAUVEGARDE SUR FIREBASE
        if (currentUser && currentUser.uid) {
            remove(ref(database, `users/${currentUser.uid}/activeGame`));
        }

        if (winner === 'aborted') {
            msg.textContent = "ABANDON";
            return;
        }
        msg.textContent = (winner === myId) ? "VICTOIRE !" : "D√âFAITE...";
        msg.className = (winner === myId) ? "win-title" : "lose-title";
    }

    function updateUI() {
    const info = document.getElementById('game-info');
    if(gameState.winner) return;
    if (!gameState.p1Ready || !gameState.p2Ready) return;

    info.innerHTML = (gameState.turn === myId) ? "<b style='color:#64ffda;'>üéØ √Ä VOUS DE TIRER !</b>" : "<span style='color:#ff4757;'>üåä L'ENNEMI ATTAQUE...</span>";

    const mCells = document.getElementById('myGrid').children;
    const oCells = document.getElementById('oppGrid').children;
    const myAttacks = gameState[myId + 'Attacks'] || [];
    const oppAttacks = gameState[opponentId + 'Attacks'] || [];
    
    myAttacks.forEach(i => {
        const hit = gameState[opponentId + 'Ships']?.some(s=>s.coords.includes(i));
        oCells[i].classList.add(hit ? 'hit' : 'miss');
    });
    oppAttacks.forEach(i => {
        const hit = myShipsCoords.some(s=>s.coords.includes(i));
        mCells[i].classList.add(hit ? 'hit' : 'miss');
    });

    // --- SAUVEGARDE SUR FIREBASE (CORRIG√âE) ---
    if (currentUser && currentUser.uid && !gameState.winner && gameState.p1Ready) {
        const savePath = ref(database, `users/${currentUser.uid}/activeGame`);
        
        // On cr√©e l'objet de sauvegarde en s'assurant qu'aucune valeur n'est undefined
        const dataToSave = {
            isAiGame: isAiGame,
            currentRoom: currentRoom || null, // Si undefined, devient null (accept√© par Firebase)
            myId: myId || null,
            opponentId: opponentId || null,
            myShipsCoords: myShipsCoords,
            gameState: gameState,
            lastUpdate: Date.now()
        };

        set(savePath, dataToSave).catch(err => console.error("Erreur sauvegarde:", err));
    }
}

    function restoreVisuals() {
        const mCells = document.getElementById('myGrid').children;
        myShipsCoords.forEach(s => {
            s.coords.forEach(c => mCells[c].classList.add('ship-' + s.id));
        });
    }

    window.resetGame = async () => {
        document.getElementById('win-screen').style.display = 'none';
        myShipsCoords = [];
        document.getElementById('setup-area').classList.remove('hidden');
        document.querySelectorAll('.draggable-ship').forEach(s => { s.classList.remove('hidden', 'vertical'); });
        
        if (currentUser && currentUser.uid) {
            remove(ref(database, `users/${currentUser.uid}/activeGame`));
        }

        if (isAiGame) {
            gameState = { p1Ready: false, p2Ready: false, p1Attacks: [], p2Attacks: [], turn: 'p1', winner: null, recorded: false };
            initBoard();
        } else {
            const roomRef = ref(database, `rooms/bn_${currentRoom}`);
            await update(roomRef, { p1Ready: false, p2Ready: false, p1Ships: [], p2Ships: [], p1Attacks: [], p2Attacks: [], turn: 'p1', winner: null, recorded: false });
            initBoard();
        }
    };
</script>
</body>
</html>
