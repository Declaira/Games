<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>‚öì Bataille Navale</title>
    <link rel="icon" href="../logo/logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background: #0a192f; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: white; overflow-x: hidden; }
        header { width: 100%; flex-shrink: 0; }
        .status-box { margin: 10px; padding: 10px; background: rgba(100, 255, 218, 0.1); border-radius: 8px; text-align: center; width: 90%; max-width: 600px; border: 1px solid #64ffda33; min-height: 40px; font-size: 1.1em; }
        .main-game { display: flex; justify-content: center; gap: 30px; flex-wrap: nowrap; padding: 20px; align-items: flex-start; }
        .grid-container { display: flex; flex-direction: column; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(10, 32px); grid-template-rows: repeat(10, 32px); gap: 2px; background: #112240; padding: 5px; border: 2px solid #64ffda; }
        .cell { width: 32px; height: 32px; background: #233554; display: flex; align-items: center; justify-content: center; position: relative; transition: 0.2s; cursor: crosshair; }
        .cell.over { background: #64ffda44; }
        .attack-wrapper { display: flex; gap: 15px; align-items: flex-start; }
        .enemy-fleet-panel { background: #112240; padding: 15px; border-radius: 8px; border: 1px solid #64ffda55; min-width: 200px; }
        .enemy-fleet-panel h4 { margin-top: 0; color: #64ffda; border-bottom: 1px solid #64ffda33; padding-bottom: 5px; font-size: 0.9em; }
        .ship-indicator { font-size: 0.85em; margin: 8px 0; display: flex; align-items: center; gap: 10px; transition: 0.3s; padding: 5px; border-radius: 4px; border: 1px solid transparent; }
        .ship-indicator.sunk { color: #ff4757; text-decoration: line-through; opacity: 0.4; background: rgba(255, 71, 87, 0.1); border-color: #ff475755; }
        .dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .ship-s5 { background: #ff4757 !important; } 
        .ship-s4 { background: #2ed573 !important; } 
        .ship-s3a { background: #1e90ff !important; } 
        .ship-s3b { background: #ffa502 !important; } 
        .ship-s2 { background: #e056fd !important; } 
        .hit { background: #f44336 !important; animation: shake 0.3s; }
        .hit::after { content: "üí•"; font-size: 14px; }
        .miss { background: #1d2d44; }
        .miss::after { content: "‚Ä¢"; color: #64ffda; font-size: 20px; }
        #myGrid .cell[class*="ship-"] {
            cursor: pointer;
        }

        #myGrid .cell[class*="ship-"]:hover {
            filter: brightness(1.2);
            border: 1px solid white;
        }
        #dock { 
            display: flex; 
            flex-direction: column; 
            align-items: center; /* Centre les bateaux horizontalement */
            gap: 15px; 
            padding: 15px; 
            background: #112240; 
            border-radius: 10px; 
            border: 1px solid #64ffda33; 
        }
        .draggable-ship { 
            display: flex; 
            cursor: grab; 
            width: max-content; /* Force le bateau √† ne prendre que la largeur de ses cellules */
            margin: 5px auto;   /* Centre le bateau horizontalement dans le dock */
            gap: 0; 
        }

        /* Style quand le bateau est vertical */
        .draggable-ship.vertical { 
            flex-direction: column; 
            width: 32px; /* Doit correspondre √† la largeur d'une cellule de ta grille */
            align-items: center; 
        }

        /* Pour s'assurer que les cases √† l'int√©rieur ne s'√©crasent pas */
        .draggable-ship div { 
            width: 32px; 
            height: 32px; 
            flex-shrink: 0; /* Emp√™che le bateau de se d√©former */
            border: 1px solid rgba(255,255,255,0.2);
            box-sizing: border-box;
        }
        .draggable-ship:hover {
            outline: 2px dashed #64ffda;
            outline-offset: 5px;
        }

        /* On ajoute un petit texte d'aide au survol du dock */
        #dock:hover::after {
            content: "üí° Astuce : Utilisez la molette pour pivoter";
            display: block;
            font-size: 0.7em;
            color: #64ffda;
            margin-top: 10px;
            text-align: center;
        }
        input[type="text"] { background: #112240; border: 1px solid #64ffda; color: white; padding: 10px; border-radius: 5px; outline: none; text-align: center; font-weight: bold; }
        
        #win-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 25, 47, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center;}
        .win-title { font-size: 4em; color: #64ffda; text-shadow: 0 0 20px #64ffda; margin-bottom: 10px; }
        .lose-title { font-size: 4em; color: #ff4757; text-shadow: 0 0 20px #ff4757; margin-bottom: 10px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #64ffda; color: #0a192f; margin: 10px 5px; transition: 0.3s; font-size: 1rem; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); box-shadow: 0 0 15px rgba(100, 255, 218, 0.4); }
        .btn-multi { background: #9b59b6; color: white; }
        .btn-solo { background: #3498db; color: white; }
        .hidden { display: none !important; }
        @keyframes shake { 0%{transform:rotate(1deg)} 50%{transform:rotate(-1deg)} 100%{transform:rotate(0)} }
    </style>
</head>
<body>
    <script src="../header.js"></script>
    <script>
        if(typeof injectHeader === 'function') {
            injectHeader({ title: "‚öì Bataille Navale", homeLink: "../accueil.html", showHome: true });
        }
    </script>

<div id="win-screen">
    <h1 id="win-msg">VICTOIRE !</h1>
    <p id="win-sub" style="font-size: 1.2em; color: #a8b2d1;">La flotte adverse repose au fond de l'oc√©an.</p>
    <div id="record-status" style="margin: 15px 0; font-weight: bold; color: #2ed573; font-size: 1.2em;"></div>
    <div>
        <button class="btn" onclick="resetGame()">REJOUER</button>
        <button class="btn" onclick="location.reload()" style="background: #e74c3c; color: white;">QUITTER</button>
    </div>
</div>

<div id="mode-selection" style="margin: 40px auto; text-align: center; background: #112240; padding: 30px; border-radius: 15px; border: 1px solid #64ffda; width: 90%; max-width: 400px;">
    <h2 style="color: #64ffda; margin-top: 0;">Quartier G√©n√©ral</h2>
    
    <div style="margin: 20px 0;">
        <p style="margin-bottom: 10px; color: #a8b2d1;"><b>Combat en Ligne</b></p>
        <input type="text" id="roomInput" placeholder="Code Salon (ex: NAV1)" maxlength="6" style="text-transform: uppercase; width: 80%;">
        <br>
        <button class="btn btn-multi" onclick="joinRoom()" style="width: 85%;">üåê Rejoindre / Cr√©er Salon</button>
    </div>
    
    <hr style="border: 0; border-top: 1px solid #233554; margin: 25px 0;">
    
    <div>
        <p style="margin-bottom: 10px; color: #a8b2d1;"><b>Entra√Ænement Solo</b></p>
        <button class="btn btn-solo" onclick="prepareSolo()" style="width: 85%;">üë§ Jouer contre l'IA</button>
    </div>
</div>

<div class="status-box hidden" id="game-info">Initialisation des syst√®mes...</div>

<div class="main-game hidden" id="game-area">
    <div id="setup-area" style="text-align:center; min-width: 220px;">
        <h3 style="color: #64ffda;">Configuration</h3>
        <button class="btn" style="background:#ff9a00; color:white; padding: 8px 15px;" onclick="toggleRotation()">üîÑ Pivoter</button>
        <button class="btn" style="background:#1e90ff; color:white; padding: 8px 15px;" onclick="randomizeMyShips()">üé≤ Al√©atoire</button>
        <div id="dock" style="margin-top:10px;">
            <div class="draggable-ship ship-s5" draggable="true" id="s5" data-size="5"><div></div><div></div><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s4" draggable="true" id="s4" data-size="4"><div></div><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s3a" draggable="true" id="s3a" data-size="3"><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s3b" draggable="true" id="s3b" data-size="3"><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s2" draggable="true" id="s2" data-size="2"><div></div><div></div></div>
        </div>
        <button id="readyBtn" class="btn hidden" onclick="confirmPlacement()" style="background:#2ed573; margin-top:15px; width:100%;">LANCER L'ASSAUT</button>
    </div>

    <div class="grid-container">
        <h3 id="my-label" style="color: #64ffda;">MA FLOTTE</h3>
        <div id="myGrid" class="grid"></div>
    </div>

    <div class="grid-container">
        <h3 id="opp-label" style="color: #ff4757;">RADAR D'ATTAQUE</h3>
        <div class="attack-wrapper">
            <div id="oppGrid" class="grid"></div>
            <div class="enemy-fleet-panel">
                <h4>CIBLES ADVERSES</h4>
                <div id="ind-s5" class="ship-indicator"><div class="dot ship-s5"></div> Porte-avions (5)</div>
                <div id="ind-s4" class="ship-indicator"><div class="dot ship-s4"></div> Croiseur (4)</div>
                <div id="ind-s3a" class="ship-indicator"><div class="dot ship-s3a"></div> Sous-marin (3)</div>
                <div id="ind-s3b" class="ship-indicator"><div class="dot ship-s3b"></div> Contre-torpilleur (3)</div>
                <div id="ind-s2" class="ship-indicator"><div class="dot ship-s2"></div> Torpilleur (2)</div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, runTransaction, onDisconnect, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // --- CONFIGURATION FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyB29fMpTwBgsqkjijkNoQJ2kGChSeQDX_w",
        authDomain: "quiz-ea203.firebaseapp.com",
        databaseURL: "https://quiz-ea203-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "quiz-ea203",
        storageBucket: "quiz-ea203.firebasestorage.app",
        messagingSenderId: "605137421110",
        appId: "1:605137421110:web:289e0876fe06108deaa997"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // --- VARIABLES GLOBALES ---
    let currentUser = null;
    let myName = "Amiral";
    let isAiGame = false;
    let currentRoom = null;
    let myId = null; 
    let opponentId = null;
    
    let isVertical = false;
    let draggedShip = null;
    let myShipsCoords = [];
    
    let gameState = { 
        p1Ready: false, p2Ready: false, 
        p1Attacks: [], p2Attacks: [], 
        turn: 'p1', winner: null, recorded: false 
    };

    // --- AUTHENTIFICATION ---
    onAuthStateChanged(auth, (user) => {
        currentUser = user || { uid: localStorage.getItem('active_uid') || 'guest_' + Math.floor(Math.random()*1000) };
        myName = user?.displayName || "MA FLOTTE";
    });

    // --- GESTION DES STATISTIQUES ---
    async function recordResult(result, type) {
        if (!currentUser?.uid || currentUser.uid.startsWith('guest') || gameState.recorded) return;
        
        gameState.recorded = true; // S√©curit√© locale
        const statsRef = ref(database, `users/${currentUser.uid}/games/bn/stats/${type}`);
        const snap = await get(statsRef);
        const data = snap.exists() ? snap.val() : { wins: 0, losses: 0, draws: 0 };

        if (result === 'win') data.wins++;
        else if (result === 'loss') data.losses++;

        await set(statsRef, data);
        
        // Affichage dans la modal de victoire
        const recordStatus = document.getElementById('record-status');
        if (recordStatus) {
            if (result === 'win') recordStatus.innerText = "üìà Victoire enregistr√©e ! (+1 Win)";
            else if (result === 'loss') recordStatus.innerText = "üìâ D√©faite enregistr√©e...";
        }
    }

    // --- EXPOSITION DES FONCTIONS UI ---
    window.toggleRotation = () => {
        isVertical = !isVertical;
        document.querySelectorAll('.draggable-ship').forEach(s => s.classList.toggle('vertical', isVertical));
    };

    // --- MODE SOLO ---
    window.prepareSolo = () => {
        isAiGame = true;
        myId = 'p1'; opponentId = 'p2';
        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('game-info').classList.remove('hidden');
        document.getElementById('game-area').classList.remove('hidden');
        document.getElementById('my-label').textContent = myName.toUpperCase();
        document.getElementById('opp-label').textContent = "IA ENNEMIE";
        document.getElementById('game-info').textContent = "Placez vos navires strat√©giquement.";
        initBoard();
    };

    // --- MODE MULTIJOUEUR ---
    window.joinRoom = async () => {
        const roomInput = document.getElementById('roomInput').value.trim().toUpperCase();
        if (!roomInput) return alert("Veuillez entrer un code de salon.");
        
        isAiGame = false;
        currentRoom = roomInput;
        const roomRef = ref(database, `rooms/bn_${currentRoom}`);

        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('game-info').classList.remove('hidden');
        document.getElementById('game-info').textContent = "Connexion au salon...";

        await runTransaction(roomRef, (room) => {
            if (!room) {
                // Cr√©er le salon (Je suis p1)
                return {
                    p1: { uid: currentUser.uid, name: myName },
                    p2: null,
                    p1Ready: false, p2Ready: false,
                    p1Attacks: [], p2Attacks: [],
                    p1Ships: [], p2Ships: [],
                    turn: 'p1', winner: null, recorded: false
                };
            } else if (!room.p2 && room.p1.uid !== currentUser.uid) {
                // Rejoindre (Je suis p2)
                room.p2 = { uid: currentUser.uid, name: myName };
                return room;
            }
            return; // Salon plein ou d√©j√† rejoint
        });

        // D√©terminer mon ID apr√®s la transaction
        const snap = await get(roomRef);
        const data = snap.val();
        if (data.p1.uid === currentUser.uid) { myId = 'p1'; opponentId = 'p2'; }
        else if (data.p2?.uid === currentUser.uid) { myId = 'p2'; opponentId = 'p1'; }
        else { alert("Le salon est plein !"); location.reload(); return; }

        onDisconnect(roomRef).update({ winner: 'aborted' });

        document.getElementById('game-area').classList.remove('hidden');
        document.getElementById('my-label').textContent = myName.toUpperCase();
        document.getElementById('game-info').textContent = "Placez vos navires !";
        initBoard();

        // √âcoute des changements de la salle
        onValue(roomRef, (snapshot) => {
            const roomData = snapshot.val();
            if (roomData) {
                gameState = roomData;
                if(roomData[opponentId]) {
                    document.getElementById('opp-label').textContent = roomData[opponentId].name.toUpperCase();
                }
                updateUI();
                checkSunk();
            }
        });
    };

    // --- INITIALISATION DU PLATEAU ---
    function initBoard() {
        const mG = document.getElementById('myGrid');
        const oG = document.getElementById('oppGrid');
        
        // Nettoyage complet des grilles HTML
        mG.innerHTML = ''; 
        oG.innerHTML = '';
        
        // Reset visuel des indicateurs de destruction (panneau de droite)
        const indicators = ['s5', 's4', 's3a', 's3b', 's2'];
        indicators.forEach(id => {
            const el = document.getElementById('ind-' + id);
            if(el) el.classList.remove('sunk');
        });

        // Cr√©ation des 100 cases pour chaque grille
        for(let i = 0; i < 100; i++) {
            // --- 1. MA GRILLE (Placement et d√©fense) ---
            const cM = document.createElement('div'); 
            cM.className = 'cell';
            
            // Gestion du Drag & Drop pour poser les bateaux
            cM.ondragover = e => { e.preventDefault(); cM.classList.add('over'); };
            cM.ondragleave = () => cM.classList.remove('over');
            cM.ondrop = () => dropShip(i);

            // CLIC POUR RETIRER UN BATEAU :
            // Permet de cliquer sur un bateau d√©j√† pos√© pour le renvoyer dans le dock
            cM.onclick = (e) => {
                e.stopPropagation();
                // On v√©rifie si un bateau est pr√©sent sur cette case
                const shipAtCoord = myShipsCoords.find(s => s.coords.includes(i));
                
                // On n'autorise le retrait que si la partie n'est pas encore lanc√©e
                // On v√©rifie gameState.p1Ready (pour le multi) et gameState.winner (pour l'IA/Fin de partie)
                if (shipAtCoord && !gameState.p1Ready && !gameState.winner) {
                    window.removeShip(shipAtCoord.id);
                }
            };

            mG.appendChild(cM);
            
            // --- 2. GRILLE ADVERSE (Radar d'attaque) ---
            const cO = document.createElement('div'); 
            cO.className = 'cell';
            
            // Clic pour tirer
            cO.onclick = () => fire(i);
            
            oG.appendChild(cO);
        }
        
        // Si c'est une partie contre l'ordinateur, on g√©n√®re sa flotte
        if(isAiGame) {
            gameState.p2Ships = generateIA();
        }
    }
    // --- PLACEMENT DES BATEAUX ---
    window.removeShip = (shipId) => {
        // 1. Trouver l'index du bateau
        const shipIndex = myShipsCoords.findIndex(s => s.id === shipId);
        if (shipIndex === -1) return;

        // 2. R√©cup√©rer les coordonn√©es et nettoyer visuellement la grille
        const coords = myShipsCoords[shipIndex].coords;
        const cells = document.getElementById('myGrid').children;
        
        coords.forEach(idx => {
            // On retire TOUTES les classes qui commencent par 'ship-' sur ces cases
            cells[idx].className = 'cell'; 
        });

        // 3. Supprimer du tableau de donn√©es AVANT de faire quoi que ce soit d'autre
        myShipsCoords.splice(shipIndex, 1);

        // 4. R√©afficher le bateau original dans le dock
        const shipElement = document.getElementById(shipId);
        if (shipElement) {
            shipElement.classList.remove('hidden');
            shipElement.style.display = 'flex'; // Force l'affichage
        }

        // 5. Cacher le bouton de validation
        document.getElementById('readyBtn').classList.add('hidden');
    };

    window.randomizeMyShips = () => {
        myShipsCoords = [];
        const cells = document.getElementById('myGrid').children;
        for(let c of cells) c.className = 'cell'; // Reset visual
        document.querySelectorAll('.draggable-ship').forEach(s => s.classList.add('hidden'));
        
        const shipsToPlace = [{id:'s5', size:5}, {id:'s4', size:4}, {id:'s3a', size:3}, {id:'s3b', size:3}, {id:'s2', size:2}];
        shipsToPlace.forEach(ship => {
            let placed = false;
            while(!placed) {
                let start = Math.floor(Math.random()*100), vert = Math.random() > 0.5, coords = [];
                for(let i=0; i<ship.size; i++) {
                    let next = vert ? start + (i*10) : start + i;
                    if(next > 99 || (!vert && Math.floor(next/10) !== Math.floor(start/10))) break;
                    coords.push(next);
                }
                if(coords.length === ship.size && !myShipsCoords.some(s => s.coords.some(c => coords.includes(c)))) {
                    myShipsCoords.push({id: ship.id, coords: coords});
                    coords.forEach(c => cells[c].classList.add('ship-' + ship.id));
                    placed = true;
                }
            }
        });
        document.getElementById('readyBtn').classList.remove('hidden');
    };

   document.querySelectorAll('.draggable-ship').forEach(ship => {
        // Garde en m√©moire quel bateau est tra√Æn√©
        ship.ondragstart = () => draggedShip = ship;

        // Ajout de la rotation √† la molette
        ship.onwheel = (e) => {
            e.preventDefault(); // Emp√™che le d√©filement de la page
            
            // On change l'√©tat global de rotation
            isVertical = !isVertical;
            
            // On applique visuellement √† tous les bateaux du dock
            document.querySelectorAll('.draggable-ship').forEach(s => {
                s.classList.toggle('vertical', isVertical);
            });
            
            // Optionnel : Petit effet visuel pour montrer que √ßa a chang√©
            ship.style.transition = "0.2s";
            ship.style.transform = "scale(1.1)";
            setTimeout(() => ship.style.transform = "scale(1)", 200);
        };
    });

    function dropShip(startIdx) {
        if(!draggedShip) return;
        const size = parseInt(draggedShip.dataset.size), id = draggedShip.id;
        let coords = [];
        for(let i=0; i<size; i++) {
            let next = isVertical ? startIdx + (i*10) : startIdx + i;
            if(next > 99 || (!isVertical && Math.floor(next/10) !== Math.floor(startIdx/10))) return;
            coords.push(next);
        }
        if(myShipsCoords.some(s => s.coords.some(c => coords.includes(c)))) return;
        
        myShipsCoords.push({id, coords});
        draggedShip.classList.add('hidden');
        coords.forEach(c => document.getElementById('myGrid').children[c].classList.add('ship-'+id));
        if(myShipsCoords.length === 5) document.getElementById('readyBtn').classList.remove('hidden');
    }

    function generateIA() {
        const s = [5,4,3,3,2], ids = ['s5','s4','s3a','s3b','s2'], res = [];
        s.forEach((sz, i) => {
            let ok = false;
            while(!ok) {
                let st = Math.floor(Math.random()*100), v = Math.random()>0.5, c = [];
                for(let j=0; j<sz; j++) c.push(v ? st+(j*10) : st+j);
                if(c.every(n => n<100 && (v || Math.floor(n/10)===Math.floor(st/10))) && !res.some(sh=>sh.coords.some(x=>c.includes(x)))) {
                    res.push({id: ids[i], coords: c}); ok = true;
                }
            }
        });
        return res;
    }

    // --- CONFIRMATION ET LANCEMENT ---
    window.confirmPlacement = () => {
        document.getElementById('setup-area').classList.add('hidden');
        
        if(isAiGame) {
            gameState.p1Ready = true; 
            gameState.p1Ships = myShipsCoords; 
            gameState.p2Ready = true;
            updateUI();
        } else {
            document.getElementById('game-info').textContent = "Attente du joueur adverse...";
            const updates = {};
            updates[`${myId}Ready`] = true;
            updates[`${myId}Ships`] = myShipsCoords;
            if (!gameState.p1Attacks) updates[`p1Attacks`] = [];
            if (!gameState.p2Attacks) updates[`p2Attacks`] = [];
            update(ref(database, `rooms/bn_${currentRoom}`), updates);
        }
    };

    // --- MECANIQUE DE TIR ---
    window.fire = async (idx) => {
        if (!gameState.p1Ready || !gameState.p2Ready || gameState.winner) return;
        
        const myAttacksList = gameState[myId + 'Attacks'] || [];
        if (gameState.turn !== myId || myAttacksList.includes(idx)) return; // Pas mon tour ou d√©j√† tir√©

        const isHit = gameState[opponentId + 'Ships'].some(s => s.coords.includes(idx));
        const newAttacks = [...myAttacksList, idx];

        if (isAiGame) {
            gameState.p1Attacks = newAttacks;
            if (!isHit) {
                gameState.turn = 'p2';
                setTimeout(iaPlay, 800);
            }
            checkSunk();
            updateUI();
        } else {
            // Mise √† jour Firebase pour le multijoueur
            const roomRef = ref(database, `rooms/bn_${currentRoom}`);
            const updates = {};
            updates[`${myId}Attacks`] = newAttacks;
            if (!isHit) updates[`turn`] = opponentId;
            await update(roomRef, updates);
        }
    };

    function iaPlay() {
        if(gameState.winner) return;
        let shot;
        const aiAttacks = gameState.p2Attacks || [];
        do { shot = Math.floor(Math.random()*100); } while(aiAttacks.includes(shot));
        
        gameState.p2Attacks.push(shot);
        const isHit = gameState.p1Ships.some(s => s.coords.includes(shot));
        
        checkSunk(); 
        updateUI();
        
        if(isHit && !gameState.winner) {
            setTimeout(iaPlay, 800); // L'IA rejoue si elle touche
        } else if (!gameState.winner) {
            gameState.turn = 'p1';
            updateUI();
        }
    }

    // --- VERIFICATION DES DESTRUCTIONS ---
    function checkSunk() {
        if (gameState.winner) return;

        const check = (player, opponent) => {
            const oppShips = gameState[opponent+'Ships'];
            if(!oppShips) return;
            
            let sunkCount = 0;
            const pAttacks = gameState[player+'Attacks'] || [];
            
            oppShips.forEach(s => {
                const isSunk = s.coords.every(c => pAttacks.includes(c));
                if(isSunk) {
                    sunkCount++;
                    // Barrer le nom du bateau dans l'UI adverse si je suis le joueur
                    if(player === myId) {
                        const ind = document.getElementById('ind-'+s.id);
                        if(ind) ind.classList.add('sunk');
                    }
                }
            });
            
            if(sunkCount === 5) {
                gameState.winner = player;
                handleWin(player);
            }
        };
        
        check('p1', 'p2');
        if(!gameState.winner) check('p2', 'p1');
    }

    function handleWin(winner) {
        showWinScreen(winner);
        
        // G√©rer l'enregistrement DB
        if (!gameState.recorded) {
            const typeStats = isAiGame ? 'ia' : 'online';
            const result = winner === myId ? 'win' : 'loss';
            recordResult(result, typeStats);
            gameState.recorded = true;
            
            if (!isAiGame && winner === myId) {
                update(ref(database, `rooms/bn_${currentRoom}`), { winner: winner, recorded: true });
            }
        }
    }

    function showWinScreen(winner) {
        const screen = document.getElementById('win-screen');
        screen.style.display = 'flex';
        const msg = document.getElementById('win-msg');
        const sub = document.getElementById('win-sub');
        
        if (winner === 'aborted') {
            msg.textContent = "ABANDON";
            msg.className = "lose-title";
            sub.textContent = "L'adversaire a fui le champ de bataille.";
            document.getElementById('record-status').innerText = "";
            return;
        }

        const isMe = winner === myId;
        if(isMe) { 
            msg.textContent = "VICTOIRE !"; 
            msg.className = "win-title"; 
            sub.textContent = "La flotte adverse repose au fond de l'oc√©an.";
        } else { 
            msg.textContent = "D√âFAITE..."; 
            msg.className = "lose-title"; 
            sub.textContent = "Votre flotte a √©t√© d√©cim√©e.";
        }
    }

    // --- MISE √Ä JOUR VISUELLE ---
    function updateUI() {
        const info = document.getElementById('game-info');
        if(gameState.winner) return;
        
        if (!gameState.p1Ready || !gameState.p2Ready) {
            info.textContent = isAiGame ? "Placez vos navires strat√©giquement." : "Attente que les deux joueurs soient pr√™ts...";
            return;
        }

        const isMyTurn = gameState.turn === myId;
        info.innerHTML = isMyTurn ? "<b style='color:#64ffda;'>üéØ √Ä VOUS DE TIRER !</b>" : "<span style='color:#ff4757;'>üåä L'ENNEMI ATTAQUE...</span>";

        const mCells = document.getElementById('myGrid').children;
        const oCells = document.getElementById('oppGrid').children;
        const myAttacks = gameState[myId + 'Attacks'] || [];
        const oppAttacks = gameState[opponentId + 'Attacks'] || [];
        
        // Afficher mes attaques sur la grille adverse
        myAttacks.forEach(i => {
            const hit = gameState[opponentId + 'Ships'] && gameState[opponentId + 'Ships'].some(s=>s.coords.includes(i));
            oCells[i].classList.add(hit ? 'hit' : 'miss');
        });
        
        // Afficher les attaques adverses sur ma grille
        oppAttacks.forEach(i => {
            const hit = myShipsCoords.some(s=>s.coords.includes(i));
            mCells[i].classList.add(hit ? 'hit' : 'miss');
        });
    }

    window.resetGame = async () => {
    // Cacher l'√©cran de victoire
    document.getElementById('win-screen').style.display = 'none';
    document.getElementById('record-status').innerText = "";
    
    // R√©initialiser les variables de placement
    myShipsCoords = [];
    draggedShip = null;
    
    // R√©initialiser l'interface de pr√©paration
    document.getElementById('setup-area').classList.remove('hidden');
    document.getElementById('readyBtn').classList.add('hidden');
    document.getElementById('game-info').textContent = "Red√©ploiement de la flotte...";
    
    // R√©afficher les bateaux dans le dock
    document.querySelectorAll('.draggable-ship').forEach(s => {
        s.classList.remove('hidden');
        s.classList.remove('vertical');
    });
    isVertical = false;

    if (isAiGame) {
        // --- RESET LOGIQUE IA ---
        gameState = { 
            p1Ready: false, p2Ready: false, 
            p1Attacks: [], p2Attacks: [], 
            turn: 'p1', winner: null, recorded: false 
        };
        initBoard(); // Relance les grilles vides et g√©n√®re une nouvelle IA
    } else {
        // --- RESET LOGIQUE MULTIJOUEUR (FIREBASE) ---
        const roomRef = ref(database, `rooms/bn_${currentRoom}`);
        
        // On remet √† z√©ro les donn√©es de combat mais on garde les noms des joueurs
        await update(roomRef, {
            p1Ready: false,
            p2Ready: false,
            p1Ships: [],
            p2Ships: [],
            p1Attacks: [],
            p2Attacks: [],
            turn: 'p1',
            winner: null,
            recorded: false
        });
        
        initBoard();
    }
};

</script>
</body>
</html>