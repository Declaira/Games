<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>‚öì Bataille Navale</title>
    <link rel="icon" href="./logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet">
    <style>
        /* --- STYLES (Conserv√©s √† l'identique) --- */
        body { font-family: 'Quicksand', sans-serif; background: #0a192f; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: white; overflow-x: hidden; }
        header { width: 100%; flex-shrink: 0; }
        .status-box { margin: 10px; padding: 10px; background: rgba(100, 255, 218, 0.1); border-radius: 8px; text-align: center; width: 90%; max-width: 600px; border: 1px solid #64ffda33; min-height: 40px; font-size: 1.1em; }
        .main-game { display: flex; justify-content: center; gap: 30px; flex-wrap: nowrap; padding: 20px; align-items: flex-start; }
        .grid-container { display: flex; flex-direction: column; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(10, 32px); grid-template-rows: repeat(10, 32px); gap: 2px; background: #112240; padding: 5px; border: 2px solid #64ffda; }
        .cell { width: 32px; height: 32px; background: #233554; display: flex; align-items: center; justify-content: center; position: relative; transition: 0.2s; cursor: crosshair; }
        .cell.over { background: #64ffda44; }
        .attack-wrapper { display: flex; gap: 15px; align-items: flex-start; }
        .enemy-fleet-panel { background: #112240; padding: 15px; border-radius: 8px; border: 1px solid #64ffda55; min-width: 200px; }
        .enemy-fleet-panel h4 { margin-top: 0; color: #64ffda; border-bottom: 1px solid #64ffda33; padding-bottom: 5px; font-size: 0.9em; }
        .ship-indicator { font-size: 0.85em; margin: 8px 0; display: flex; align-items: center; gap: 10px; transition: 0.3s; padding: 5px; border-radius: 4px; border: 1px solid transparent; }
        .ship-indicator.sunk { color: #ff4757; text-decoration: line-through; opacity: 0.4; background: rgba(255, 71, 87, 0.1); border-color: #ff475755; }
        .dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .ship-s5 { background: #ff4757 !important; } 
        .ship-s4 { background: #2ed573 !important; } 
        .ship-s3a { background: #1e90ff !important; } 
        .ship-s3b { background: #ffa502 !important; } 
        .ship-s2 { background: #e056fd !important; } 
        .hit { background: #f44336 !important; animation: shake 0.3s; }
        .hit::after { content: "üí•"; font-size: 14px; }
        .miss { background: #1d2d44; }
        .miss::after { content: "‚Ä¢"; color: #64ffda; font-size: 20px; }
        #dock { display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 15px; background: #112240; border-radius: 10px; border: 1px solid #64ffda33; }
        .draggable-ship { display: flex; cursor: grab; width: max-content; margin: 5px auto; gap: 0; }
        .draggable-ship.vertical { flex-direction: column; width: 32px; align-items: center; }
        .draggable-ship div { width: 32px; height: 32px; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.2); box-sizing: border-box; }
        .quit-button {
            margin-top: auto; /* Pousse le bouton vers le bas si le panel a une hauteur fixe */
            margin-top: 20px; /* Espace minimal avec les bateaux */
            width: 100%;      /* Optionnel : pour qu'il fasse la largeur du panel */
            padding: 10px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .quit-button:hover {
            background-color: #ff6b81;
            transform: translateY(-2px);
        }
        input[type="text"] { background: #112240; border: 1px solid #64ffda; color: white; padding: 10px; border-radius: 5px; outline: none; text-align: center; font-weight: bold; }
       /* --- Bouton de base --- */
        .btn { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            background: #64ffda; 
            color: #0a192f; 
            margin: 10px 5px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Transition fluide */
            font-size: 1rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* --- Effet Hover g√©n√©ral (√âl√©vation + Ombre) --- */
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.3);
            filter: brightness(1.1); /* √âclaircit l√©g√®rement la couleur actuelle */
        }

        /* --- Effet au clic (Enfoncement) --- */
        .btn:active {
            transform: translateY(-1px);
        }

        /* --- Overrides sp√©cifiques pour les boutons de victoire/d√©faite --- */
        .btn-multi:hover { background: #ae70c7; } /* Violet plus clair */
        .btn-solo:hover { background: #4aa3df; }  /* Bleu plus clair */

        #win-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(10, 25, 47, 0.98); 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 10000; 
            text-align: center;
        }

        .win-title { font-size: 4em; color: #64ffda; text-shadow: 0 0 20px #64ffda; margin-bottom: 10px; }
        .lose-title { font-size: 4em; color: #ff4757; text-shadow: 0 0 20px #ff4757; margin-bottom: 10px; }

        .btn { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            background: #64ffda; 
            color: #0a192f; 
            margin: 10px 5px; 
            transition: 0.3s; 
            font-size: 1rem; 
        }

        /* Effet Hover Global */
        .btn:hover { 
            transform: scale(1.1); 
            filter: brightness(1.2); 
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.4); 
        }

        /* Couleur sp√©cifique Quitter */
        .btn-quit {
            background: #e74c3c !important;
            color: white !important;
        }
        .btn-quit:hover {
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.5) !important;
        }
        @keyframes shake { 0%{transform:rotate(1deg)} 50%{transform:rotate(-1deg)} 100%{transform:rotate(0)} }
    </style>
</head>
<body>
    <script src="../header.js"></script>
    <script>
        if(typeof injectHeader === 'function') {
            injectHeader({ title: "‚öì Bataille Navale", homeLink: "../accueil.html", showHome: true });
        }
    </script>

    <div id="win-screen">
        <h1 id="win-msg">VICTOIRE !</h1>
        <p id="win-sub" style="font-size: 1.2em; color: #a8b2d1; max-width: 500px; line-height: 1.5;">La flotte adverse repose au fond de l'oc√©an.</p>
        <div id="record-status" style="margin: 15px 0; font-weight: bold; color: #2ed573; font-size: 1.2em;"></div>
        <div>
            <button class="btn" onclick="resetGame()">REJOUER</button>
            <button class="btn btn-quit" onclick="location.reload();">QUITTER</button>
        </div>
    </div>

<div id="mode-selection" style="margin: 40px auto; text-align: center; background: #112240; padding: 30px; border-radius: 15px; border: 1px solid #64ffda; width: 90%; max-width: 400px;">
    <h2 style="color: #64ffda; margin-top: 0;">Quartier G√©n√©ral</h2>
    <div style="margin: 20px 0;">
        <p style="margin-bottom: 10px; color: #a8b2d1;"><b>Combat en Ligne</b></p>
        <input type="text" id="roomInput" placeholder="Code Salon (ex: NAV1)" maxlength="6" style="text-transform: uppercase; width: 80%;">
        <br>
        <button id="btnMulti" class="btn btn-multi" onclick="joinRoom()" style="width: 85%;">üåê Rejoindre / Cr√©er Salon</button>
    </div>
    <hr style="border: 0; border-top: 1px solid #233554; margin: 25px 0;">
    <div>
        <p style="margin-bottom: 10px; color: #a8b2d1;"><b>Entra√Ænement Solo</b></p>
        <button id="btnSolo" class="btn btn-solo" onclick="prepareSolo()" style="width: 85%;">üë§ Jouer contre l'IA</button>
    </div>
</div>

<div class="status-box hidden" id="game-info">Initialisation des syst√®mes...</div>

<div class="main-game hidden" id="game-area">
    <div id="setup-area" style="text-align:center; min-width: 220px;">
        <h3 style="color: #64ffda;">Configuration</h3>
        <button class="btn" style="background:#ff9a00; color:white; padding: 8px 15px;" onclick="toggleRotation()">üîÑ Pivoter</button>
        <button class="btn" style="background:#1e90ff; color:white; padding: 8px 15px;" onclick="randomizeMyShips()">üé≤ Al√©atoire</button>
        <div id="dock" style="margin-top:10px;">
            <div class="draggable-ship ship-s5" draggable="true" id="s5" data-size="5"><div></div><div></div><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s4" draggable="true" id="s4" data-size="4"><div></div><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s3a" draggable="true" id="s3a" data-size="3"><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s3b" draggable="true" id="s3b" data-size="3"><div></div><div></div><div></div></div>
            <div class="draggable-ship ship-s2" draggable="true" id="s2" data-size="2"><div></div><div></div></div>
        </div>
        <button id="readyBtn" class="btn hidden" onclick="confirmPlacement()" style="background:#2ed573; margin-top:15px; width:100%;">LANCER L'ASSAUT</button>
    </div>

    <div class="grid-container">
        <h3 id="my-label" style="color: #64ffda;">MA FLOTTE</h3>
        <div id="myGrid" class="grid"></div>
    </div>

    
    <div class="grid-container">
    <h3 id="opp-label" style="color: #ff4757;">RADAR D'ATTAQUE</h3>
    <div class="attack-wrapper">
        <div id="oppGrid" class="grid"></div>

        <div class="enemy-fleet-panel">
            <h4>CIBLES ADVERSES</h4>
            <div id="ind-s5" class="ship-indicator"><div class="dot ship-s5"></div> Porte-avions (5)</div>
            <div id="ind-s4" class="ship-indicator"><div class="dot ship-s4"></div> Croiseur (4)</div>
            <div id="ind-s3a" class="ship-indicator"><div class="dot ship-s3a"></div> Sous-marin (3)</div>
            <div id="ind-s3b" class="ship-indicator"><div class="dot ship-s3b"></div> Contre-torpilleur (3)</div>
            <div id="ind-s2" class="ship-indicator"><div class="dot ship-s2"></div> Torpilleur (2)</div>

            <button id="quit-btn" class="quit-button" onclick="quitGame()">Quitter la partie</button>
        </div>
    </div>
</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, runTransaction, onDisconnect, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB29fMpTwBgsqkjijkNoQJ2kGChSeQDX_w",
        authDomain: "quiz-ea203.firebaseapp.com",
        databaseURL: "https://quiz-ea203-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "quiz-ea203",
        storageBucket: "quiz-ea203.firebasestorage.app",
        messagingSenderId: "605137421110",
        appId: "1:605137421110:web:289e0876fe06108deaa997"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    let currentUser = null;
    let isRestoring = false;
    let myName = "MA FLOTTE";
    let isAiGame = false;
    let currentRoom = null;
    let myId = null; 
    let opponentId = null;
    let isVertical = false;
    let draggedShip = null;
    let myShipsCoords = [];
    
    let gameState = { 
        p1Ready: false, p2Ready: false, 
        p1Attacks: [], p2Attacks: [], 
        turn: 'p1', winner: null, recorded: false 
    };

    // --- AUTHENTIFICATION ---
    onAuthStateChanged(auth, async (user) => {
    console.log("--- DEBUG AUTH BATAILLE NAVALE ---");
    const savedUid = localStorage.getItem('active_uid');
    const savedName = localStorage.getItem('guest_name');

    if (savedUid) {
        // --- MODE PROFIL CONNECT√â ---
        console.log("üìù Profil d√©tect√© (UID):", savedUid);
        currentUser = user || { uid: savedUid }; // On simule currentUser si Firebase n'est pas encore pr√™t
        
        const userRef = ref(database, 'users/' + savedUid);
        const snap = await get(userRef);
        
        if (snap.exists()) {
            const userData = snap.val();
            myName = userData.username || "Joueur";
            console.log("Donn√©es Firebase charg√©es pour:", myName);

            if (userData.games.bn.activeGame && !isRestoring) {
                console.log("üíæ Partie Cloud trouv√©e.");
                if (confirm("‚öì Une partie en cours a √©t√© trouv√©e. Reprendre ?")) {
                    resumeGame(userData.games.bn.activeGame);
                } else {
                    remove(ref(database, `users/${savedUid}/games/bn/activeGame`));
                }
            }
        }
    } else {
        // --- MODE INVIT√â ---
        console.log("üïπÔ∏è Mode Invit√© : Utilisation du stockage local");
        currentUser = { uid: 'guest_local', isAnonymous: true };
        myName = savedName || "Invit√©";

        const localSave = localStorage.getItem('guest_activeGame');
        if (localSave && !isRestoring) {
            console.log("üíæ Sauvegarde locale trouv√©e pour l'invit√©.");
            const data = JSON.parse(localSave);
            
            // Petit d√©lai pour s'assurer que le DOM est charg√©
            setTimeout(() => {
                if (confirm("‚öì (Invit√©) Reprendre votre bataille en cours ?")) {
                    console.log("Restauraton locale en cours...");
                    resumeGame(data);
                } else {
                    localStorage.removeItem('guest_activeGame');
                }
            }, 200);
        } else {
            console.log("Aucune sauvegarde locale trouv√©e.");
        }
    }

    if (document.getElementById('my-label')) {
        document.getElementById('my-label').textContent = myName.toUpperCase();
    }
    console.log("-----------------------------------");
});
    
    // --- JOIN ROOM (CORRIG√â & S√âCURIS√â) ---
    window.joinRoom = async () => {
        if (!currentUser) return alert("Initialisation en cours...");

        const roomInputEl = document.getElementById('roomInput');
        const roomInput = roomInputEl ? roomInputEl.value.trim().toUpperCase() : "";
        if (!roomInput) return alert("Veuillez entrer un code.");
        
        isAiGame = false;
        currentRoom = roomInput;
        const roomRef = ref(database, `rooms/bn_${currentRoom}`);

        // On cache le menu et montre l'info
        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('game-info').classList.remove('hidden');

        try {
            await runTransaction(roomRef, (room) => {
                if (!room) {
                    return {
                        p1: { uid: currentUser.uid, name: myName },
                        p2: null,
                        p1Ready: false, p2Ready: false,
                        p1Attacks: [], p2Attacks: [],
                        p1Ships: [], p2Ships: [],
                        turn: 'p1', winner: null, recorded: false
                    };
                } else if (!room.p2 && room.p1.uid !== currentUser.uid) {
                    room.p2 = { uid: currentUser.uid, name: myName };
                    return room;
                }
                return room; 
            });

            const snap = await get(roomRef);
            const data = snap.val();
            if (data.p1.uid === currentUser.uid) { myId = 'p1'; opponentId = 'p2'; }
            else if (data.p2?.uid === currentUser.uid) { myId = 'p2'; opponentId = 'p1'; }
            else { alert("Salon plein !"); location.reload(); return; }

            onDisconnect(roomRef).update({ winner: 'aborted' });
            document.getElementById('game-area').classList.remove('hidden');
            initBoard();

            onValue(roomRef, (snapshot) => {
                const roomData = snapshot.val();
                if (roomData) {
                    gameState = roomData;
                    if(roomData[opponentId]) {
                        document.getElementById('opp-label').textContent = roomData[opponentId].name.toUpperCase();
                    }
                    updateUI();
                    checkSunk();
                }
            });
        } catch (e) {
            console.error(e);
            alert("Erreur salon.");
        }
    };

    // --- UPDATE UI & SESSION SAVE (IGNORE LES INVIT√âS) ---
    function updateUI() {
        const info = document.getElementById('game-info');
        if(gameState.winner) return;
        if (!gameState.p1Ready || !gameState.p2Ready) {
            info.innerHTML = "‚åõ En attente du d√©ploiement de l'adversaire...";
            return;
        }

        info.innerHTML = (gameState.turn === myId) ? "<b style='color:#64ffda;'>üéØ √Ä VOUS DE TIRER !</b>" : "<span style='color:#ff4757;'>üåä L'ENNEMI ATTAQUE...</span>";

        const mCells = document.getElementById('myGrid').children;
        const oCells = document.getElementById('oppGrid').children;
        const myAttacks = gameState[myId + 'Attacks'] || [];
        const oppAttacks = gameState[opponentId + 'Attacks'] || [];
        
        myAttacks.forEach(i => {
            const hit = gameState[opponentId + 'Ships']?.some(s=>s.coords.includes(i));
            oCells[i].classList.add(hit ? 'hit' : 'miss');
        });
        oppAttacks.forEach(i => {
            const hit = myShipsCoords.some(s=>s.coords.includes(i));
            mCells[i].classList.add(hit ? 'hit' : 'miss');
        });

        if (currentUser) {
            // S√©curisation des donn√©es : on remplace undefined par null
            const dataToSave = {
                isAiGame: isAiGame || false,
                currentRoom: currentRoom || null, // <--- C'est ici que √ßa plantait
                myId: myId || null,
                opponentId: opponentId || null,
                myShipsCoords: myShipsCoords || [],
                gameState: gameState, 
                lastUpdate: Date.now()
            };

            const savedUid = localStorage.getItem('active_uid');
            if (savedUid && !savedUid.startsWith('guest')) {
                // Sauvegarde Cloud pour les profils
                // On utilise l'UID propre de l'utilisateur pour √©viter les erreurs de chemin
                set(ref(database, `users/${savedUid}/games/bn/activeGame`), dataToSave)
                    .catch(err => console.error("Erreur sauvegarde Firebase:", err));
            } else {
                // Sauvegarde Locale pour les invit√©s
                localStorage.setItem('guest_activeGame', JSON.stringify(dataToSave));
            }
        }
    }

    window.quitGame = async () => {
        if (!confirm("‚ö†Ô∏è Voulez-vous vraiment abandonner et quitter la partie en cours ?")) return;

        console.log("Fin de partie demand√©e...");

        // 1. Nettoyage Firebase pour les profils connect√©s
        const savedUid = localStorage.getItem('active_uid');
        if (savedUid && !savedUid.startsWith('guest')) {
            try {
                await remove(ref(database, `users/${savedUid}/games/bn/activeGame`));
                console.log("Sauvegarde Cloud supprim√©e.");
            } catch (e) {
                console.error("Erreur lors de la suppression Cloud:", e);
            }
        }

        // 2. Nettoyage LocalStorage pour les invit√©s
        localStorage.removeItem('guest_activeGame');
        console.log("Sauvegarde locale supprim√©e.");

        // 3. R√©initialisation des variables de jeu
        myShipsCoords = [];
        gameState = { 
            p1Ready: false, p2Ready: false, 
            p1Attacks: [], p2Attacks: [], 
            turn: 'p1', winner: null, recorded: false 
        };

        // 4. Retour au menu (rechargement de la page)
        location.reload();
    };

    // --- RESET & WIN (CLEANUP SESSION) ---
    window.resetGame = async () => {
        document.getElementById('win-screen').style.display = 'none';
        myShipsCoords = [];
        
        // Suppression session (r√©el uniquement)
        if (currentUser && !currentUser.uid.startsWith('guest')) {
            remove(ref(database, `users/${currentUser.uid}/games/bn/activeGame`));
        }

        document.getElementById('setup-area').classList.remove('hidden');
        document.querySelectorAll('.draggable-ship').forEach(s => { s.classList.remove('hidden', 'vertical'); });
        
        if (isAiGame) {
            gameState = { p1Ready: false, p2Ready: false, p1Attacks: [], p2Attacks: [], turn: 'p1', winner: null, recorded: false };
            initBoard();
        } else {
            const roomRef = ref(database, `rooms/bn_${currentRoom}`);
            await update(roomRef, { p1Ready: false, p2Ready: false, p1Ships: [], p2Ships: [], p1Attacks: [], p2Attacks: [], turn: 'p1', winner: null, recorded: false });
            initBoard();
        }
        if (currentUser && currentUser.uid.startsWith('guest')) {
            localStorage.removeItem('guest_activeGame');
        }
    };

    async function showWinScreen(winner) {
        const winScreen = document.getElementById('win-screen');
        const msg = document.getElementById('win-msg');
        const sub = document.getElementById('win-sub');
        const status = document.getElementById('record-status');
        
        // 1. Affichage de l'√©cran
        winScreen.style.display = 'flex';

        // 2. Nettoyage imm√©diat de la partie active (Firebase / Local)
        const savedUid = localStorage.getItem('active_uid');
        if (savedUid && !savedUid.startsWith('guest')) {
            remove(ref(database, `users/${savedUid}/games/bn/activeGame`));
        } else {
            localStorage.removeItem('guest_activeGame');
        }

        // 3. Gestion du texte Victoire / D√©faite
        if (winner === 'aborted') {
            msg.textContent = "ABANDON";
            msg.className = "lose-title";
            sub.textContent = "La partie a √©t√© interrompue.";
            return;
        }

        const isWin = (winner === myId);
        msg.textContent = isWin ? "VICTOIRE !" : "D√âFAITE...";
        msg.className = isWin ? "win-title" : "lose-title";

        // 4. Enregistrement et Calcul des Statistiques
        if (savedUid && !savedUid.startsWith('guest')) {
            const type = isAiGame ? 'ia' : 'online';
            const statsRef = ref(database, `users/${savedUid}/games/bn/stats/${type}`);
            
            // On enregistre le r√©sultat (incr√©mente jou√©es et victoires)
            await recordResult(isWin ? 'win' : 'loss', type);

            // On r√©cup√®re les nouvelles stats pour afficher le winrate
            const snap = await get(statsRef);
            if (snap.exists()) {
                const data = snap.val();
                const played = data.played || 0;
                const wins = data.wins || 0;
                const winrate = ((wins / played) * 100).toFixed(1);

                sub.innerHTML = `Mode ${type.toUpperCase()}<br>üìä Stats : ${wins} Victoires / ${played} Parties<br>üéØ Winrate : ${winrate}%`;
            }
        } else {
            sub.innerHTML = "La flotte adverse est coul√©e.<br><small>(Stats non enregistr√©es en mode Invit√©)</small>";
        }
    }

    // Fonction de support pour enregistrer proprement
    async function recordResult(result, type) {
        if (gameState.recorded) return; // √âvite les doubles enregistrements
        gameState.recorded = true;

        const savedUid = localStorage.getItem('active_uid');
        const statsRef = ref(database, `users/${savedUid}/games/bn/stats/${type}`);

        await runTransaction(statsRef, (current) => {
            if (!current) {
                return { wins: (result === 'win' ? 1 : 0), played: 1 };
            }
            return {
                wins: (current.wins || 0) + (result === 'win' ? 1 : 0),
                played: (current.played || 0) + 1
            };
        });
    }

    // --- AUTRES FONCTIONS (DUPLIQU√âES / INCHANG√âES POUR LE FONCTIONNEMENT) ---
    window.resumeGame = (data) => {
        isRestoring = true; 
        isAiGame = data.isAiGame || false; 
        currentRoom = data.currentRoom || null;
        myId = data.myId || 'p1'; 
        opponentId = data.opponentId || 'p2'; 
        myShipsCoords = data.myShipsCoords || []; 
        gameState = data.gameState || gameState;

        // Affichage des sections
        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('game-info').classList.remove('hidden');
        document.getElementById('game-area').classList.remove('hidden');
        document.getElementById('setup-area').classList.add('hidden');

        initBoard(); 
        restoreVisuals(); // <--- Crucial pour voir ses bateaux !

        if (!isAiGame && currentRoom) {
            onValue(ref(database, `rooms/bn_${currentRoom}`), (snapshot) => {
                if (snapshot.exists()) { 
                    gameState = snapshot.val(); 
                    updateUI(); 
                }
            });
        }
        
        updateUI(); 
        isRestoring = false;

        if (isAiGame && gameState.turn === 'p2' && !gameState.winner) {
            setTimeout(iaPlay, 1000);
        }
    };

    function initBoard() {
        const mG = document.getElementById('myGrid'); const oG = document.getElementById('oppGrid');
        mG.innerHTML = ''; oG.innerHTML = '';
        for(let i = 0; i < 100; i++) {
            const cM = document.createElement('div'); cM.className = 'cell';
            cM.ondragover = e => { e.preventDefault(); cM.classList.add('over'); };
            cM.ondragleave = () => cM.classList.remove('over');
            cM.ondrop = () => dropShip(i);
            cM.onclick = () => { if (myShipsCoords.find(s => s.coords.includes(i)) && !gameState.p1Ready) window.removeShip(myShipsCoords.find(s => s.coords.includes(i)).id); };
            mG.appendChild(cM);
            const cO = document.createElement('div'); cO.className = 'cell';
            cO.onclick = () => fire(i); oG.appendChild(cO);
        }
        if(isAiGame && !isRestoring) gameState.p2Ships = generateIA();
    }

    window.toggleRotation = () => { isVertical = !isVertical; document.querySelectorAll('.draggable-ship').forEach(s => s.classList.toggle('vertical', isVertical)); };
    window.prepareSolo = () => { isAiGame = true; myId = 'p1'; opponentId = 'p2'; currentRoom = null; document.getElementById('mode-selection').classList.add('hidden'); document.getElementById('game-info').classList.remove('hidden'); document.getElementById('game-area').classList.remove('hidden'); document.getElementById('opp-label').textContent = "IA ENNEMIE"; initBoard(); };
    window.randomizeMyShips = () => {
        myShipsCoords = []; const mCells = document.getElementById('myGrid').children;
        for (let cell of mCells) cell.className = 'cell';
        const newShips = generateIA();
        newShips.forEach(ship => {
            myShipsCoords.push(ship); ship.coords.forEach(c => mCells[c].classList.add('ship-' + ship.id));
            const dockShip = document.getElementById(ship.id); if (dockShip) dockShip.classList.add('hidden');
        });
        document.getElementById('readyBtn').classList.remove('hidden');
    };

    window.removeShip = (shipId) => {
        const idx = myShipsCoords.findIndex(s => s.id === shipId); if (idx === -1) return;
        const coords = myShipsCoords[idx].coords; const cells = document.getElementById('myGrid').children;
        coords.forEach(c => cells[c].className = 'cell'); myShipsCoords.splice(idx, 1);
        const el = document.getElementById(shipId); if (el) el.classList.remove('hidden');
        document.getElementById('readyBtn').classList.add('hidden');
    };

    document.querySelectorAll('.draggable-ship').forEach(ship => {
        ship.ondragstart = () => draggedShip = ship;
        ship.onwheel = (e) => { e.preventDefault(); isVertical = !isVertical; document.querySelectorAll('.draggable-ship').forEach(s => s.classList.toggle('vertical', isVertical)); };
    });

    function dropShip(startIdx) {
        if(!draggedShip) return;
        const size = parseInt(draggedShip.dataset.size), id = draggedShip.id;
        let coords = [];
        for(let i=0; i<size; i++) {
            let next = isVertical ? startIdx + (i*10) : startIdx + i;
            if(next > 99 || (!isVertical && Math.floor(next/10) !== Math.floor(startIdx/10))) return;
            coords.push(next);
        }
        if(myShipsCoords.some(s => s.coords.some(c => coords.includes(c)))) return;
        myShipsCoords.push({id, coords});
        draggedShip.classList.add('hidden');
        coords.forEach(c => document.getElementById('myGrid').children[c].classList.add('ship-'+id));
        if(myShipsCoords.length === 5) document.getElementById('readyBtn').classList.remove('hidden');
    }

    function generateIA() {
        const s = [5,4,3,3,2], ids = ['s5','s4','s3a','s3b','s2'], res = [];
        s.forEach((sz, i) => {
            let ok = false;
            while(!ok) {
                let st = Math.floor(Math.random()*100), v = Math.random()>0.5, c = [];
                for(let j=0; j<sz; j++) c.push(v ? st+(j*10) : st+j);
                if(c.every(n => n<100 && (v || Math.floor(n/10)===Math.floor(st/10))) && !res.some(sh=>sh.coords.some(x=>c.includes(x)))) {
                    res.push({id: ids[i], coords: c}); ok = true;
                }
            }
        });
        return res;
    }

    window.confirmPlacement = () => {
        document.getElementById('setup-area').classList.add('hidden');
        if(isAiGame) { gameState.p1Ready = true; gameState.p1Ships = myShipsCoords; gameState.p2Ready = true; updateUI(); } 
        else {
            const up = {}; up[`${myId}Ready`] = true; up[`${myId}Ships`] = myShipsCoords;
            update(ref(database, `rooms/bn_${currentRoom}`), up);
        }
    };

    window.fire = async (idx) => {
        if (!gameState.p1Ready || !gameState.p2Ready || gameState.winner) return;
        const list = gameState[myId + 'Attacks'] || [];
        if (gameState.turn !== myId || list.includes(idx)) return;
        const isHit = gameState[opponentId + 'Ships'].some(s => s.coords.includes(idx));
        const newList = [...list, idx];
        if (isAiGame) {
            gameState.p1Attacks = newList;
            if (!isHit) { gameState.turn = 'p2'; setTimeout(iaPlay, 800); }
            checkSunk(); updateUI();
        } else {
            const up = {}; up[`${myId}Attacks`] = newList;
            if (!isHit) up[`turn`] = opponentId;
            await update(ref(database, `rooms/bn_${currentRoom}`), up);
        }
    };

    function iaPlay() {
        if(gameState.winner) return;
        let shot; const aiAttacks = gameState.p2Attacks || [];
        do { shot = Math.floor(Math.random()*100); } while(aiAttacks.includes(shot));
        gameState.p2Attacks.push(shot);
        const hit = gameState.p1Ships.some(s => s.coords.includes(shot));
        checkSunk(); updateUI();
        if(hit && !gameState.winner) setTimeout(iaPlay, 800);
        else if (!gameState.winner) { gameState.turn = 'p1'; updateUI(); }
    }

    function checkSunk() {
        const check = (p, o) => {
            const oppS = gameState[o+'Ships']; if(!oppS) return;
            let sunkC = 0; const att = gameState[p+'Attacks'] || [];
            oppS.forEach(s => {
                if(s.coords.every(c => att.includes(c))) {
                    sunkC++; if(p === myId) document.getElementById('ind-'+s.id)?.classList.add('sunk');
                }
            });
            if(sunkC === 5) { gameState.winner = p; handleWin(p); }
        };
        check('p1', 'p2'); check('p2', 'p1');
    }

    function handleWin(winner) {
        showWinScreen(winner);
        if (!gameState.recorded) {
            const type = isAiGame ? 'ia' : 'online';
            const res = winner === myId ? 'win' : 'loss';
            recordResult(res, type);
            if (!isAiGame && winner === myId) update(ref(database, `rooms/bn_${currentRoom}`), { winner, recorded: true });
        }
    }

    function restoreVisuals() {
        const mCells = document.getElementById('myGrid').children;
        myShipsCoords.forEach(s => s.coords.forEach(c => mCells[c].classList.add('ship-' + s.id)));
    }
</script>
</body>

</html>
