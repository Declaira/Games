<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin - Quiz</title>
<link rel="icon" href="logo/logo.png" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Quicksand', sans-serif;
  background: linear-gradient(to bottom right, #fff3cd, #ffe5b4, #ffd1d1, #ffc4e1);
  color: #2c3e50;
  text-align: center;
}
header {
  background: linear-gradient(to right, #ff9a00, #ff4e00);
  color: white;
  padding: 25px;
  font-size: 2.5em;
  letter-spacing: 2px;
  animation: fadeInSlide 1.2s ease-out;
}
@keyframes fadeInSlide {
  0% { opacity: 0; transform: translateY(-30px); }
  100% { opacity: 1; transform: translateY(0); }
}
.container { max-width: 900px; margin: 30px auto; padding: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background-color: #ff6f00; color: white; }
button { padding: 8px 14px; margin: 4px; border-radius: 10px; cursor: pointer; font-weight: bold; background: #ff6f00; color: white; transition: transform 0.2s, background-color 0.3s; }
button:hover { transform: scale(1.05); background-color: #e65c00; }
#finalResults { display: none; margin-top: 30px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
</style>
</head>
<body>
<header>üìä Panneau Admin - Quiz</header>
<div class="container">
  <div id="quizControl">
    <p>Question actuelle : <span id="currentQ">0</span></p>
    <p>Texte : <span id="currentQuestionText">‚Äî</span></p>
    <button onclick="nextQuestion()">‚û°Ô∏è Question suivante</button>
    <button onclick="revealAnswers()">üîç R√©v√©ler les r√©ponses</button>
  </div>

  <table id="playersTable">
    <thead>
      <tr><th>Pseudo</th><th>R√©ponse</th><th>Score</th><th>Attribuer point</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>R√©sum√© des scores</h3>
  <div id="scoreSummary"></div>

  <button onclick="saveScores()">üíæ Ajouter les points coch√©s</button>
  <button onclick="resetQuiz()">üîÑ R√©initialiser le quiz</button>

  <div id="finalResults">
    <h2>üèÜ R√©sultats finaux</h2>
    <div id="finalScoreSummary"></div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwZcOoCcxpkaRPCIDLyRWo5BPaHget6-OqQ88WhqTTjwXTnoENDRiKZb1aoFwC-mMziVA/exec";
let currentQuestion=0, totalQuestions=0, interval;

async function fetchData() { const res=await fetch(SCRIPT_URL); return res.json(); }
async function fetchTotalQuestions() { const res=await fetch(SCRIPT_URL+"?getTotalQuestions=1"); const data=await res.json(); return data.totalQuestions; }

async function refresh() {
  const data = await fetchData();
  currentQuestion = data.currentQuestion;
  const questionText = data.questionText;
  const showAnswers = data.showAnswers;

  if (!totalQuestions) totalQuestions = await fetchTotalQuestions();

  if (currentQuestion > totalQuestions) {
    document.getElementById("quizControl").style.display="none";
    document.getElementById("playersTable").style.display="none";
    document.getElementById("finalResults").style.display="block";
    let summary = "";
    const allPlayers = [...new Set(data.data.map(d=>d.Pseudo))];
    allPlayers.forEach(pseudo => {
      const playerRows = data.data.filter(d=>d.Pseudo===pseudo);
      const total = playerRows.reduce((acc,r)=>acc + Number(r.Score || 0),0);
      summary += `${pseudo} : ${total} points<br>`;
    });
    document.getElementById("finalScoreSummary").innerHTML = summary;
    document.getElementById("scoreSummary").style.display="none";
    return;
  }

  document.getElementById("quizControl").style.display="block";
  document.getElementById("playersTable").style.display="table";
  document.getElementById("finalResults").style.display="none";
  document.getElementById('currentQ').textContent = currentQuestion;
  document.getElementById('currentQuestionText').textContent = questionText;

  const tbody = document.querySelector("#playersTable tbody");
  tbody.innerHTML = "";
  const players = data.data.filter(d => d.Question==currentQuestion).slice(0,8);
  players.forEach((p,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${p.Pseudo}</td><td>${p.Reponse}</td><td>${p.Score}</td><td><input type="checkbox" data-pseudo="${p.Pseudo}" ${p.Etat==='ok'?'checked disabled':''}></td>`;
    tbody.appendChild(tr);
  });

  let summary = "";
  const allPlayers = [...new Set(data.data.map(d=>d.Pseudo))];
  allPlayers.forEach(pseudo => {
    const playerRows = data.data.filter(d=>d.Pseudo===pseudo);
    const total = playerRows.reduce((acc,r)=>acc + Number(r.Score || 0),0);
    summary += `${pseudo} : ${total} points<br>`;
  });
  document.getElementById("scoreSummary").innerHTML = summary;
}

async function nextQuestion(){ await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({type:"updateControl",currentQuestion:currentQuestion+1,showAnswers:"non"})}); refresh(); }
async function revealAnswers(){ await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({type:"updateControl",currentQuestion,currentQuestion,showAnswers:"oui"})}); refresh(); }
async function saveScores(){ const checkboxes=document.querySelectorAll("input[type=checkbox]"); for(const chk of checkboxes){ if(chk.checked && !chk.disabled){ const pseudo=chk.dataset.pseudo; await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({type:"addScore",pseudo,question:currentQuestion,points:1})}); chk.disabled=true; } } refresh(); }
async function resetQuiz(){ if(!confirm("R√©initialiser le quiz ?")) return; await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({type:"resetQuiz"})}); totalQuestions=0; refresh(); }

interval=setInterval(refresh,3000); refresh();
</script>
</body>
</html>
