<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz en Direct - Joueur</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 100%; max-width: 600px; margin-top: 30px; }
        h1, h2 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: #fdfdfd; }
        #pseudo-section { text-align: center; }
        #pseudo-section label { font-size: 1.1em; display: block; margin-bottom: 10px; color: #555; }
        #pseudo-input { width: calc(100% - 22px); padding: 12px; border: 2px solid #ccc; border-radius: 8px; font-size: 1em; margin-bottom: 15px; }
        #join-button { background-color: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; transition: background-color 0.3s ease; }
        #join-button:hover { background-color: #218838; }
        #quiz-section { display: none; }
        #quiz-question-text { font-size: 1.6em; font-weight: bold; margin-bottom: 20px; text-align: center; color: #34495e; }
        #quiz-options { list-style: none; padding: 0; margin-bottom: 20px; }
        #quiz-options li { background-color: #ecf0f1; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; }
        #quiz-options li.selected { background-color: #3498db; color: white; }
        #quiz-options li.correct { background-color: #2ecc71; color: white; }
        #quiz-options li.incorrect { background-color: #e74c3c; color: white; }
        #quiz-options li.disabled { pointer-events: none; opacity: 0.7; }
        #text-answer-input { width: calc(100% - 22px); padding: 12px; border: 2px solid #ccc; border-radius: 8px; font-size: 1em; margin-bottom: 15px; }
        #submit-answer-button { background-color: #007bff; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; width: 100%; }
        #feedback-message { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-size: 1.1em; }
        #feedback-message.correct { background-color: #d4edda; color: #155724; }
        #feedback-message.incorrect { background-color: #f8d7da; color: #721c24; }
        #feedback-message.info { background-color: #d1ecf1; color: #0c5460; }
        .hidden { display: none !important; }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .leaderboard-table th, .leaderboard-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .my-score { background-color: #d9edf7; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Quiz en Direct !</h1>

        <div id="pseudo-section" class="section">
            <label for="pseudo-input">Entrez votre pseudo :</label>
            <input type="text" id="pseudo-input" placeholder="Ex: Joueur Cool">
            <button id="join-button">Rejoindre le Quiz</button>
        </div>

        <div id="quiz-section" class="section hidden">
            <h2 id="current-quiz-status">En attente...</h2>
            <p id="quiz-question-text"></p>
            <ul id="quiz-options"></ul>
            <input type="text" id="text-answer-input" class="hidden" placeholder="Votre réponse ici...">
            <button id="submit-answer-button" disabled>Envoyer ma réponse</button>
            <div id="feedback-message" class="hidden"></div>
            <p id="player-score">Score : <span id="current-player-score-display">0</span></p>
        </div>

        <div id="leaderboard-section" class="section hidden">
            <h2>Classement Final</h2>
            <div id="leaderboard"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, push, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB29fMpTwBgsqkjijkNoQJ2kGChSeQDX_w",
            authDomain: "quiz-ea203.firebaseapp.com",
            databaseURL: "https://quiz-ea203-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "quiz-ea203",
            storageBucket: "quiz-ea203.firebasestorage.app",
            messagingSenderId: "605137421110",
            appId: "1:605137421110:web:289e0876fe06108deaa997"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let userId = localStorage.getItem('quizUserId');
        let userPseudo = localStorage.getItem('quizUserPseudo');
        let allQuestions = {};
        let currentQuizState = { currentQ: 0 };
        let currentQuestionKey = null;

        const pseudoSection = document.getElementById('pseudo-section');
        const quizSection = document.getElementById('quiz-section');
        const feedbackMessageElem = document.getElementById('feedback-message');
        const submitAnswerButton = document.getElementById('submit-answer-button');
        const textAnswerInput = document.getElementById('text-answer-input');
        const quizOptionsElem = document.getElementById('quiz-options');

        // --- Identité ---
        async function joinQuiz() {
            const pseudo = document.getElementById('pseudo-input').value.trim();
            if (!pseudo) return alert("Pseudo requis");
            
            userPseudo = pseudo;
            localStorage.setItem('quizUserPseudo', userPseudo);
            if (!userId) {
                userId = push(ref(database, 'responses')).key;
                localStorage.setItem('quizUserId', userId);
            }
            await update(ref(database, `responses/${userId}`), { name: userPseudo });
            location.reload(); 
        }

        // --- Rendu Question ---
        function renderQuestion() {
            feedbackMessageElem.classList.add('hidden');
            const { currentQ, showAnswers } = currentQuizState;
            
            if (currentQ <= 0) {
                document.getElementById('quiz-question-text').textContent = "Le quiz va bientôt commencer...";
                submitAnswerButton.classList.add('hidden');
                return;
            }

            currentQuestionKey = Object.keys(allQuestions)[currentQ - 1];
            const qData = allQuestions[currentQuestionKey];
            if (!qData) return;

            document.getElementById('quiz-question-text').textContent = qData.text;
            submitAnswerButton.classList.remove('hidden');

            onValue(ref(database, `responses/${userId}/${currentQuestionKey}`), (snap) => {
                const playerResp = snap.val();
                
                if (qData.type === "multipleChoice") {
                    textAnswerInput.classList.add('hidden');
                    quizOptionsElem.classList.remove('hidden');
                    quizOptionsElem.innerHTML = '';
                    for (const key in qData.options) {
                        const li = document.createElement('li');
                        li.textContent = `${key.toUpperCase()}: ${qData.options[key]}`;
                        if (playerResp?.answer === key) li.classList.add('selected');
                        if (showAnswers) {
                            li.classList.add('disabled');
                            if (key === qData.correctAnswer) li.classList.add('correct');
                            else if (playerResp?.answer === key) li.classList.add('incorrect');
                        } else if (!playerResp) {
                            li.onclick = () => {
                                Array.from(quizOptionsElem.children).forEach(el => el.classList.remove('selected'));
                                li.classList.add('selected');
                                li.dataset.choice = key;
                                submitAnswerButton.disabled = false;
                            };
                        }
                        quizOptionsElem.appendChild(li);
                    }
                } else {
                    quizOptionsElem.classList.add('hidden');
                    textAnswerInput.classList.remove('hidden');
                    textAnswerInput.value = playerResp?.answer || "";
                    textAnswerInput.disabled = !!playerResp || showAnswers;
                    submitAnswerButton.disabled = !!playerResp || showAnswers;
                }

                if (playerResp) {
                    submitAnswerButton.disabled = true;
                    submitAnswerButton.textContent = "Réponse envoyée";
                    if (showAnswers) {
                        const pts = playerResp.scorePoints || 0;
                        feedbackMessageElem.className = pts > 0 ? "correct" : "incorrect";
                        feedbackMessageElem.textContent = pts > 0 ? "Correct ! +"+pts+"pt" : "Incorrect. La réponse était : " + (qData.correctAnswerText || qData.correctAnswer);
                        feedbackMessageElem.classList.remove('hidden');
                    }
                } else {
                    submitAnswerButton.textContent = "Envoyer ma réponse";
                }
            });
        }

        // --- Envoi Réponse ---
        submitAnswerButton.onclick = async () => {
            let answer = "";
            const qData = allQuestions[currentQuestionKey];
            if (qData.type === "multipleChoice") {
                const sel = quizOptionsElem.querySelector('.selected');
                if (!sel) return alert("Choisissez une option");
                answer = sel.dataset.choice;
            } else {
                answer = textAnswerInput.value.trim();
                if (!answer) return alert("Réponse vide");
            }

            await set(ref(database, `responses/${userId}/${currentQuestionKey}`), {
                answer: answer,
                timestamp: serverTimestamp()
            });
        };

        // --- Initialisation ---
        if (userPseudo && userId) {
            pseudoSection.classList.add('hidden');
            quizSection.classList.remove('hidden');

            onValue(ref(database, 'control'), (snap) => {
                currentQuizState = snap.val() || { currentQ: 0 };
                if (currentQuizState.currentQ === -1) {
                    quizSection.classList.add('hidden');
                    document.getElementById('leaderboard-section').classList.remove('hidden');
                } else {
                    renderQuestion();
                }
            });

            onValue(ref(database, 'questions'), (snap) => {
                allQuestions = snap.val() || {};
                renderQuestion();
            });

            onValue(ref(database, `scores/${userId}/totalScore`), (snap) => {
                document.getElementById('current-player-score-display').textContent = snap.val() || 0;
            });
        }

        document.getElementById('join-button').onclick = joinQuiz;
    </script>
</body>
</html>