<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Compte - D√©claira</title>
    <link rel="icon" href="logo/logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background: linear-gradient(135deg,#fff3cd,#ffe5b4,#ffd1d1,#ffc4e1); margin: 0; min-height: 100vh; }
        .main-container { max-width: 800px; margin: 40px auto; padding: 20px; }
        
        /* Onglets */
        .tabs-nav { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn { padding: 12px 20px; border: none; background: white; border-radius: 12px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-btn.active { background: #ff9a00; color: white; transform: translateY(-2px); }

        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; min-height: 400px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Profil */
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #ff9a00; object-fit: cover; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        .btn-save { background: #ff9a00; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-logout { background: #333; color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-danger { background: #ffeded; color: #e74c3c; border: none; padding: 10px; margin-top: 30px; cursor: pointer; border-radius: 8px; font-size: 0.9em; width: 100%; }

        /* Stats */
        .stats-section { margin-bottom: 30px; text-align: left; }
        .stats-section h4 { 
            border-bottom: 2px solid #ff9a00; 
            padding-bottom: 5px; 
            color: #333; 
            margin-bottom: 15px;
        }
        .stat-card {
            background: #fff;
            border: 1px solid #eee;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .stat-card h5 { margin: 0 0 8px 0; color: #ff4e00; font-size: 1.1em; text-transform: uppercase; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 4px; border-bottom: 1px dashed #f0f0f0; }
        .stat-row:last-child { border-bottom: none; }

        /* Personnalisation */
        .perso-item { margin-bottom: 25px; text-align: left; background: #fffaf0; padding: 15px; border-radius: 15px; }
        .bg-preview { width: 100%; height: 120px; background-size: cover; background-position: center; border-radius: 10px; margin-top: 10px; border: 2px dashed #ff9a00; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <script src="header.js"></script>
    <script>injectHeader({ title: "Param√®tres", customBackground: "linear-gradient(to right, #ff9a00, #ff4e00)" });</script>

    <div class="main-container">
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('account')">üë§ Compte</button>
            <button class="tab-btn" onclick="switchTab('stats')">üìä Stats</button>
            <button class="tab-btn" onclick="switchTab('perso')">üé® Personnalisation</button>
        </div>

        <div class="card">
            <div id="tab-account" class="tab-content active">
            
            <div id="view-mode">
                <div id="display-avatar-container" class="profile-pic" style="display: flex; align-items: center; justify-content: center; font-size: 50px; overflow: hidden; margin: 0 auto 15px auto;">
                    <span id="display-avatar-fallback">üë§</span>
                </div>
                <h2 id="display-pseudo">Chargement...</h2>
                
                <button class="btn-save" onclick="toggleEdit(true)">‚úèÔ∏è Modifier mon profil</button>
                <button class="btn-logout" id="btn-logout-main">D√©connexion</button>
                <button class="btn-danger" id="btn-delete">Supprimer mon compte</button>
            </div>

            <div id="edit-mode" class="hidden">
                <div style="position: relative; display: inline-block;">
                    <div id="edit-pic-preview-container" class="profile-pic" style="display: flex; align-items: center; justify-content: center; font-size: 50px; overflow: hidden; margin-bottom: 15px;">
                        <span id="edit-avatar-fallback">üë§</span>
                    </div>
                    <label for="change-pic" style="position:absolute; bottom:15px; right:5px; background:#333; color:white; border-radius:50%; width:35px; height:35px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:3px solid white;">üì∑</label>
                    <input type="file" id="change-pic" accept="image/*" style="display:none;">
                </div>
                <p>Nouveau pseudo :</p>
                <input type="text" id="new-pseudo">
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-save" id="btn-update">Enregistrer</button>
                    <button class="btn-logout" onclick="toggleEdit(false)" style="background:#ccc;">Annuler</button>
                </div>
            </div>
        </div>
            <div id="tab-stats" class="tab-content">
    <h3 style="color: #ff9a00;">Tableau des Performances</h3>
    
    <div class="stats-container">
        <div class="stats-section">
            <h4>üéÆ Jeux</h4>
            <div class="stats-grid" id="stats-game"></div>
        </div>

        <div class="stats-section">
            <h4>üó∫Ô∏è G√©ographie</h4>
            <div class="stats-grid" id="stats-geo"></div>
        </div>

        <div class="stats-section">
            <h4>üß© D√©fis Quotidiens</h4>
            <div class="stats-grid" id="stats-dle"></div>
        </div>
    </div>
</div>

            <div id="tab-perso" class="tab-content">
                <h3>Fonds d'√©cran personnalis√©s</h3>
                <div id="perso-display">
                    <div class="perso-item">
                        <strong>OnepieceDle</strong>
                        <div id="bg-onepiece" class="bg-preview"></div>
                    </div>
                    <div class="perso-item">
                        <strong>PokemonDle</strong>
                        <div id="bg-pokemon" class="bg-preview"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, deleteUser, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB29fMpTwBgsqkjijkNoQJ2kGChSeQDX_w",
            authDomain: "quiz-ea203.firebaseapp.com",
            databaseURL: "https://quiz-ea203-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "quiz-ea203",
            storageBucket: "quiz-ea203.firebasestorage.app",
            messagingSenderId: "605137421110",
            appId: "1:605137421110:web:289e0876fe06108deaa997"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userUID = null;
        let base64Image = null;

        // --- NAVIGATION ONGLETS ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        };

        onAuthStateChanged(auth, async (user) => {
    const savedUid = localStorage.getItem('active_uid');
    if (!savedUid) {
        window.location.href = 'login.html';
        return;
    }

    userUID = savedUid; 

    try {
        const snapshot = await get(ref(db, `users/${userUID}`));
        if (snapshot.exists()) {
            const data = snapshot.val();
            
            // Affichage Pseudo
            document.getElementById('display-pseudo').textContent = data.username || "Sans nom";
            document.getElementById('new-pseudo').value = data.username || "";
            
            // Affichage Avatar
            const displayCont = document.getElementById('display-avatar-container');
            const editCont = document.getElementById('edit-pic-preview-container');
            
            if (data.avatar && data.avatar.startsWith('data:image')) {
                const imgHtml = `<img src="${data.avatar}" class="profile-pic" style="margin:0">`;
                displayCont.innerHTML = imgHtml;
                editCont.innerHTML = imgHtml;
                base64Image = data.avatar;
            } else {
                const icon = data.avatar || "üë§";
                displayCont.innerHTML = `<span>${icon}</span>`;
                editCont.innerHTML = `<span>${icon}</span>`;
            }

            if (data.games) {
                loadStats(data.games);
                loadSettings(data.games);
            }
        }
    } catch (error) {
        console.error("Erreur:", error);
    }
});
        function loadProfile(data) {
            // 1. Mise √† jour du pseudo dans l'input (Mode √âdition)
            const inputPseudo = document.getElementById('new-pseudo');
            if (inputPseudo) inputPseudo.value = data.username || "";

            // 2. D√©termination de l'avatar (soit Base64, soit DiceBear par d√©faut)
            const avatarSource = (data.avatar && data.avatar.startsWith('data')) 
                ? data.avatar 
                : `https://api.dicebear.com/7.x/bottts/svg?seed=${data.username || userUID}`;
            
            base64Image = avatarSource;

            // 3. Mise √† jour s√©curis√©e des images dans le DOM
            // On met √† jour l'image de la vue ET de l'aper√ßu √©dition
            const picView = document.getElementById('current-pic');
            const picEdit = document.getElementById('edit-pic-preview');

            if (picView) picView.src = avatarSource;
            if (picEdit) picEdit.src = avatarSource;
        }

    function loadStats(games) {
        const categories = {
            game: document.getElementById('stats-game'),
            geo: document.getElementById('stats-geo'),
            dle: document.getElementById('stats-dle')
        };

        // On vide les conteneurs
        Object.values(categories).forEach(c => c.innerHTML = "");

        if (!games) {
            Object.values(categories).forEach(c => c.innerHTML = "Aucune donn√©e");
            return;
        }

        const groups = {
            sudoku: 'game', bn: 'game', p4: 'game',
            nature: 'geo', monde: 'geo', france: 'geo', 
            onepiece: 'dle', pokemon: 'dle', football: 'dle'
            
        };

        const names = {
            nature: "Carte G√©ographie", monde: "Carte du Monde", france: "Carte de France",
            onepiece: "OnePieceDLE", pokemon: "Pok√©monDLE", football: "FootballDLE",
            sudoku: "Sudoku", bn: "Bataille Navale", p4: "Puissance 4"
        };

        // Fonction pour formater le temps (secondes -> MM:SS)
        const formatTime = (s) => {
            if (s === Infinity || !s) return "--:--";
            const min = Math.floor(s / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return `${min}:${sec}`;
        };

        Object.keys(groups).forEach(gameKey => {
            const gameData = games[gameKey];
            if (!gameData || !gameData.stats) return;

            const categoryKey = groups[gameKey];
            const stats = gameData.stats;

            if (gameKey === 'sudoku') {
                // --- TRAITEMENT SP√âCIAL SUDOKU (PAR DIFFICULT√â) ---
                let sudokuHtml = `<div class="stat-card"><h5>${names[gameKey]}</h5>`;
                
                Object.entries(stats).forEach(([diff, data]) => {
                    sudokuHtml += `
                        <div style="margin-top:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                            <strong style="color:#ff6f00; text-transform: capitalize;">‚Ä¢ ${diff}</strong>
                            <div class="stat-row"><span>Parties</span> <strong>${data.gamesWon}</strong></div>
                            <div class="stat-row"><span>Record</span> <strong>${formatTime(data.bestTime)}</strong></div>
                            <div class="stat-row"><span>Moyenne</span> <strong>${formatTime(data.averageTime)}</strong></div>
                        </div>`;
                });
                
                sudokuHtml += `</div>`;
                categories[categoryKey].innerHTML += sudokuHtml;

            } else {
                // --- TRAITEMENT G√âN√âRIQUE (QUIZ & AUTRES) ---
                let cardHtml = `<div class="stat-card"><h5>${names[gameKey]}</h5>`;

                Object.entries(stats).forEach(([label, value]) => {
                    // Si la valeur est un temps (pour d'autres puzzles futurs)
                    const isTime = label.toLowerCase().includes('time') || label.toLowerCase().includes('record');
                    const displayValue = isTime ? formatTime(value) : value;
                    
                    const displayLabel = label.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    cardHtml += `
                        <div class="stat-row">
                            <span>${displayLabel}</span>
                            <strong>${displayValue}</strong>
                        </div>`;
                });

                cardHtml += `</div>`;
                categories[categoryKey].innerHTML += cardHtml;
            }
        });

    // V√©rification vide
    Object.keys(categories).forEach(k => {
        if (categories[k].innerHTML === "") categories[k].innerHTML = "<em>Pas encore de parties jou√©es.</em>";
    });
}

        function loadSettings(games) {
            if (!games) return;
            // Onepiece
            if (games.onepiece?.settings?.bg) {
                document.getElementById('bg-onepiece').style.backgroundImage = `url(${games.onepiece.settings.bg})`;
            }
            // Pokemon
            if (games.pokemon?.settings?.bg) {
                document.getElementById('bg-pokemon').style.backgroundImage = `url(${games.pokemon.settings.bg})`;
            }
        }

        // Logic Update, Image & Delete (Inchang√©e mais connect√©e)
        document.getElementById('change-pic').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 128; canvas.height = 128;
                    canvas.getContext('2d').drawImage(img, 0, 0, 128, 128);
                    base64Image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('current-pic').src = base64Image;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('btn-update').onclick = async () => {
            const newName = document.getElementById('new-pseudo').value.trim();
            await update(ref(db, `users/${userUID}`), { username: newName, avatar: base64Image });
            alert("Profil mis √† jour !");
            location.reload();
        };

        document.getElementById('btn-logout-main').onclick = () => {
            signOut(auth).then(() => {
                localStorage.removeItem('active_uid');
                window.location.href = 'login.html';
            });
        };

        document.getElementById('btn-delete').onclick = async () => {
            if(confirm("‚ö†Ô∏è Es-tu certain ? Cela supprimera toutes tes donn√©es et tes scores.")) {
                await remove(ref(db, `users/${userUID}`));
                const saved = JSON.parse(localStorage.getItem('declaira_accounts') || "[]");
                localStorage.setItem('declaira_accounts', JSON.stringify(saved.filter(a => a.uid !== userUID)));
                deleteUser(auth.currentUser).then(() => { window.location.href = 'login.html'; });
            }
        };

const headerNameEl = document.getElementById('header-username');
const headerAvatarEl = document.getElementById('header-avatar');

// --- FONCTION DE SYNCHRONISATION ---
function syncWithHeader() {
    if (!headerNameEl || !headerAvatarEl) return;

    const currentName = headerNameEl.textContent;
    if (currentName !== "Chargement..." && currentName !== "Invit√©") {
        document.getElementById('display-pseudo').textContent = currentName;
        document.getElementById('new-pseudo').value = currentName;
    }

    // R√©cup√©ration de l'avatar selon la logique du header
    const imgInHeader = headerAvatarEl.querySelector('img');
    const displayCont = document.getElementById('display-avatar-container');
    const editCont = document.getElementById('edit-pic-preview-container');

    if (imgInHeader) {
        // C'est une image (Base64 ou URL)
        const imgSrc = imgInHeader.src;
        displayCont.innerHTML = `<img src="${imgSrc}" class="profile-pic" style="margin:0">`;
        editCont.innerHTML = `<img src="${imgSrc}" class="profile-pic" style="margin:0">`;
        base64Image = imgSrc;
    } else {
        // C'est un texte ou emoji
        const avatarTxt = headerAvatarEl.textContent;
        displayCont.innerHTML = `<span>${avatarTxt}</span>`;
        editCont.innerHTML = `<span>${avatarTxt}</span>`;
    }
}

// Utilisation d'un MutationObserver pour surveiller le header
const headerObserver = new MutationObserver(() => syncWithHeader());
if (headerNameEl) headerObserver.observe(headerNameEl, { childList: true });
if (headerAvatarEl) headerObserver.observe(headerAvatarEl, { childList: true });

// Basculer entre Vue et √âdition
window.toggleEdit = (isEditing) => {
    document.getElementById('view-mode').classList.toggle('hidden', isEditing);
    document.getElementById('edit-mode').classList.toggle('hidden', !isEditing);
};

// --- LOGIQUE DE MISE √Ä JOUR ---
document.getElementById('btn-update').onclick = async () => {
    const newName = document.getElementById('new-pseudo').value.trim();
    if(!newName) return;

    try {
        await update(ref(db, `users/${userUID}`), { 
            username: newName, 
            avatar: base64Image 
        });
        alert("Profil mis √† jour !");
        location.reload(); // Recharge pour rafra√Æchir le header et la page
    } catch (e) {
        console.error("Erreur mise √† jour:", e);
    }
};
</script>
</body>
</html>