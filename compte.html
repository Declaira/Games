<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Compte - D√©claira</title>
    <link rel="icon" href="logo/logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background: linear-gradient(135deg,#fff3cd,#ffe5b4,#ffd1d1,#ffc4e1); margin: 0; min-height: 100vh; }
        .main-container { max-width: 800px; margin: 40px auto; padding: 20px; }
        
        /* Onglets */
        .tabs-nav { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn { padding: 12px 20px; border: none; background: white; border-radius: 12px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-btn.active { background: #ff9a00; color: white; transform: translateY(-2px); }

        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; min-height: 400px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Profil */
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #ff9a00; object-fit: cover; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        .btn-save { background: #ff9a00; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-logout { background: #333; color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-danger { background: #ffeded; color: #e74c3c; border: none; padding: 10px; margin-top: 30px; cursor: pointer; border-radius: 8px; font-size: 0.9em; width: 100%; }

        /* Stats */
        .stats-section { margin-bottom: 30px; text-align: left; }
        .stats-section h4 { 
            border-bottom: 2px solid #ff9a00; 
            padding-bottom: 5px; 
            color: #333; 
            margin-bottom: 15px;
        }
        .stat-card {
            background: #fff;
            border: 1px solid #eee;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .stat-card h5 { margin: 0 0 8px 0; color: #ff4e00; font-size: 1.1em; text-transform: uppercase; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 4px; border-bottom: 1px dashed #f0f0f0; }
        .stat-row:last-child { border-bottom: none; }

        /* Personnalisation */
        .perso-item { margin-bottom: 25px; text-align: left; background: #fffaf0; padding: 15px; border-radius: 15px; }
        .theme-preset, .custom-bubble div {
            border: 2px solid white !important;
            transition: all 0.3s ease;
        }

        /* Effet au survol (Hover) */
        .theme-preset:hover, .custom-bubble div:hover {
            border-color: #ff9a00 !important;
            transform: scale(1.05);
        }

        /* Style quand s√©lectionn√© (Appliqu√© par le JS) */
        .theme-preset.selected, .custom-bubble div.selected {
            border-color: #ff9a00 !important;
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 154, 0, 0.4);
            z-index: 5;
        }
        .bg-preview { width: 100%; height: 120px; background-size: cover; background-position: center; border-radius: 10px; margin-top: 10px; border: 2px dashed #ff9a00; }
        .hidden { display: none !important; }
        .bg-selection-grid {
        display: flex; 
        gap: 12px; 
        align-items: center;
        padding: 5px 10px;
        margin: -5px 0;    
        overflow-x: auto; 
        scrollbar-width: none;
        }
        .mini-bg {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
        }
        .mini-bg:hover { transform: scale(1.1); border-color: #ff9a00; }
        .mini-bg.selected { border-color: #ff9a00; box-shadow: 0 0 5px rgba(255,154,0,0.5); }
        .tab-btn{
            height: 35px; 
            padding: 0 12px; 
            font-size: 0.75em; 
            white-space: nowrap; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <script src="header.js"></script>
    <script>injectHeader({ title: "Param√®tres", customBackground: "linear-gradient(to right, #ff9a00, #ff4e00)" });</script>

    <div class="main-container">
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('account')">üë§ Compte</button>
            <button class="tab-btn" onclick="switchTab('stats')">üìä Stats</button>
            <button class="tab-btn" onclick="switchTab('perso')">üé® Personnalisation</button>
        </div>

        <div class="card">
            <div id="tab-account" class="tab-content active">
            
            <div id="view-mode">
                <div id="display-avatar-container" class="profile-pic" style="display: flex; align-items: center; justify-content: center; font-size: 50px; overflow: hidden; margin: 0 auto 15px auto;">
                    <span id="display-avatar-fallback">üë§</span>
                </div>
                <h2 id="display-pseudo">Chargement...</h2>
                
                <button class="btn-save" onclick="toggleEdit(true)">‚úèÔ∏è Modifier mon profil</button>
                <button class="btn-logout" id="btn-logout-main">D√©connexion</button>
                <button class="btn-danger" id="btn-delete">Supprimer mon compte</button>
            </div>

            <div id="edit-mode" class="hidden">
                <div style="position: relative; display: inline-block;">
                    <div id="edit-pic-preview-container" class="profile-pic" style="display: flex; align-items: center; justify-content: center; font-size: 50px; overflow: hidden; margin-bottom: 15px;">
                        <span id="edit-avatar-fallback">üë§</span>
                    </div>
                    <label for="change-pic" style="position:absolute; bottom:15px; right:5px; background:#333; color:white; border-radius:50%; width:35px; height:35px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:3px solid white;">üì∑</label>
                    <input type="file" id="change-pic" accept="image/*" style="display:none;">
                </div>
                <p>Nouveau pseudo :</p>
                <input type="text" id="new-pseudo">
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-save" id="btn-update">Enregistrer</button>
                    <button class="btn-logout" onclick="toggleEdit(false)" style="background:#ccc;">Annuler</button>
                </div>
            </div>
        </div>
            <div id="tab-stats" class="tab-content">
    <h3 style="color: #ff9a00;">Tableau des Performances</h3>
    
    <div class="stats-container">
        <div class="stats-section">
            <h4>üéÆ Jeux</h4>
            <div class="stats-grid" id="stats-game"></div>
        </div>

        <div class="stats-section">
            <h4>üó∫Ô∏è G√©ographie</h4>
            <div class="stats-grid" id="stats-geo"></div>
        </div>

        <div class="stats-section">
            <h4>üß© D√©fis Quotidiens</h4>
            <div class="stats-grid" id="stats-dle"></div>
        </div>
    </div>
</div>
<div id="tab-perso" class="tab-content">
    <h3>Fonds d'√©cran personnalis√©s</h3>

    <div class="perso-item">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <strong>üé® Mes Th√®mes</strong>
        <button id="toggle-manual" onclick="toggleManualSettings()" style="background: #ff9a00; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 1.2em; display: flex; align-items: center; justify-content: center;">+</button>
    </div>

    <div id="themes-container" style="display: flex; gap: 12px; margin: 15px 0; flex-wrap: wrap; align-items: center;">
        <div class="theme-preset" 
            data-bg="linear-gradient(135deg,#fff3cd,#ffe5b4,#ffd1d1,#ffc4e1)"
            onclick="setFullTheme('linear-gradient(to right, #ff9a00, #ff4e00)', 'linear-gradient(135deg,#fff3cd,#ffe5b4,#ffd1d1,#ffc4e1)', '#ff6f00')" 
            style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg,#fff3cd,#ffc4e1); cursor: pointer; border: 2px solid white;"></div>

        <div class="theme-preset" 
            data-bg="linear-gradient(135deg, #1d2b64, #f8cdda)"
            onclick="setFullTheme('#1d2b64', 'linear-gradient(135deg, #1d2b64, #f8cdda)', '#1d2b64')" 
            style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #1d2b64, #f8cdda); cursor: pointer; border: 2px solid white;"></div>
        <div id="custom-presets-list" style="display: flex; gap: 12px;"></div>
    </div>

    <div id="manual-settings" class="hidden" style="border-top: 1px solid #eee; margin-top: 15px; padding-top: 15px;">
        <div style="display: flex; gap: 15px; align-items: center; justify-content: space-around;">
            <div style="text-align: center;">
                <span style="font-size: 0.7em; display: block;">Header</span>
                <input type="color" id="color-header" value="#ff9a00" style="width: 35px; height: 35px; cursor: pointer; border: none; background: none;">
            </div>
            <div style="text-align: center;">
                <span style="font-size: 0.7em; display: block;">Fond H.</span>
                <input type="color" id="color-body-1" value="#ffffff" style="width: 35px; height: 35px; cursor: pointer; border: none; background: none;">
            </div>
            <div style="text-align: center;">
                <span style="font-size: 0.7em; display: block;">Fond B.</span>
                <input type="color" id="color-body-2" value="#000000" style="width: 35px; height: 35px; cursor: pointer; border: none; background: none;">
            </div>
            <div style="text-align: center;">
                <span style="font-size: 0.7em; display: block;">Boutons</span>
                <input type="color" id="color-btn" value="#ff6f00" style="width: 35px; height: 35px; cursor: pointer; border: none; background: none;">
            </div>
            <button onclick="saveNewPreset()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; cursor: pointer;">üíæ Enregistrer</button>
        </div>
    </div>
</div>
    
    <div class="perso-item">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 10px;">
            <strong style="min-width: fit-content;">Pok√©monDLE</strong>
            
            <div class="bg-selection-grid">
                <img src="Defis_quotidiens/images_pokemon/bg1.png" class="mini-bg" data-game="pokemon" data-path="Defis_quotidiens/images_pokemon/bg1.png">
                <img src="Defis_quotidiens/images_pokemon/bg2.png" class="mini-bg" data-game="pokemon" data-path="Defis_quotidiens/images_pokemon/bg2.png">
                <img src="Defis_quotidiens/images_pokemon/bg3.png" class="mini-bg" data-game="pokemon" data-path="Defis_quotidiens/images_pokemon/bg3.png">
                
                <label class="mini-bg upload-label" style="display: flex; align-items: center; justify-content: center; background: #eee; border: 2px dashed #ccc; cursor: pointer; min-width: 50px; height: 35px; font-size: 16px; border-radius: 6px;">
                    üìÇ <input type="file" class="bg-upload-input" data-game="pokemon" hidden accept="image/*">
                </label>
            </div>

            <button class="tab-btn" onclick="openFullscreen('pokemon')">‚õ∂ Plein √©cran</button>
        </div>
        
        <div id="bg-pokemon" class="bg-preview" style="height: 80px; background-color: #f9f9f9;"></div>
    </div>

    <div class="perso-item">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 10px;">
            <strong style="min-width: fit-content;">OnepieceDLE</strong>
            
            <div class="bg-selection-grid">
                <img src="Defis_quotidiens/images_onepiece/bg2.png" class="mini-bg" data-game="onepiece" data-path="Defis_quotidiens/images_onepiece/bg2.png">
                <img src="Defis_quotidiens/images_onepiece/bg.png" class="mini-bg" data-game="onepiece" data-path="Defis_quotidiens/images_onepiece/bg.png">
                <img src="Defis_quotidiens/images_onepiece/bg1.png" class="mini-bg" data-game="onepiece" data-path="Defis_quotidiens/images_onepiece/bg1.png">
                
                <label class="mini-bg upload-label" style="display: flex; align-items: center; justify-content: center; background: #eee; border: 2px dashed #ccc; cursor: pointer; min-width: 50px; height: 35px; font-size: 16px; border-radius: 6px;">
                    üìÇ <input type="file" class="bg-upload-input" data-game="onepiece" hidden accept="image/*">
                </label>
            </div>

            <button class="tab-btn" onclick="openFullscreen('onepiece')">‚õ∂ Plein √©cran</button>
        </div>
        
        <div id="bg-onepiece" class="bg-preview" style="height: 80px; background-color: #f9f9f9;"></div>
    </div>


</div>

<div id="fullscreenModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); align-items:center; justify-content:center; cursor:pointer;" onclick="this.style.display='none'">
    <img id="fullscreenImg" src="" style="max-width:90%; max-height:90%; border-radius:10px; box-shadow: 0 0 20px rgba(255,255,255,0.2);">
    <span style="position:absolute; top:20px; right:30px; color:white; font-size:40px;">&times;</span>
</div>
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, deleteUser, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        import { push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB29fMpTwBgsqkjijkNoQJ2kGChSeQDX_w",
            authDomain: "quiz-ea203.firebaseapp.com",
            databaseURL: "https://quiz-ea203-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "quiz-ea203",
            storageBucket: "quiz-ea203.firebasestorage.app",
            messagingSenderId: "605137421110",
            appId: "1:605137421110:web:289e0876fe06108deaa997"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userUID = null;
        let base64Image = null;

        // --- NAVIGATION ONGLETS ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            
            // Correction ici : on cible le bouton cliqu√© via l'√©v√©nement ou le s√©lecteur
            const clickedBtn = document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`);
            if(clickedBtn) clickedBtn.classList.add('active');

            // Sauvegarde dans le navigateur
            localStorage.setItem('active_tab', tabId);
        };
        // --- R√âCUP√âRATION DE L'ONGLET AU CHARGEMENT ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTab = localStorage.getItem('active_tab');
            if (savedTab) {
                // On simule un clic sur l'onglet sauvegard√©
                switchTab(savedTab);
            }
        });

        onAuthStateChanged(auth, async (user) => {
    // FORCE la m√™me logique que le header : Priorit√© au profil choisi
    const savedUid = localStorage.getItem('active_uid');
    
    // Si on a un profil choisi, on ignore l'UID technique de Firebase
    const uidToFetch = savedUid || (user ? user.uid : null);

    if (uidToFetch) {
        console.log("üÜî ID Actuel (Page Compte) :", uidToFetch);
        userUID = uidToFetch; 
        loadCustomPresets();

        try {
            const snapshot = await get(ref(db, `users/${uidToFetch}`));
            if (snapshot.exists()) {
                const data = snapshot.val();
                if (data.theme) {
                    applyTheme(data.theme);
                }
                loadProfile(data); // Affiche pseudo et avatar
                if (data.games) {
                    loadStats(data.games);
                    loadSettings(data.games);
                }
            } else {
                console.warn("‚ö†Ô∏è Ce profil n'a pas de donn√©es dans la DB.");
            }
        } catch (error) {
            console.error("‚ùå Erreur de chargement :", error);
        }
    } else {
        // Si vraiment aucun ID (ni choisi, ni session), retour au login
        window.location.href = 'login.html';
    }
    
    // Cache le loader
    const loader = document.getElementById('loading');
    if (loader) loader.style.display = 'none';
});

        function loadProfile(data) {
            // 1. Mise √† jour du pseudo dans l'input (Mode √âdition)
            const inputPseudo = document.getElementById('new-pseudo');
            if (inputPseudo) inputPseudo.value = data.username || "";

            // 2. D√©termination de l'avatar (soit Base64, soit DiceBear par d√©faut)
            const avatarSource = (data.avatar && data.avatar.startsWith('data')) 
                ? data.avatar 
                : `https://api.dicebear.com/7.x/bottts/svg?seed=${data.username || userUID}`;
            
            base64Image = avatarSource;

            // 3. Mise √† jour s√©curis√©e des images dans le DOM
            // On met √† jour l'image de la vue ET de l'aper√ßu √©dition
            const picView = document.getElementById('current-pic');
            const picEdit = document.getElementById('edit-pic-preview');

            if (picView) picView.src = avatarSource;
            if (picEdit) picEdit.src = avatarSource;
        }

function loadStats(games) {
    const categories = {
        game: document.getElementById('stats-game'),
        geo: document.getElementById('stats-geo'),
        dle: document.getElementById('stats-dle')
    };

    const translations = {
        "played": "Parties Jou√©es",
        "wins": "Victoires",
        "losses": "D√©faites",
        "draws": "Matchs Nuls",
        "averageScore": "Score Moyen",
        "avgAttempts": "Essais Moyens",
        "gamesPlayed": "Parties Jou√©es",
        "lastPlayed": "Derni√®re Partie",
        "totalAttemptsOnWin": "Essais (Victoires)",
        "bestTime": "Record",
        "averageTime": "Temps Moyen",
        "gamesWon": "Victoires"
    };

    Object.values(categories).forEach(c => c.innerHTML = "");

    if (!games) {
        Object.values(categories).forEach(c => c.innerHTML = "Aucune donn√©e");
        return;
    }

    const groups = {
        sudoku: 'game', bn: 'game', p4: 'game',
        nature: 'geo', monde: 'geo', france: 'geo', 
        onepiece: 'dle', pokemon: 'dle', football: 'dle'
    };

    const names = {
        nature: "Carte G√©ographie", monde: "Carte du Monde", france: "Carte de France",
        onepiece: "OnePieceDLE", pokemon: "Pok√©monDLE", football: "FootballDLE",
        sudoku: "Sudoku", bn: "Bataille Navale", p4: "Puissance 4"
    };

    const formatTime = (s) => {
        if (s === Infinity || !s) return "--:--";
        const min = Math.floor(s / 60).toString().padStart(2, '0');
        const sec = (s % 60).toString().padStart(2, '0');
        return `${min}:${sec}`;
    };

    Object.keys(groups).forEach(gameKey => {
        const gameData = games[gameKey];
        if (!gameData || !gameData.stats) return;

        const categoryKey = groups[gameKey];
        let cardHtml = `<div class="stat-card"><h5>${names[gameKey]}</h5>`;

        // --- LOGIQUE POUR JEUX √Ä SOUS-MODES (BN, P4, SUDOKU) ---
        const multiModeGames = ['bn', 'p4', 'sudoku'];

        if (multiModeGames.includes(gameKey)) {
            Object.entries(gameData.stats).forEach(([mode, data]) => {
                // Nettoyage du nom du mode (ex: ia_easy -> IA Easy)
                const modeName = mode.replace('_', ' ').toUpperCase();
                
                cardHtml += `
                    <div style="margin-top:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                        <strong style="color:#ff6f00; font-size:0.85em;">‚Ä¢ ${modeName}</strong>`;

                // Cas Sudoku (structure diff√©rente)
                if (gameKey === 'sudoku') {
                    cardHtml += `
                        <div class="stat-row"><span>Victoires</span> <strong>${data.gamesWon || 0}</strong></div>
                        <div class="stat-row"><span>Record</span> <strong>${formatTime(data.bestTime)}</strong></div>`;
                } 
                // Cas BN et P4
                else {
                    Object.entries(data).forEach(([label, value]) => {
                        const displayLabel = translations[label] || label;
                        cardHtml += `<div class="stat-row"><span>${displayLabel}</span> <strong>${value}</strong></div>`;
                    });

                    // Calcul Winrate pour BN si les cl√©s sont pr√©sentes
                    if (gameKey === 'bn' && data.played > 0) {
                        const wr = ((data.wins / data.played) * 100).toFixed(1);
                        cardHtml += `<div class="stat-row"><span style="color:#27ae60;">Winrate</span> <strong style="color:#27ae60;">${wr}%</strong></div>`;
                    }
                }
                cardHtml += `</div>`;
            });
        } 
        // --- CAS G√âN√âRAL (G√©o & DLE) ---
        else {
            Object.entries(gameData.stats).forEach(([label, value]) => {
                const displayLabel = translations[label] || label;
                const isTime = label.toLowerCase().includes('time') || label.toLowerCase().includes('record');
                const displayValue = isTime ? formatTime(value) : (typeof value === 'number' && !Number.isInteger(value) ? value.toFixed(2) : value);
                cardHtml += `<div class="stat-row"><span>${displayLabel}</span> <strong>${displayValue}</strong></div>`;
            });
        }

        cardHtml += `</div>`;
        categories[categoryKey].innerHTML += cardHtml;
    });

    Object.keys(categories).forEach(k => {
        if (categories[k].innerHTML === "") categories[k].innerHTML = "<em>Pas encore de donn√©es.</em>";
    });
}
// --- GESTION DES COULEURS DU TH√àME ---

function loadCustomPresets() {
    if (!userUID) return;
    const presetsRef = ref(db, `users/${userUID}/themePresets`);
    
    onValue(presetsRef, (snapshot) => {
        const listCont = document.getElementById('custom-presets-list');
        listCont.innerHTML = "";
        
        if (snapshot.exists()) {
            const data = snapshot.val();
            Object.entries(data).forEach(([id, preset]) => {
                const div = document.createElement('div');
                div.style.position = "relative";
                div.innerHTML = `
                    <div class="theme-circle" 
                        data-bg="${preset.body}" 
                        onclick="setFullTheme('${preset.header}', '${preset.body}', '${preset.btn || ''}')" 
                        style="width: 40px; height: 40px; border-radius: 50%; background: ${preset.body}; border: 2px solid white; cursor: pointer;">
                    </div>
                    <button onclick="deletePreset('${id}')" style="position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
                `;
                listCont.appendChild(div);
            });
        }
        const currentBody = document.body.style.background;
        if (currentBody) {
            // Utilise directement la variable globale ou le style du body
            const bodyStyle = document.body.style.background;
            window.highlightSelectedTheme(bodyStyle);
        }
    });
}

window.saveNewPreset = async () => {
    const h = document.getElementById('color-header').value;
    const b1 = document.getElementById('color-body-1').value;
    const b2 = document.getElementById('color-body-2').value;
    const bodyGradient = `linear-gradient(135deg, ${b1}, ${b2})`;

    try {
        await push(ref(db, `users/${userUID}/themePresets`), {
            header: h,
            body: bodyGradient
        });
        toggleManualSettings(); // Referme le menu
    } catch (e) { console.error(e); }
};

// --- SUPPRIMER UN PRESET ---
window.deletePreset = async (id) => {
    if (confirm("Supprimer ce th√®me enregistr√© ?")) {
        await remove(ref(db, `users/${userUID}/themePresets/${id}`));
    }
};

// 1. Sauvegarde dans Firebase
window.updateThemeColor = async (type, value) => {
    if (!userUID) return;
    try {
        await update(ref(db, `users/${userUID}/theme`), { [type]: value });
        applyTheme({ [type]: value }); // Appliquer imm√©diatement
    } catch (e) {
        console.error("Erreur couleur:", e);
    }
};

// 2. Application des couleurs sur la page
window.applyTheme = (themeData) => {
    if (!themeData) return;

    if (themeData.headerColor) {
        const headerEl = document.getElementById('main-header');
        if (headerEl) headerEl.style.background = themeData.headerColor;
    }

    if (themeData.bodyColor) {
        document.body.style.background = themeData.bodyColor;
        document.body.style.backgroundAttachment = "fixed";
        
        // Correction ici : on ne passe que le bodyColor
        // Et on attend 200ms que les bulles personnalis√©es soient √©ventuellement inject√©es
        setTimeout(() => {
            window.highlightSelectedTheme(themeData.bodyColor);
        }, 200);
    }
};

// --- BASCULE DU MENU MANUEL ---
window.toggleManualSettings = () => {
    const section = document.getElementById('manual-settings');
    const btn = document.getElementById('toggle-manual');
    
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        btn.textContent = "‚Äî";
        btn.style.background = "#333";
    } else {
        section.classList.add('hidden');
        btn.textContent = "+";
        btn.style.background = "#ff9a00";
    }
};

// --- SUPPRIMER LE R√âGLAGE PERSO (RETOUR AUX PR√âSETS) ---
window.clearCustomTheme = async () => {
    if (!userUID || !confirm("Supprimer ton ajustement manuel et revenir au th√®me par d√©faut ?")) return;

    try {
        // On supprime les entr√©es dans Firebase
        await update(ref(db, `users/${userUID}/theme`), {
            headerColor: null,
            bodyColor: null
        });

        // On r√©applique le preset de base visuellement
        setFullTheme('linear-gradient(to right, #ff9a00, #ff4e00)', 'linear-gradient(135deg,#fff3cd,#ffe5b4,#ffd1d1,#ffc4e1)');
        
        // On referme le menu
        toggleManualSettings();
        
        alert("R√©glage manuel supprim√© !");
    } catch (e) {
        console.error("Erreur suppression r√©glage:", e);
    }
};
// Calcule et applique le d√©grad√© de fond
window.updateGradient = async () => {
    const c1 = document.getElementById('color-body-1').value;
    const c2 = document.getElementById('color-body-2').value;
    
    // On cr√©e une cha√Æne linear-gradient
    const gradientString = `linear-gradient(135deg, ${c1}, ${c2})`;
    
    if (!userUID) return;
    try {
        await update(ref(db, `users/${userUID}/theme`), { bodyColor: gradientString });
        document.body.style.background = gradientString;
        document.body.style.backgroundAttachment = "fixed"; // Optionnel: pour que le fond ne scrolle pas
    } catch (e) {
        console.error("Erreur gradient:", e);
    }
};
window.setFullTheme = async (headerVal, bodyVal) => {
    if (!userUID) return;
    document.querySelectorAll('.theme-preset, .custom-bubble div').forEach(el => {
        el.classList.remove('selected');
    });

    // Ajoute la classe √† la bulle cliqu√©e
    if (window.event && window.event.currentTarget) {
        window.event.currentTarget.classList.add('selected');
    }
    try {
        // Sauvegarde group√©e dans Firebase
        await update(ref(db, `users/${userUID}/theme`), { 
            headerColor: headerVal, 
            bodyColor: bodyVal 
        });

        // Application imm√©diate visuelle
        const headerEl = document.getElementById('main-header');
        if (headerEl) headerEl.style.background = headerVal;
        document.body.style.background = bodyVal;
        document.body.style.backgroundAttachment = "fixed";

        // Mise √† jour optionnelle des inputs de couleur pour correspondre
        if (!headerVal.includes('gradient')) document.getElementById('color-header').value = headerVal;
        
        const colors = bodyVal.match(/#[a-fA-F0-9]{6}/g);
        if (colors && colors.length >= 2) {
            document.getElementById('color-body-1').value = colors[0];
            document.getElementById('color-body-2').value = colors[colors.length - 1];
        }

    } catch (e) {
        console.error("Erreur application th√®me:", e);
    }
};
window.highlightSelectedTheme = (currentBody) => {
    if (!currentBody) return;

    // 1. Nettoyer toutes les s√©lections
    document.querySelectorAll('.theme-preset, .theme-circle').forEach(el => {
        el.classList.remove('selected');
    });

    // 2. Pr√©paration de la cible (on enl√®ve espaces, guillemets et on met en minuscule)
    const cleanTarget = currentBody.replace(/\s/g, '').replace(/["']/g, "").toLowerCase();

    document.querySelectorAll('[data-bg]').forEach(el => {
        const dataAttr = el.getAttribute('data-bg');
        if (!dataAttr) return;

        const elBg = dataAttr.replace(/\s/g, '').replace(/["']/g, "").toLowerCase();
        
        // On v√©rifie si l'un contient l'autre (car le navigateur peut ajouter des param√®tres)
        if (cleanTarget.includes(elBg) || elBg.includes(cleanTarget)) {
            el.classList.add('selected');
        }
    });
};
// Fonction Reset mise √† jour avec ton d√©grad√© sp√©cifique
window.resetTheme = async () => {
    if (!userUID || !confirm("R√©initialiser les couleurs par d√©faut ?")) return;
    
    const defaultBody = "linear-gradient(135deg,#fff3cd,#ffe5b4,#ffd1d1,#ffc4e1)";
    const defaultHeader = "linear-gradient(to right, #ff9a00, #ff4e00)";

    try {
        await update(ref(db, `users/${userUID}/theme`), {
            headerColor: null,
            bodyColor: null
        });

        // Application imm√©diate
        document.getElementById('main-header').style.background = defaultHeader;
        document.body.style.background = defaultBody;

        // Reset visuel des inputs (approximatif pour le d√©grad√© multi-couleurs)
        document.getElementById('color-header').value = "#ff9a00";
        document.getElementById('color-body-1').value = "#fff3cd";
        document.getElementById('color-body-2').value = "#ffc4e1";

        alert("Th√®me r√©initialis√© !");
    } catch (e) {
        console.error("Erreur reset:", e);
    }
};
// --- GESTION DES FONDS D'√âCRAN ---
// --- FONCTION VISUALISATION GRAND √âCRAN ---
window.openFullscreen = (game) => {
    const previewEl = document.getElementById(`bg-${game}`);
    const bgUrl = previewEl.style.backgroundImage.slice(5, -2).replace(/"/g, ""); // Extrait l'URL propre
    
    if (bgUrl && bgUrl !== "none" && bgUrl !== "") {
        document.getElementById('fullscreenImg').src = bgUrl;
        document.getElementById('fullscreenModal').style.display = 'flex';
    } else {
        alert("Aucun fond d'√©cran s√©lectionn√© !");
    }
};

// --- GESTION DES CLICS MINIATURES ---
document.querySelectorAll('.mini-bg[data-path]').forEach(img => {
    img.onclick = async function() {
        const game = this.dataset.game;
        const path = this.dataset.path;
        await updateGameBackground(game, path);
        
        // Update visuel s√©lection
        document.querySelectorAll(`.mini-bg[data-game="${game}"]`).forEach(m => m.classList.remove('selected'));
        this.classList.add('selected');
    };
});

// --- GESTION UPLOAD ---
document.querySelectorAll('.bg-upload-input').forEach(input => {
    input.onchange = (e) => {
        const game = e.target.dataset.game;
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (event) => {
                await updateGameBackground(game, event.target.result);
                document.querySelectorAll(`.mini-bg[data-game="${game}"]`).forEach(m => m.classList.remove('selected'));
            };
            reader.readAsDataURL(file);
        }
    };
});

// --- SAUVEGARDE ET MISE √Ä JOUR PREVIEW ---
async function updateGameBackground(game, value) {
    if (!userUID) return;
    try {
        await update(ref(db, `users/${userUID}/games/${game}`), { customBackground: value });
        const previewEl = document.getElementById(`bg-${game}`);
        const fullUrl = value && value.startsWith('images_') ? `Defis_quotidiens/${value}` : value;
        previewEl.style.backgroundImage = value ? `url('${fullUrl}')` : 'none';
    } catch (e) {
        console.error("Erreur save background:", e);
    }
}

// 4. Initialisation (loadSettings) adapt√©e aux dossiers
function loadSettings(games) {
    if (!games) return;
    ['pokemon', 'onepiece'].forEach(gameKey => {
        const val = games[gameKey]?.customBackground;
        if (val) {
            const previewEl = document.getElementById(`bg-${gameKey}`);
            const fullUrl = val.startsWith('images_') ? `Defis_quotidiens/${val}` : val;
            previewEl.style.backgroundImage = `url('${fullUrl}')`;
            
            // S√©lectionner la miniature correspondante si c'est une image de base
            const mini = document.querySelector(`.mini-bg[data-path="${val}"]`);
            if (mini) mini.classList.add('selected');
        }
    });
}

        document.getElementById('btn-logout-main').onclick = () => {
            signOut(auth).then(() => {
                localStorage.removeItem('active_uid');
                window.location.href = 'login.html';
            });
        };

        document.getElementById('btn-delete').onclick = async () => {
            if(confirm("‚ö†Ô∏è Es-tu certain ? Cela supprimera toutes tes donn√©es et tes scores.")) {
                await remove(ref(db, `users/${userUID}`));
                const saved = JSON.parse(localStorage.getItem('declaira_accounts') || "[]");
                localStorage.setItem('declaira_accounts', JSON.stringify(saved.filter(a => a.uid !== userUID)));
                deleteUser(auth.currentUser).then(() => { window.location.href = 'login.html'; });
            }
        };

const headerNameEl = document.getElementById('header-username');
const headerAvatarEl = document.getElementById('header-avatar');

// --- FONCTION DE SYNCHRONISATION ---
function syncWithHeader() {
    if (!headerNameEl || !headerAvatarEl) return;

    const currentName = headerNameEl.textContent;
    if (currentName !== "Chargement..." && currentName !== "Invit√©") {
        document.getElementById('display-pseudo').textContent = currentName;
        document.getElementById('new-pseudo').value = currentName;
    }

    // R√©cup√©ration de l'avatar selon la logique du header
    const imgInHeader = headerAvatarEl.querySelector('img');
    const displayCont = document.getElementById('display-avatar-container');
    const editCont = document.getElementById('edit-pic-preview-container');

    if (imgInHeader) {
        // C'est une image (Base64 ou URL)
        const imgSrc = imgInHeader.src;
        displayCont.innerHTML = `<img src="${imgSrc}" class="profile-pic" style="margin:0">`;
        editCont.innerHTML = `<img src="${imgSrc}" class="profile-pic" style="margin:0">`;
        base64Image = imgSrc;
    } else {
        // C'est un texte ou emoji
        const avatarTxt = headerAvatarEl.textContent;
        displayCont.innerHTML = `<span>${avatarTxt}</span>`;
        editCont.innerHTML = `<span>${avatarTxt}</span>`;
    }
}

// Utilisation d'un MutationObserver pour surveiller le header
const headerObserver = new MutationObserver(() => syncWithHeader());
if (headerNameEl) headerObserver.observe(headerNameEl, { childList: true });
if (headerAvatarEl) headerObserver.observe(headerAvatarEl, { childList: true });

// Basculer entre Vue et √âdition
window.toggleEdit = (isEditing) => {
    document.getElementById('view-mode').classList.toggle('hidden', isEditing);
    document.getElementById('edit-mode').classList.toggle('hidden', !isEditing);
};

// --- LOGIQUE DE MISE √Ä JOUR ---
document.getElementById('btn-update').onclick = async () => {
    const newName = document.getElementById('new-pseudo').value.trim();
    if(!newName) return;

    try {
        await update(ref(db, `users/${userUID}`), { 
            username: newName, 
            avatar: base64Image 
        });
        alert("Profil mis √† jour !");
        location.reload(); // Recharge pour rafra√Æchir le header et la page
    } catch (e) {
        console.error("Erreur mise √† jour:", e);
    }
};
</script>
</body>

</html>
